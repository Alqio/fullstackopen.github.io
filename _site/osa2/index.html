<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>osa 2</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/osa2/">
  <link rel="alternate" type="application/rss+xml" title="Full stack open 2018" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Full stack open 2018</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">osa 2</h1>
  </header>

  <div class="post-content">
    <h2 id="osan-2-oppimistavoitteet">osan 2 oppimistavoitteet</h2>

<ul>
  <li>Web-sovellusten toiminnan perusteet
    <ul>
      <li>lisää CSS:ää</li>
      <li>selain suoritusympäristönä</li>
      <li>selaimen ja palvelimen välisen kommunikoinnin perusteet</li>
    </ul>
  </li>
  <li>React
    <ul>
      <li>taulukossa olevan datan renderöinti</li>
      <li>komponenttien määrittely moduuleissa</li>
      <li>kontrolloidut lomakkeet</li>
      <li>taulukossa olevan renderöitävän datan filtteröinti</li>
      <li>komponentin ‘lifecycle’-metodit</li>
      <li>riippuvuuksien lisääminen</li>
      <li>kommunikointi palvelimen kanssa</li>
      <li>tyylien lisäämisen perusteita</li>
    </ul>
  </li>
  <li>Javascript
    <ul>
      <li>template string</li>
      <li>olioiden käsittelyä: property shorthand notation, object assign</li>
      <li>ES6 moduulien perusteita</li>
      <li>promiset</li>
      <li>taulukoiden käsittelyä: map, filter, find</li>
    </ul>
  </li>
</ul>

<h2 id="muutama-huomio">Muutama huomio</h2>

<h3 id="setstate-on-asynkrooninen">setState on asynkrooninen</h3>

<p>Muutamat ovat jo törmänneet siihen, että <strong>React kutsuu funktiota setState asynkroonisesti</strong>, eli jos meillä on seuraava koodi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="p">)</span>
<span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">counter</span><span class="p">:</span> <span class="mi">55</span><span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="p">)</span>
</code></pre></div></div>

<p>tulostavat molemmat rivit saman arvon, sillä Reactin tila <strong>ei saa uutta arvoa</strong> heti komennon <em>this.setState</em> jälkeen, vaan vasta sitten kun suorituksen alla oleva metodi on suoritettu loppuun ja <em>setState</em> on saanut mahdollisuuden suoritukselle.</p>

<h3 id="consolelog">console.log</h3>

<p><em>Mikä erottaa kokeneen ja kokemattoman Javascript-ohjelmoijan? Kokeneet käyttävät 10-100 kertaa enemmän console.logia</em>.</p>

<p>Paradoksaalista kyllä tämä näyttää olevan tilanne, vaikka kokematon ohjelmoija oikeastaan tarvitsisi console.logia (tai jotain muita debuggaustapoja) huomattavissa määrin kokenutta enemmän.</p>

<p>Eli kun joku ei toimi, älä arvaile vaan logaa tai käytä jotain muita debuggauskeinoja.</p>

<p><strong>HUOM</strong> kun käytät komentoa <em>console.log</em> debuggaukseen, älä yhdistele asioita “javamaisetsi” plussalla, eli sen sijaan että kirjoittaisit</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'propsin arvo on'</span> <span class="o">+</span> <span class="nx">props</span><span class="p">)</span>
</code></pre></div></div>

<p>erottele tulostettavat asiat pilkulla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'propsin arvo on'</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span>
</code></pre></div></div>

<p>Jos yhdistät merkkijonoon olion, tuloksena on suhteellisen hyödytön tulostustmuoto</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>propsin arvo on <span class="o">[</span>Object object]
</code></pre></div></div>

<p>kun taas pilkulla tulostettavat asiat erotellessa saat developer-konsoliin olion, jonka sisältöä on mahdollista tarkastella.</p>

<h3 id="tapahtumankäsittely-revisited">Tapahtumankäsittely revisited</h3>

<p>Pajan ja telegrammin havaintojen perusteella tapahtumankäsittely on osoittautunut haastavaksi.</p>

<p>Osassa 1 on nyt uusi luku <a href="/osa1#tapahtumankäsittely-revisited">tapahtumäakasittely revisited</a> joka käy aihepiiriä läpi.</p>

<h3 id="visual-studio-coden-snippetit">Visual Studio Coden snippetit</h3>

<p>VS Codeen on helppo määritellä “snippettejä”, eli Netbeansin “sout”:in tapaisia oikoteitä yleisesti käytettyjen koodinpätkien generointiin. Ohje snippetien luomiseen <a href="https://github.com/FullStack-HY/FullStack-Hy.github.io/blob/master/snippet_ohje.md">täällä</a></p>

<p>VS Code -plugineina löytyy myös hyödyllisiä valmiiksi määriteltyjä snippetejä, esim.
<a href="https://marketplace.visualstudio.com/items?itemName=xabikos.ReactSnippets">tämä</a></p>

<h3 id="pakolliset-tehtävät-tehtävien-vaikutus-arvosanaan">Pakolliset tehtävät, tehtävien vaikutus arvosanaan</h3>

<p>Joissain yhteyksissä on ollut pientä epäselvyyttä mitä tiettyjen tehtävien pakollisuus tarkoittaa, ja mikä eipakollisten tehtävien rooli on. Tarkennusta asiaan tehtävien sivun <a href="/tehtävät">alussa</a></p>

<h3 id="linkkivinkit">linkkivinkit</h3>

<p>Kurssisivun alaisuudessa on nyt <a href="https://fullstack-hy.github.io/linkit/">osio</a>, jonne kaikkien toivotaan lisäilevän hyödylliseksi kokemiaan linkkejä. Lisääminen onnistuu tekemällä pull request <a href="https://github.com/FullStack-HY/FullStack-Hy.github.io/blob/master/linkit.md">tänne</a></p>

<p>Kun lisäät linkin, laita linkin yhteyteen pieni kuvaus mitä linkin takaa löytyy.</p>

<h2 id="taulukkojen-käyttö-javascriptissä">Taulukkojen käyttö Javascriptissä</h2>

<p>Tästä osasta lähtien käytämme runsaasti Javascriptin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array">taulukkojen</a> funktionaalisia käsittelymetodeja, kuten <em>find</em>, <em>filter</em> ja <em>map</em>. Periaate niissä on täysin sama kuin Java 8:sta tutuissa streameissa, joita on käytetty jo runsaan vuoden ajan laitoksen Ohjelmoinnin perusteissa ja jatkokurssilla.</p>

<p>Jos taulukon funktionaalinen käsittely tuntuu vielä vieraalta, kannattaa katsoa Youtubessa olevasta videosarjasarjasta <em>Functional Programming in JavaScript</em> ainakin kolme ensimmäistä osaa</p>
<ul>
  <li><a href="https://www.youtube.com/watch?v=BMUiFMZr7vk&amp;list=PL0zVEGEvSaeEd9hlmCXrk5yUyqUag-n84">Higher-order functions</a></li>
  <li><a href="https://www.youtube.com/watch?v=bCqtb-Z5YGQ&amp;list=PL0zVEGEvSaeEd9hlmCXrk5yUyqUag-n84&amp;index=2">Map</a></li>
  <li><a href="https://www.youtube.com/watch?v=Wl98eZpkp-c&amp;t=31s">Reduce basics</a></li>
</ul>

<h2 id="kokoelmien-renderöiminen">Kokoelmien renderöiminen</h2>

<p>Tehdään nyt Reactilla <a href="/osa1">ensimmäisen osan</a> alussa käytettyä esimerkkisovelluksen <a href="https://fullstack-exampleapp.herokuapp.com/spa">Single page app -versiota</a> vastaavan sovelluksen ‘frontend’ eli selainpuolen sovelluslogiikka.</p>

<p>Aloitetaan seuraavasta:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>

<span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T17:30:31.098Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'Selain pystyy suorittamaan vain javascriptiä'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T18:39:34.091Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T19:20:14.298Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">notes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">notes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">notes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">App</span> <span class="na">notes=</span><span class="si">{</span><span class="nx">notes</span><span class="si">}</span> <span class="p">/&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Jokaiseen muistiinpanoon on merkitty tekstuaalisen sisällön ja aikaleiman lisäksi myös <em>boolean</em>-arvo, joka kertoo onko muistiinpano luokiteltu tärkeäksi, sekä yksikäsitteinen tunniste <em>id</em>.</p>

<p>Koodin toiminta perustuu siihen, että taulukossa on tasan kolme muistiinpanoa, yksittäiset muistiinpanot renderöidään ‘kovakoodatusti’ viittaamalla suoraan taulukossa oleviin olioihin:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;li&gt;</span>{note[1].content}<span class="nt">&lt;/li&gt;</span>
</code></pre></div></div>

<p>Tämä ei tietenkään ole järkevää. Ratkaisu voidaan yleistää generoimalla taulukon perusteella joukko React-elementtejä käyttäen <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map">map</a>-funktiota:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>notes.map<span class="o">(</span>note <span class="o">=&gt;</span> &lt;li&gt;<span class="o">{</span>note.content<span class="o">}</span>&lt;/li&gt;<span class="o">)</span>
</code></pre></div></div>

<p>nyt tuloksena on taulukko, jonka sisältö on joukko <em>li</em>-elementtejä</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="s1">'&lt;li&gt;HTML on helppoa&lt;/li&gt;'</span><span class="p">,</span>
  <span class="s1">'&lt;li&gt;Selain pystyy suorittamaan vain javascriptiä&lt;/li&gt;'</span><span class="p">,</span>
  <span class="s1">'&lt;li&gt;HTTP-protokollan tärkeimmät metodit ovat GET ja POST&lt;/li&gt;'</span>
<span class="p">]</span>
</code></pre></div></div>

<p>jotka voidaan sijoittaa <em>ul</em>-tagien sisälle:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">notes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;)</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Koska li-tagit generoiva koodi on Javascriptia, tulee se sijoittaa JSX-templatessa aaltosulkujen sisälle kaiken muun Javascript-koodin tapaan.</p>

<p>Usein vastaavissa tilanteissa dynaamisesti generoitava sisältö eristetään omaan metodiin, jota JSX-template kutsuu:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">notes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">rivit</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;)</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">rivit</span><span class="p">()</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Vaikka sovellus näyttää toimivan, tulee konsoliin ikävä varoitus</p>

<p><img src="http://localhost:4000/assets/2/1.png" alt="" /></p>

<p>Kuten virheilmoituksen linkittämä <a href="https://reactjs.org/docs/lists-and-keys.html#keys">sivu</a> kertoo, tulee taulukossa olevilla, eli käytännössä <em>map</em>-metodilla muodostetuilla elementeillä olla uniikki avain, eli kenttä nimeltään <em>key</em>.</p>

<p>Lisätään avaimet:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">notes</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">rivit</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;)</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">rivit</span><span class="p">()</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Virheilmoitus katoaa.</p>

<p>React käyttää taulukossa olevien elementtien key-kenttiä päätellessään miten sen tulee päivittää komponentin generoimaa näkymää silloin kun komponentti uudelleenrenderöidään. Lisää aiheesta <a href="https://reactjs.org/docs/reconciliation.html#recursing-on-children">täällä</a>.</p>

<h3 id="map">Map</h3>

<p>Taulukoiden metodin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map">map</a> toiminnan sisäistäminen on jatkon kannalta äärimmäisen tärkeää.</p>

<p>Sovellus siis sisältää taulukon <em>notes</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T17:30:31.098Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'Selain pystyy suorittamaan vain javascriptiä'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T18:39:34.091Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T19:20:14.298Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Pysähdytään hetkeksi tarkastelemaan miten <em>map</em> toimii.</p>

<p>Jos esim. tiedoston loppuun lisätään seuraava koodi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
</code></pre></div></div>

<p>tulostuu konsoliin <em>[1, 2, 3]</em> eli <em>map</em> muodostaa uuden taulukon, jonka jokainen alkio on saatu alkuperäisen taulukon <em>notes</em> alkioista <em>mappaamalla</em> komennon parametrina olevan funktion avulla.</p>

<p>Funktio on</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span>
</code></pre></div></div>

<p>eli kompaktissa muodossa kirjoitettu nuolifunktio, joka on täydelliseltä kirjoitustavaltaan seuraava</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span>
<span class="p">}</span>
</code></pre></div></div>

<p>eli funktio saa parametrikseen muistiinpano-olion ja <em>palauttaa</em> sen kentän <em>id</em> arvon.</p>

<p>Muuttamalla komento muotoon</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span><span class="o">=&gt;</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
</code></pre></div></div>

<p>tuloksena on taulukko, joka koostuu muistiinpanojen sisällöistä.</p>

<p>Tämä on jo lähellä käyttämäämme React-koodia:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>notes.map<span class="o">(</span>note <span class="o">=&gt;</span> &lt;li <span class="nv">key</span><span class="o">={</span>note.id<span class="o">}&gt;{</span>note.content<span class="o">}</span>&lt;/li&gt;<span class="o">)</span>
</code></pre></div></div>

<p>joka muodostaa jokaista muistiinpano-olioa vastaavan <em>li</em>-tagin, jonka sisään tulee muistiinpanon sisältö.</p>

<p>Koska metodin <em>map</em> parametrina olevan funktion</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>note <span class="o">=&gt;</span> &lt;li <span class="nv">key</span><span class="o">={</span>note.id<span class="o">}&gt;{</span>note.content<span class="o">}</span>&lt;/li&gt;
</code></pre></div></div>

<p>käyttötarkoitus on näkymäelementtien muodostaminen, tulee muuttujan arvo renderöidä aaltosulkeiden sisällä. Kokeile mitä koodi tekee, jos poistat aaltosulkeet.</p>

<p>Aaltosulkeiden käyttö tulee varmaan aiheuttamaan alussa pientä päänvaivaa, mutta totut niihin pian. Reactin antama visuaalinen feedback on välitön.</p>

<p>Tarkastellaan vielä erästä bugien lähdettä. Lisää koodiin seuraava</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const result <span class="o">=</span> notes.map<span class="o">(</span>note <span class="o">=&gt;</span> <span class="o">{</span>note.content<span class="o">}</span> <span class="o">)</span>
console.log<span class="o">(</span>result<span class="o">)</span>
</code></pre></div></div>

<p>Tulostuu</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>undefined, undefined, undefined]
</code></pre></div></div>

<p>Missä on vika? Koodihan on ihan sama kun äsken toiminut koodi. Paitsi ei ihan. Metodin <em>map</em> parametrina on nyt seuraava funktio</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">note</span><span class="p">.</span><span class="nx">content</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Koska funktio koostuu nyt <em>koodilohkosta</em> on funktion paluuarvo määrittelemätön eli <em>undefined</em>. Nuolifunktiot siis palauttavat ainoan komentonsa arvon, ainoastaan jos nuolifunktio on määritelty kompaktissa muodossaan, ilman koodilohkoa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">content</span>
</code></pre></div></div>

<p>huomaa, että ‘oneliner’-nuolifunktioissa kaikkea ei tarvitse eikä aina kannatakaan kirjoittaa samalle riville.</p>

<p>Parempi muotoilu ohjelmamme muistiinpanorivit tuottavalle apufunktiolle saattaakin olla seuraava useille riveille jaoteltu versio:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const rivit <span class="o">=</span> <span class="o">()</span> <span class="o">=&gt;</span> notes.map<span class="o">(</span>note <span class="o">=&gt;</span>
  &lt;li <span class="nv">key</span><span class="o">={</span>note.id<span class="o">}&gt;</span>
    <span class="o">{</span>note.content<span class="o">}</span>
  &lt;/li&gt;
<span class="o">)</span>
</code></pre></div></div>

<p>Kyse on kuitenkin edelleen yhden komennon sisältävästä nuolifunktiosta, komento vain sattuu olemaan hieman monimutkaisempi.</p>

<h3 id="antipattern-taulukon-indeksit-avaimina">Antipattern: taulukon indeksit avaimina</h3>

<p>Olisimme saaneet konsolissa olevan varoituksen katoamaan myös käyttämällä avaimina taulukon indeksejä. Indeksit selviävät käyttämällä map-metodissa myös toista parametria:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">note</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">...)</span>
</code></pre></div></div>

<p>näin kutsuttaessa <em>i</em> saa arvokseen sen paikan indeksin taulukossa, missä <em>note</em> sijaitsee.</p>

<p>Eli virheetön tapa määritellä rivien generointi on</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const rivit <span class="o">=</span> <span class="o">()</span> <span class="o">=&gt;</span> notes.map<span class="o">((</span>note, i<span class="o">)</span> <span class="o">=&gt;</span> &lt;li <span class="nv">key</span><span class="o">={</span>i<span class="o">}&gt;{</span>note.content<span class="o">}</span>&lt;/li&gt;<span class="o">)</span>
</code></pre></div></div>

<p>Tämä <strong>ei kuitenkaan ole suositeltavaa</strong> ja voi näennäisestä toimimisestaan aiheuttaa joissakin tilanteissa pahoja ongelmia. Lue lisää esim. <a href="https://medium.com/@robinpokorny/index-as-a-key-is-an-anti-pattern-e0349aece318">täältä</a>.</p>

<h3 id="refaktorointia---moduulit">Refaktorointia - moduulit</h3>

<p>Siistitään koodia hiukan. Koska olemme kiinnostuneita ainoastaan propsien kentästä <em>notes</em>, otetaan se vastaan suoraan <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">destrukturointia</a> hyödyntäen:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">rivit</span><span class="p">()</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Erotetaan yksittäisen muistiinpanon esittäminen oman komponenttinsa <em>Note</em> vastuulle:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">note</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">notes</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span><span class="o">=&gt;</span><span class="p">&lt;</span><span class="nc">Note</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span><span class="p">/&gt;)</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Huomaa, että <em>key</em>-attribuutti täytyy nyt määritellä <em>Note</em>-komponenteille, eikä <em>li</em>-tageille kuten ennen muutosta.</p>

<p>Koko React-sovellus on mahdollista määritellä samassa tiedostossa, mutta se ei luonnollisesti ole järkevää. Usein käytäntönä on määritellä yksittäiset komponentit omassa tiedostossaan <em>ES6-moduuleina</em>.</p>

<p>Koodissamme on käytetty koko ajan moduuleja. Tiedoston ensimmäiset rivit</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
</code></pre></div></div>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">importtaavat</a> eli ottavat käyttöönsä kaksi moduulia. Moduuli <em>react</em> sijoitetaan muuttujan <em>React</em> ja <em>react-dom</em> muuttujaan <em>ReactDOM</em>.</p>

<p>Siirretään nyt komponentti <em>Note</em> omaan moduuliinsa.</p>

<p>Pienissä sovelluksissa komponentit sijoitetaan yleensä <em>src</em>-hakemiston alle sijoitettavaan hakemistoon <em>components</em>. Konventiona on nimetä tiedosto komponentin mukaan, eli tehdään hakemisto <em>components</em> ja sinne tiedosto <em>Note.js</em> jonka sisältö on seuraava:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">note</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">Note</span>
</code></pre></div></div>

<p>Koska kyseessä on React-komponentti, tulee React importata komponentissa.</p>

<p>Moduulin viimeisenä rivinä <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/export">eksportataan</a> määritelty komponentti, eli muuttuja <em>Note</em>.</p>

<p>Nyt komponenttia käyttävä tiedosto <em>index.js</em> voi <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">importata</a> moduulin:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
<span class="k">import</span> <span class="nx">Note</span> <span class="k">from</span> <span class="s1">'./components/Note'</span>
</code></pre></div></div>

<p>Moduulin eksporttaama komponentti on nyt käytettävissä muuttujassa <em>Note</em> täysin samalla tavalla kuin aiemmin.</p>

<p>Huomaa, että itse määriteltyä komponenttia importatessa komponentin sijainti tulee ilmaista <em>suhteessa importtaavaan tiedostoon</em>:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'./components/Note'</span>
</code></pre></div></div>

<p>Piste alussa viittaa nykyiseen hakemistoon, eli kyseessä on nykyisen hakemiston alihakemisto <em>components</em> ja sen sisällä tiedosto <em>Note.js</em>. Tiedoston päätteen voi jättää pois.</p>

<p>Koska myös <em>App</em> on komponentti, eristetään sekin omaan moduuliinsa. Koska kyseessä on sovelluksen juurikomponentti, sijoitetaan se suoraan hakemistoon <em>src</em>. Tiedoston sisältö on seuraava:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">Note</span> <span class="k">from</span> <span class="s1">'./components/Note'</span>

<span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">notes</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span> <span class="p">/&gt;)</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">App</span>
</code></pre></div></div>

<p>Tiedoston <em>index.js</em> sisällöksi jää:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="s1">'./App'</span>

<span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">...</span>
<span class="p">]</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">App</span> <span class="na">notes=</span><span class="si">{</span><span class="nx">notes</span><span class="si">}</span> <span class="p">/&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>
<p>Moduuleilla on paljon muutakin käyttöä kuin mahdollistaa komponenttien määritteleminen omissa tiedostoissaan, palaamme moduuleihin tarkemmin myöhemmin kurssilla.</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-1">githubissa</a></p>

<p>Huomaa, että repositorion master-haarassa on myöhemmän vaiheen koodi, tämän hetken koodi on tagissa <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-1">part2-1</a>:</p>

<p><img src="http://localhost:4000/images/2/1b.png" alt="" /></p>

<p>Jos kloonaat projektin itsellesi, suorita komento <em>npm install</em> ennen käynnistämistä eli komentoa <em>npm start</em>.</p>

<h3 id="tehtäviä-kokoelmien-renderöinnistä">Tehtäviä kokoelmien renderöinnistä</h3>

<p>Tee nyt <a href="/tehtävät#kokoelmien-renderöinti">tehtävät 2.1-2.5</a></p>

<h2 id="lomakkeet">Lomakkeet</h2>

<p>Jatketaan sovelluksen laajentamista siten, että se mahdollistaa uusien muistiinpanojen lisäämisen.</p>

<p>Jotta saisimme sivun päivittymään uusien muistiinpanojen lisäyksen yhteydessä, on parasta sijoittaa muistiinpanot komponentin <em>App</em> tilaan. Funktionaalisilla komponenteilla ei ole tilaa, joten muutetaan <em>App</em> luokkaan perustuvaksi komponentiksi:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">notes</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">notes</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span> <span class="p">/&gt;)</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Konstruktori asettaa nyt propseina saatavan <em>notes</em>-taulukon tilaan avaimen <em>notes</em> arvoksi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">notes</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">notes</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>tila siis näyttää komponentin alustuksen jälkeen seuraavalta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">notes</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
      <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T17:30:31.098Z'</span><span class="p">,</span>
      <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="c1">//...</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p><strong>HUOM</strong> komponenttien tilan alustaminen propseina välitettyjen arvojen perusteella ei välttämättä ole hyvä tapa, se on monien mukaan jopa <a href="https://vasanthk.gitbooks.io/react-bits/anti-patterns/01.props-in-initial-state.html">antipattern</a>. Jos kuitenkin tutkitaan vähän pintaa syvemmälle, kyseessä on ongelma lähinnä silloin <a href="https://medium.com/@justintulk/react-anti-patterns-props-in-initial-state-28687846cc2e">jos propsien arvo voi muuttua</a>. Näin ei ohjelmassamme ole, eli tilan alustaminen propsien perusteella on hyväksyttävää.</p>
</blockquote>

<p>Lisätään sitten lomake uuden muistiinpanon lisäämistä varten:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">notes</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">notes</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'nappia painettu'</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span> <span class="p">/&gt;)</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span><span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>tallenna<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lomakkeelle on lisätty myös tapahtumankäsittelijäksi metodi <em>addNote</em> reagoimaan sen “lähettämiseen”, eli napin painamiseen.</p>

<p>Tapahtumankäsittelijä on <a href="/osa1#tapahtumankäsittely">osasta 1</a> tuttuun tapaan määritelty seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'nappia painettu'</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Parametrin <em>event</em> arvona on metodin kutsun aiheuttama <a href="https://reactjs.org/docs/handling-events.html">tapahtuma</a>.</p>

<p>Tapahtumankäsittelijä kutsuu heti tapahtuman metodia <code>event.preventDefault()</code> jolla se estää lomakkeen lähetyksen oletusarvoisen toiminnan, joka aiheuttaisi mm. sivun uudelleenlatautumisen.</p>

<p>Tapahtuman kohde, eli <em>event.target</em> on tulostettu konsoliin</p>

<p><img src="http://localhost:4000/assets/2/2.png" alt="" /></p>

<p>Kohteena on siis komponentin määrittelemä lomake.</p>

<p>Miten pääsemme käsiksi lomakkeen <em>input</em>-komponenttiin syötettyyn dataan?</p>

<p>Tapoja on useampia, tutustumme ensin ns. <a href="https://reactjs.org/docs/forms.html#controlled-components">kontrolloituina komponentteina</a> toteutettuihin lomakkeisiin.</p>

<p>Lisätään komponentin <em>App</em> tilaan kenttä <em>newNote</em> lomakkeen syötettä varten:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">notes</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">notes</span><span class="p">,</span>
      <span class="na">newNote</span><span class="p">:</span> <span class="s1">'uusi muistiinpano...'</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Määritellään tilaan lisätty kenttä <em>input</em>-komponentin attribuutin <em>value</em> arvoksi:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">onSubmit=</span><span class="s">{this.addNote}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">value=</span><span class="s">{this.state.newNote}</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>tallenna<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>Tilaan määritelty “placeholder”-teksti <em>uusi muistiinpano…</em> ilmestyy syötekomponenttiin, tekstiä ei kuitenkaan voi muuttaa. Konsoliin tuleekin ikävä varoitus joka kertoo mistä on kyse</p>

<p><img src="http://localhost:4000/assets/2/4.png" alt="" /></p>

<p>Koska määrittelimme syötekomponentille <em>value</em>-attribuutiksi komponentin <em>App</em> tilassa olevan kentän, alkaa <em>App</em> <a href="https://reactjs.org/docs/forms.html#controlled-components">kontrolloimaan</a> syötekomponentin toimintaa.</p>

<p>Jotta kontrolloidun syötekomponentin editoiminen olisi mahdollista, täytyy sille rekisteröidä <em>tapahtumankäsittelijä</em>, joka synkronoi syötekenttään tehdyt muutokset komponentin <em>App</em> tilaan:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">handleNoteChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">newNote</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span> <span class="p">/&gt;)</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span>
            <span class="na">value=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="si">}</span>
            <span class="na">onChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleNoteChange</span><span class="si">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>tallenna<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lomakkeen <em>input</em>-komponentille on nyt rekisteröity tapahtumankäsittelijä tilanteeseen <em>onChange</em>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span>
  <span class="na">value=</span><span class="s">{this.state.newNote}</span>
  <span class="na">onChange=</span><span class="s">{this.handleNoteChange}</span>
<span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Tapahtumankäsittelijää kutsutaan <em>aina kun syötekomponentissa tapahtuu jotain</em>. Tapahtumankäsittelijämetodi saa parametriksi tapahtumaolion <em>event</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">handleNoteChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">newNote</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tapahtumaolion kenttä <em>target</em> vastaa nyt kontrolloitua <em>input</em>-kenttää ja <em>event.target.value</em> viittaa inputin syötekentän arvoon.</p>

<p>Huomaa, että toisin kuin tapahtuman <em>onSubmit</em> käsittelijässä, nyt oletusarvoisen toiminnan estävää metodikutusua <em>event.preventDefault()</em> ei tarvita sillä syötekentän muutoksella ei ole oletusarvoista toimintaa toisin kuin lomakkeen lähettämisellä.</p>

<p>Voit seurata konsolista miten tapahtumankäsittelijää kutsutaan:</p>

<p><img src="http://localhost:4000/assets/2/5.png" alt="" /></p>

<p>Muistithan jo asentaa <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">React devtoolsin</a>? Devtoolsista näet, miten tila muuttuu syötekenttään kirjoitettaessa:</p>

<p><img src="http://localhost:4000/images/2/5a.png" alt="" /></p>

<p>Nyt komponentin <em>App</em> tilan kenttä <em>newNote</em> heijastaa koko ajan syötekentän arvoa, joten voimme viimeistellä uuden muistiinpanon lisäämisestä huolehtivan metodin <em>addNote</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="k">new</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">noteObject</span><span class="p">)</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
    <span class="na">notes</span><span class="p">:</span> <span class="nx">notes</span><span class="p">,</span>
    <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ensin luodaan uutta muistiinpanoa vastaava olio <em>noteObject</em>, jonka sisältökentän arvo saadaan komponentin tilasta <em>this.state.newNote</em>. Yksikäsitteinen tunnus eli <em>id</em> generoidaan kaikkien muistiinpanojen lukumäärän perusteella. Koska muistiinpanoja ei poisteta, menetelmä toimii sovelluksessamme. Komennon <code>Math.random()</code> avulla muistiinpanosta tulee 50% todennäköisyydellä tärkeä.</p>

<p>Uusi muistiinpano lisätään vanhojen joukkoon oikeaoppisesti käyttämällä <a href="/osa1#taulukon-käsittelyä">osasta 1</a> tuttua taulukon metodia <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/concat">concat</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">noteObject</span><span class="p">)</span>
</code></pre></div></div>

<p>Metodi ei muuta alkuperäistä taulukkoa <em>this.state.notes</em> vaan luo uuden taulukon, joka sisältää myös lisättävän alkion. Tämä on tärkeää, sillä Reactin tilaa <a href="https://reactjs.org/docs/state-and-lifecycle.html#using-state-correctly">ei saa muuttaa suoraan</a>!</p>

<p>Lopussa komponentin tila päivitetään uusilla muistiinpanoilla ja tyhjentämällä syötekomponentin arvoa kontrolloiva kenttä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
  <span class="na">notes</span><span class="p">:</span> <span class="nx">notes</span><span class="p">,</span>
  <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="kehittyneempi-tapa-olioliteraalien-kirjoittamiseen">Kehittyneempi tapa olioliteraalien kirjoittamiseen</h3>

<p>Voimme muuttaa tilan päivittämän koodin</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
  <span class="na">notes</span><span class="p">:</span> <span class="nx">notes</span><span class="p">,</span>
  <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
<span class="p">})</span>
</code></pre></div></div>

<p>muotoon</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
  <span class="nx">notes</span><span class="p">,</span>
  <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tämä johtuu siitä, että ES6:n myötä (ks. kohta <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer">property definitions</a>) Javascriptiin on tullut uusi ominaisuus, joka mahdollistaa hieman tiiviimmän tavan muuttujien avulla tapahtuvaan olioiden määrittelyyn.</p>

<p>Tarkastellaan tilannetta, jossa meillä on muuttujissa arvoja</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">'Leevi'</span>
<span class="kd">const</span> <span class="nx">age</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></div>

<p>ja haluamme määritellä näiden perusteella olion, jolla on kentät <em>name</em> ja <em>age</em>.</p>

<p>Vanhassa Javascriptissä olio täytyi määritellä seuraavaan tyyliin</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">person</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
  <span class="na">age</span><span class="p">:</span> <span class="nx">age</span>
<span class="p">}</span>
</code></pre></div></div>

<p>koska muuttujien ja luotavan olio kenttien nimi nyt on sama, riittää ES6:ssa kirjoittaa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">person</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">age</span> <span class="p">}</span>
</code></pre></div></div>

<p>lopputulos molemmilla tavoilla luotuun olioon on täsmälleen sama.</p>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-2">githubissa</a>, tagissa <em>part2-2</em>.</p>

<h2 id="näytettävien-elementtien-filtteröinti">Näytettävien elementtien filtteröinti</h2>

<p>Tehdään sovellukseen toiminto, joka mahdollistaa ainoastaan tärkeiden muistiinpanojen näyttämisen.</p>

<p>Lisätään komponentin <em>App</em> tilaan tieto siitä näytetäänkö muistiinpanoista kaikki vai ainoastaan tärkeät:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">notes</span><span class="p">:</span> <span class="nx">props</span><span class="p">.</span><span class="nx">notes</span> <span class="p">,</span>
      <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">showAll</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Muutetaan metodia <em>render</em> siten, että se tallettaa muuttujaan <em>notesToShow</em> näytettävien muistiinpanojen listan riippuen siitä tuleeko näyttää kaikki vai vain tärkeät:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">notesToShow</span> <span class="o">=</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span> <span class="p">?</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span> <span class="p">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">notesToShow</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span> <span class="p">/&gt;)</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span>
          <span class="na">value=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="si">}</span>
          <span class="na">onChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleNoteChange</span><span class="si">}</span>
        <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>tallenna<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Muuttujan <em>notesToShow</em> määrittely on melko kompakti</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notesToShow</span> <span class="o">=</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span> <span class="p">?</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span> <span class="p">:</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span>
</code></pre></div></div>

<p>Käytössä on monissa muissakin kielissä oleva <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Conditional_Operator">ehdollinen</a> operaatio.</p>

<p>Operaatio toimii seuraavasti. Jos meillä on esim:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">tulos</span> <span class="o">=</span> <span class="nx">ehto</span> <span class="p">?</span> <span class="nx">val1</span> <span class="p">:</span> <span class="nx">val2</span>
</code></pre></div></div>

<p>muuttujan <em>tulos</em> arvoksi asetetaan <em>val1</em>:n arvo jos <em>ehto</em> on tosi. Jos <em>ehto</em> ei ole tosi, muuttujan <em>tulos</em> arvoksi tulee <em>val2</em>:n arvo.</p>

<p>Jos ehto <em>this.state.showAll</em> on epätosi, muuttuja <em>notesToShow</em> saa arvokseen vaan ne muistiinpanot, joiden <em>important</em>-kentän arvo on tosi. Filtteröinti tapahtuu taulukon metodilla <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter">filter</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span>
</code></pre></div></div>

<p>vertailu-operaatio on oikeastaan turha koska <em>note.important</em> on arvoltaan joko <em>true</em> tai <em>false</em>, eli riittää kirjoittaa</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span><span class="p">)</span>
</code></pre></div></div>

<p>Tässä käytettiin kuitenkin ensin vertailuoperaattoria, mm. korostamaan erästä tärkeää seikkaa: Javascriptissa <code>arvo1 == arvo2</code> ei toimi kaikissa tilanteissa loogisesti ja onkin varmempi käyttää aina vertailuissa muotoa <code>arvo1 === arvo2</code>. Enemmän aiheesta <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness">täällä</a>.</p>

<p>Filtteröinnin toimivuutta voi jo nyt kokeilla vaihtelemalla sitä, miten tilan kentän <em>showAll</em> alkuarvo määritelään konstruktorissa.</p>

<p>Lisätään sitten toiminnallisuus, mikä mahdollistaa <em>showAll</em>:in tilan muuttamisen sovelluksesta.</p>

<p>Oleelliset muutokset ovat seuraavassa:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">toggleVisible</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">showAll</span><span class="p">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">notesToShow</span> <span class="o">=</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span> <span class="p">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span> <span class="p">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">label</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span> <span class="p">?</span> <span class="s1">'vain tärkeät'</span> <span class="p">:</span> <span class="s1">'kaikki'</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleVisible</span><span class="si">}</span><span class="p">&gt;</span>
            näytä <span class="si">{</span><span class="nx">label</span><span class="si">}</span>
          <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="nx">notesToShow</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span> <span class="p">/&gt;)</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span>
            <span class="na">value=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="si">}</span>
            <span class="na">onChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleNoteChange</span><span class="si">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>tallenna<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Näkyviä muistiinpanoja (kaikki vai ainoastaan tärkeät) siis kontrolloidaan napin avulla. Napin tapahtumankäsittelijä on yksinkertainen, se muuttaa <em>this.state.showAll</em>:n arvon truesta falseksi ja päinvastoin:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">toggleVisible</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">showAll</span><span class="p">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Napin teksti määritellään muuttujaan, jonka arvo määräytyy tilan perusteella:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">label</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span> <span class="p">?</span> <span class="s1">'vain tärkeät'</span> <span class="p">:</span> <span class="s1">'kaikki'</span>
</code></pre></div></div>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-3">githubissa</a>, tagissa <em>part2-3</em>.</p>

<h3 id="tehtäviä-lomakkeista">Tehtäviä lomakkeista</h3>

<p>Tee nyt tehtävät <a href="/tehtävät#lomakkeet">2.6-2.10</a></p>

<h2 id="datan-haku-palvelimelta">Datan haku palvelimelta</h2>

<p>Olemme nyt viipyneet tovin keskittyen pelkkään “frontendiin”, eli selainpuolen toiminnallisuuteen. Rupeamme itse toteuttamaan “backendin”, eli palvelinpuolen toiminnallisuutta vasta kurssin kolmannessa osassa, mutta otamme nyt jo askeleen sinne suuntaan tutustumalla siihen miten selaimessa suoritettava koodi kommunikoi backendin kanssa.</p>

<p>Käytetään nyt palvelimena sovelluskehitykseen tarkoitettua <a href="https://github.com/typicode/json-server">JSON Serveriä</a>.</p>

<p>Tee projektin juurihakemistoon tiedosto <em>db.json</em>, jolla on seuraava sisältö:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"notes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HTML on helppoa"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-12-10T17:30:31.098Z"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"important"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Selain pystyy suorittamaan vain javascriptiä"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-12-10T18:39:34.091Z"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"important"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
      </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HTTP-protokollan tärkeimmät metodit ovat GET ja POST"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-12-10T19:20:14.298Z"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"important"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>JSON server on mahdollista <a href="https://github.com/typicode/json-server#install">asentaa</a> koneelle ns. globaalisti komennolla <em>npm install -g json-server</em>. Globaali asennus edellyttää kuitenkin pääkäyttäjän oikeuksia, eli se ei ole mahdollista laitoksen koneilla tai uusilla fuksiläppäreillä.</p>

<p>Globaali asennus ei kuitenkaan ole tarpeen, voimme käynnistää <em>json-serverin</em> komennon <em>npx</em> avulla:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx json-server <span class="nt">--port</span><span class="o">=</span>3001 <span class="nt">--watch</span> db.json
</code></pre></div></div>

<p>Oletusarvoisesti <em>json-server</em> käynnistyy porttiin 3000, mutta create-react-app:illa luodut projektit varaavat portin 3000, joten joudumme nyt määrittelemään json-server:ille vaihtoehtoisen portin 3001.</p>

<p>Mennään selaimella osoitteeseen <a href="http://localhost:3001/notes">http://localhost:3001/notes</a>. Kuten huomaamme, <em>json-server</em> tarjoaa osoitteessa tiedostoon tallentamamme muistiinpanot JSON-muodossa:</p>

<p><img src="http://localhost:4000/assets/2/6.png" alt="" /></p>

<p>Ideana jatkossa onkin se, että muistiinpanot talletetaan palvelimelle, eli tässä vaiheessa <em>json-server</em>:ille. React-koodi lataa muistiinpanot palvelimelta ja renderöi ne ruudulle. Kun sovellukseen lisätään uusi muistiinpano, React-koodi lähettää sen myös palvelimelle, jotta uudet muistiinpanot jäävät pysyvästi “muistiin”.</p>

<p>json-server tallettaa kaiken datan palvelimella sijaitsevaan tiedostoon <em>db.json</em>. Todellisuudessa data tullaan tallentamaan johonkin tietokantaan. json-server on kuitenkin käyttökelpoinen apuväline, joka mahdollistaa palvelinpuolen toiminnallisuuden käyttämisen kehitysvaiheessa ilman tarvetta itse ohjelmoida mitään.</p>

<p>Tutustumme palvelinpuolen toteuttamisen periaatteisiin tarkemmin kurssin <a href="/osa3">osassa 3</a>.</p>

<h3 id="selain-suoritusympäristönä">Selain suoritusympäristönä</h3>

<p>Ensimmäisenä tehtävänämme on siis hakea React-sovellukseen jo olemassaolevat mustiinpanot osoitteesta <a href="http://localhost:3001/notes">http://localhost:3001/notes</a>.</p>

<p>Osan 0 <a href="/osa0#selaimessa-suoritettava-sovelluslogiikka">esimerkkiprojektissa</a> nähtiin jo eräs tapa hakea Javascript-koodista palvelimella olevaa dataa. Esimerkin koodissa data haettiin <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequest</a>- eli XHR-olion avulla muodostetulla HTTP-pyynnöllä. Kyseessä on 1999 lanseerattu tekniikka, jota kaikki web-selaimet ovat jo pitkään tukeneet.</p>

<p>Nykyään XHR:ää ei kuitenkaan kannata käyttää ja selaimet tukevatkin jo laajasti <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch">fetch</a>-metodia, joka perustuu XHR:n käyttämän tapahtumapohjaisen mallin sijaan ns. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">promiseihin</a>.</p>

<p>Muistutuksena edellisestä osasta (oikeastaan tätä tapaa pitää lähinnä <em>muistaa olla käyttämättä</em> ilman painavaa syytä), XHR:llä haettiin dataa seuraavasti</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">xhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>

<span class="nx">xhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span>
    <span class="c1">// käsittele muuttujaan data sijoitettu kyselyn tulos</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">xhttp</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/data.json'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="nx">xhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
</code></pre></div></div>

<p>Heti alussa HTTP-pyyntöä vastaavalle <em>xhttp</em>-oliolle rekisteröidään <em>tapahtumankäsittelijä</em>, jota Javascript runtime kutsuu kun <em>xhttp</em>-olion tila muuttuu. Jos tilanmuutos tarkoittaa että pyynnön vastaus on saapunut, käsitellään data halutulla tavalla.</p>

<p>Huomionarvoista on se, että tapahtumankäsittelijän koodi on määritelty jo ennen kun itse pyyntö lähetetään palvelimelle. Tapahtumankäsittelijäfunktio tullaan kuitenkin suorittamaan vasta jossain myöhäisemmässä vaiheessa. Koodin suoritus ei siis etene synkronisesti “ylhäältä alas”, vaan <em>asynkronisesti</em>, Javascript kutsuu sille rekisteröityä tapahtumankäsittelijäfunktiota jossain vaiheessa.</p>

<p>Esim. Java-ohjelmoinnista tuttu synkroninen tapa tehdä kyselyjä etenisi seuraavaan tapaan (huomaa että kyse ei ole oikeasti toimivasta Java-koodista):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HTTPRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HTTPRequest</span><span class="o">()</span>

<span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"https://fullstack-exampleapp.herokuapp.com/data.json"</span><span class="o">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Muistiinpano</span><span class="o">&gt;</span> <span class="n">muistiinpanot</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>

<span class="n">muistiinpanot</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">m</span> <span class="o">=&gt;</span> <span class="o">{</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">content</span><span class="o">);</span>
<span class="o">})</span>
</code></pre></div></div>

<p>Javassa koodi etenee nyt rivi riviltä ja koodi pysähtyy odottamaan HTTP-pyynnön, eli komennon <em>request.get(…)</em> valmistumista. Komennon palauttama data, eli muistiinpanot talletetaan muuttujaan ja dataa aletaan käsittelemään halutulla tavalla.</p>

<p>Javascript-enginet eli suoritusympäristöt kuitenkin noudattavat <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop">asynkronista mallia</a>, eli periaatteena on se, että kaikki <a href="https://en.wikipedia.org/wiki/Input/output">IO-operaatiot</a> (poislukien muutama poikkeus) suoritetaan ei-blokkaavana, eli operaatioiden tulosta ei jäädä odottamaan vaan koodin suoritusta jatketaan heti eteenpäin.</p>

<p>Siinä vaiheessa kun operaatio valmistuu tai tarkemmin sanoen jonain valmistumisen jälkeisenä ajanhetkenä, kutsuu Javascript-engine operaatiolle rekisteröityjä tapahtumankäsittelijöitä.</p>

<p>Nykyisellään Javascript-moottorit ovat <em>yksisäikeisiä</em> eli ne eivät voi suorittaa rinnakkaista koodia. Tämän takia on käytännössä pakko käyttää ei-blokkaavaa maillia IO-operaatioiden suorittamiseen, sillä muuten selain ‘jäätyisi’ siksi aikaa kun esim. palvelimelta haetaan dataa.</p>

<p>Javascript-moottoreiden yksisäikeisyydellä on myös sellainen seuraus, että jos koodin suoritus kestää erittäin pitkään, menee selain jumiin suorituksen ajaksi. Jos lisätään jonnekin kohtaa sovellustamme, esim. konstruktoriin seuraava koodi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'loop..'</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">50000000000</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">i</span><span class="o">++</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'end'</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">5000</span><span class="p">)</span>
</code></pre></div></div>

<p>Kaikki toimii 5 sekunnin ajan normaalisti. Kun <em>setTimeout</em>:in parametrina määritelty funktio suoritetaan, menee selaimen sivu jumiin pitkän loopin suorituksen ajaksi. Ainakaan Chromessa selaimen tabia ei pysty edes sulkemaan luupin suorituksen aikana.</p>

<p>Eli jotta selain säilyy <em>responsiivisena</em>, eli että se reagoi koko ajan riittävän nopeasti käyttäjän haluamiin toimenpiteisiin, koodin logiikan tulee olla sellainen, että yksittäinen laskenta ei saa kestää liian kauaa.</p>

<p>Aiheesta löytyy paljon lisämateriaalia internetistä, eräs varsin havainnollinen esitys aiheesta Philip Robertsin esitelmä <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ">What the heck is the event loop anyway?</a></p>

<p>Nykyään selaimissa on mahdollisuus suorittaa myös rinnakkaista koodia ns. <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">web workerien</a> avulla. Yksittäisen selainikkunan koodin ns. event loopista huolehtii kuitenkin edelleen <a href="https://medium.com/techtrument/multithreading-javascript-46156179cf9a">vain yksi säie</a>.</p>

<h2 id="npm">npm</h2>

<p>Palaamme jälleen asiaan, eli datan hakemiseen palvelimelta.</p>

<p>Voisimme käyttää datan palvelimelta hakemiseen aiemmin mainittua promiseihin perustuvaa funktiota <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch">fetch</a>. Fetch on hyvä työkalu, se on standardoitu ja kaikkien modernien selaimien (poislukien IE) tukema.</p>

<p>Käytetään selaimen ja palvelimen väliseen kommunikaatioon kuitenkin <a href="https://github.com/axios/axios">axios</a>-kirjastoa, joka toimii samaan tapaan kuin fetch, mutta on hieman mukavampikäyttöinen. Hyvä syy axios:in käytölle on myös se, että pääsemme tutustumaan siihen miten ulkopuolisia kirjastoja eli <em>npm-paketteja</em> liitetään React-projektiin.</p>

<p>Nykyään lähes kaikki Javascript-projektit määritellään node “pakkausmanagerin” eli <a href="https://docs.npmjs.com/getting-started/what-is-npm">npm</a>:n avulla. Myös create-react-app:in avulla generoidut projektit ovat npm-muotoisia projekteja. Varma tuntomerkki siitä on projektin juuressa oleva tiedosto <em>package.json</em>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"osa2"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"private"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="s2">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"react"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^16.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"react-dom"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^16.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"react-scripts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.17"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts start"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts build"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts test --env=jsdom"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"eject"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts eject"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Tässä vaiheessa meitä kiinnostaa osa <em>dependencies</em>, joka määrittelee mitä <em>riippuvuuksia</em> eli ulkoisia kirjastoja projektilla on.</p>

<p>Haluamme nyt käyttöömme axioksen. Voisimme määritellä kirjaston suoraan tiedostoon <em>package.json</em>, mutta on parempi asentaa se komentoriviltä</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install axios <span class="nt">--save</span>
</code></pre></div></div>

<p><strong>Huomaa, että <em>npm</em>-komennot tulee antaa aina projektin juurihakemistossa</strong>, eli siinä minkä sisältä tiedosto <em>package.json</em> löytyy.</p>

<p>Nyt axios on mukana riippuvuuksien joukossa:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"axios"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.17.1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"react"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^16.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"react-dom"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^16.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"react-scripts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.17"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">/*...*/</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Sen lisäksi, että komento <em>npm install</em> lisäsi axiosin riippuvuuksien joukkoon, se myös <em>latasi</em> kirjaston koodin. Koodi löytyy muiden riippuvuuksien tapaan projektin juuren hakemistosta <em>node_modules</em>, mikä kuten huomata saattaa sisältääkin runsaasti kaikenlaista.</p>

<p>Tehdään toinenkin pieni lisäys. Asennetaan myös <em>json-server</em> projektin riippuvuudeksi komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install json-server <span class="nt">--save</span>
</code></pre></div></div>

<p>ja lisätään tiedoston <em>package.json</em> osaan <em>scripts</em> rivi</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"server"</span>: <span class="s2">"json-server -p3001 db.json"</span>
</code></pre></div></div>

<p>eli muutetaan se muotoon</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">/*...*/</span><span class="w">
  </span><span class="s2">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts start"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts build"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts test --env=jsdom"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"eject"</span><span class="p">:</span><span class="w"> </span><span class="s2">"react-scripts eject"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"server"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json-server -p3001 db.json"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Nyt voimme käynnistää (muista sammuttaa aiemmin käynnistämäsi!) json-serverin projektin hakemistosta mukavasti ilman tarvetta parametrien määrittelylle komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run server
</code></pre></div></div>

<p>Tutustumme npm:n tarkemmin kurssin <a href="/osa3">kolmannessa osassa</a>.</p>

<h3 id="axios-ja-promiset">Axios ja promiset</h3>

<p>Olemme nyt valmiina käyttämään axiosia. Jatkossa oletetaan että <em>json-server</em> on käynnissä portissa 3001.</p>

<p>Kirjaston voi ottaa käyttöön samaan tapaan kuin esim. React otetaan käyttöön, eli sopivalla <em>import</em>-lauseella.</p>

<p>Lisätään seuraava tiedostoon <em>index.js</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>

<span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">promise</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">promise2</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/foobar'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">promise2</span><span class="p">)</span>
</code></pre></div></div>

<p>Konsoliin tulostuu seuraavaa</p>

<p><img src="http://localhost:4000/assets/2/8.png" alt="" /></p>

<p>Axiosin metodi <em>get</em> palauttaa <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises">promisen</a>.</p>

<p>Mozillan dokumentaatio sanoo promisesta seuraavaa:</p>
<blockquote>
  <p>A Promise is an object representing the eventual completion or failure of an asynchronous operation.</p>
</blockquote>

<p>Promise siis edustaa asynkronista operaatiota. Promise voi olla kolmessa eri tilassa:</p>
<ul>
  <li>aluksi promise on <em>pending</em>, eli promisea vastaava asynkroninen operaatio ei ole vielä tapahtunut</li>
  <li>jos operaatio päättyy onnistuneesti, menee promise tilaan <em>fulfilled</em>, josta joskus käytetään nimitystä <em>resolved</em></li>
  <li>kolmas mahdollinen tila on <em>rejected</em>, joka edustaa epäonnistunutta operaatiota</li>
</ul>

<p>Esimerkkimme ensimmäinen promise on <em>fulfilled</em>, eli vastaa onnistunutta <em>axios.get(‘http://localhost:3001/notes’)</em> pyyntöä. Promiseista toinen taas on <em>rejected</em>, syy selviää konsolista, eli yritettiin tehdä HTTP GET -pyyntöä osoitteeseen, jota ei ole olemassa.</p>

<p>Jos ja kun haluamme tietoon promisea vastaavan operaation tuloksen, tulee promiselle rekisteröidä tapahtumankuuntelija. Tämä tapahtuu metodilla <em>then</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">)</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Konsoliin tulostuu seuraavaa</p>

<p><img src="http://localhost:4000/assets/2/9.png" alt="" /></p>

<p>Javascriptin suoritusympäristö kutsuu <em>then</em>-metodin avulla rekisteröityä takaisinkutsufunktiota antaen sille parametriksi olion <em>result</em>, joka sisältää kaiken oleellisen HTTP GET -pyynnön vastaukseen liittyvän, eli palautetun <em>datan</em>, <em>statuskoodin</em> ja <em>headerit</em>.</p>

<p>Promise-olioa ei ole yleensä tarvetta tallettaa muuttujaan, ja onkin tapana ketjuttaa metodin <em>then</em> kutsu suoraan axiosin metodin kutsun perään:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">notes</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Takaisinkutsufunktio ottaa nyt vastauksen sisällä olevan datan muuttujaan ja tulostaa muistiinpanot konsoliin.</p>

<p>Luettavampi tapa formatoida <em>ketjutettuja</em> metodikutsuja on sijoittaa jokainen kutsu omalle rivilleen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">notes</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>näin jo nopea, ruudun vasempaan laitaan kohdistunut vilkaisu kertoo mistä on kyse.</p>

<p>Palvelimen palauttama data on pelkkää tekstiä, käytännössä yksi iso merkkijono. Asian voi todeta, esim. tekemällä HTTP-pyyntö komentoriviltä <a href="https://curl.haxx.se">curl</a>:illa</p>

<p><img src="http://localhost:4000/assets/2/10.png" alt="" /></p>

<p>Axios-kirjasto osaa kuitenkin parsia datan Javascript-taulukoksi, sillä palvelin on kertonut headerin <em>content-type</em> avulla että datan muoto on <em>application/json; charser=utf-8</em> (ks ylempi kuva).</p>

<p>Voimme vihdoin siirtyä käyttämään sovelluksessamme palvelimelta haettavaa dataa.</p>

<p>Tehdään se aluksi “huonosti”, eli lisätään sovellusta vastaavan komponentin <em>App</em> renderöinti takaisinkutsufunktion sisälle muuttamalla <em>index.js</em> seuraavaan muotoon:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
<span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="s1">'./App'</span>

<span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>

<span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
  <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">App</span> <span class="na">notes=</span><span class="si">{</span><span class="nx">notes</span><span class="si">}</span> <span class="p">/&gt;,</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Joissain tilanteissa tämäkin tapa voisi olla ok, mutta se on hieman ongelmallinen ja päätetäänkin siirtää datan hakeminen komponenttiin <em>App</em>.</p>

<p>Ei ole kuitenkaan ihan selvää, mihin kohtaan komponentin koodia komento <em>axios.get</em> olisi hyvä sijoittaa.</p>

<h3 id="komponenttien-lifecycle-metodit">Komponenttien lifecycle-metodit</h3>

<p>Reactin luokkien avulla määritellyillä komponenteilla voidaan määritellä joukko <a href="https://reactjs.org/docs/state-and-lifecycle.html#adding-lifecycle-methods-to-a-class">lifecycle</a>-metodeita, eli metodeita, joita React kutsuu tietyssä komponentin “elinkaaren” vaiheessa.</p>

<p>Yleinen tapa datan palvelimelta tapahtuvaan hakemiseen on suorittaa se metodissa <a href="https://reactjs.org/docs/react-component.html#componentDidMount">componentDidMount</a>. React kutsuu metodia sen jälkeen kun konstruktori on suoritettu ja <em>render</em>-metodi on suoritettu ensimmäistä kertaa.</p>

<p>Muutetaan sovellusta nyt seuraavasti.</p>

<p>Poistetaan datan hakeminen tiedostosta <em>index.js</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span><span class="p">,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Komponentille <em>App</em> ei ole enää tarvetta välittää dataa propseina.</p>

<p>Komponentti <em>App</em> muuttuu seuraavasti:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">notes</span><span class="p">:</span> <span class="p">[],</span>
      <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">showAll</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'constructor'</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'will mount'</span><span class="p">)</span>
    <span class="nx">axios</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'promise fulfilled'</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">notes</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span> <span class="p">})</span>
      <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'render'</span><span class="p">)</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Eli konstruktorissa asetetaan tilan <em>notes</em> kentäksi tyhjä taulukko. Lifecycle-metodi <em>componentDidMount</em> hakee datan axiosin avulla ja rekisteröi takaisinkutsufunktion, joka promisen valmistumisen (<em>fulfillment</em>) yhteydessä päivittää komponentin tilan asettamalla palvelimen palauttamat muistiinpanot tilan kentän <em>notes</em> arvoksi.</p>

<p>Koodiin on myös lisätty muutama aputulostus, jotka auttavat hahmottamaan miten suoritus etenee.</p>

<p>Konsoliin tulostuu</p>

<pre>
constructor
render
will mount
promise fulfilled
render
</pre>

<p>Ensin siis suoritetaan konstruktori, ja sen jälkeen metodi <em>componentDidMount</em>. Tämän jälkeen kutsutaan kuitenkin metodia <em>render</em>, miksi näin?</p>

<p>Metodissa <em>componentDidMount</em> suoritetaan axiosin avulla HTTP GET -pyyntö ja samalla <em>rekisteröidään</em> pyynnön palauttamalle promiselle tapahtumankäsittelijä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'promise fulfilled'</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">notes</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span> <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tapahtumankäsittelijän koodia, eli then:in parametrina olevaa <em>funktiota</em> ei siis suoriteta vielä tässä vaiheessa. Javascriptin runtime kutsuu sitä jossain vaiheessa sen jälkeen kun palvelin on vastannut HTTP GET -pyyntöön. Tätä ennen kutsutaan metodia <em>render</em> ja komponentti <em>App</em> piirtyy ruudulle aluksi siten, että yhtään muistiinpanoa ei näytetä.</p>

<p>Emme kuitenkaan ehdi huomaamaan asiaa, sillä palvelimen vastaus tulee pian, ja se taas saa aikaan tapahtumankäsittelijän suorituksen. Tapahtumankäsittelijä päivittää komponentin tilaa kutsumalla <em>setState</em> ja tämä saa aikaan komponentin uudelleenrenderöinnin.</p>

<p>Mieti tarkasti äsken läpikäytyä tapahtumasarjaa, sen ymmärtäminen on erittäin tärkeää!</p>

<p>Huomaa, että olisimme voineet kirjoittaa koodin myös seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">eventHandler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'promise fulfilled'</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">notes</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span> <span class="p">})</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">)</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">eventHandler</span><span class="p">)</span>
</code></pre></div></div>

<p>Muuttujaan <em>eventHandler</em> on sijoitettu viite funktioon. Axiosin metodin get palauttama promise on talletettu muuttujaan <em>promise</em>. Takaisinkutsun rekisteröinti tapahtuu antamalla promisen then-metodin parametrina muuttuja <em>eventHandler</em>, joka viittaa käsittelijäfunktioon.</p>

<p>React-komponenteilla on myös joukko muita <a href="https://reactjs.org/docs/react-component.html">lifecycle-metodeja</a>, palaamme niihin myöhemmin.</p>

<p>Kokeillaan mitä tapahtuu, jos muistiinpanojen tallettavaa kenttää <em>notes</em> ei alusteta konstruktorissa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1">//notes: [],</span>
      <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">showAll</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Seurauksena on ongelmia:</p>

<p><img src="http://localhost:4000/images/2/10a.png" alt="" /></p>

<p>Virheen aiheuttaa komento <em>notesToShow.map</em> sillä muuttujan <em>notesToShow</em> arvo ei ole määritelty ja näin ollen metodin <em>map</em> kutsuminen on mahdotonta.</p>

<p>Muuttuja saa arvonsa metodin <em>render</em> alkuosassa:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const notesToShow =
  this.state.showAll ?
    this.state.notes :
    this.state.notes.filter(note =&gt; note.important === true)
</code></pre></div></div>

<p>Koska metodia <em>render</em> kutsutaan ensimmäisen kerran <em>ennen kuin palvelimelta haettava data saapuu</em>, ei tilan kentälle <em>notes</em> ole asetettu mitään arvoa.</p>

<p>Tulet 100% varmuudella törmäämään kurssilla vastaavaan ongelmaan, eli <em>render</em> metodissa on jollain tavalla aina varauduttava siihen, että ensimmäinen renderöitymiskerta tapahtuu ennen kuin palvelimelta haettava data on saapunut.</p>

<p>Palautetaan konstruktori ennalleen.</p>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-4">githubissa</a>, tagissa <em>part2-4</em>.</p>

<h3 id="tehtäviä-datan-hakemisesta-palvelimelta">Tehtäviä datan hakemisesta palvelimelta</h3>

<p>Tee nyt tehtävät <a href="/tehtävät#datan-hakeminen-palvelimelta">2.11-2.13</a></p>

<h2 id="rest-apin-käyttö">REST API:n käyttö</h2>

<p>Kun sovelluksella luodaan uusia muistiinpanoja, täytyy ne tallentaa palvelimelle.</p>

<p>json-server mainitsee olevansa ns. REST tai RESTful API</p>

<blockquote>
  <p>Get a full fake REST API with zero coding in less than 30 seconds (seriously)</p>
</blockquote>

<p>Ihan alkuperäisen <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">määritelmän</a> mukainen RESTful API json-server ei ole, mutta ei ole kovin moni muukaan itseään REST:iksi kutsuva rajapinta.</p>

<p>Tutustumme REST:iin tarkemmin kurssin <a href="/osa3">seuraavassa osassa</a>, mutta jo nyt on tärkeä ymmärtää minkälaista <a href="https://en.wikipedia.org/wiki/Representational_state_transfer#Applied_to_Web_services">konventiota</a> json-server ja yleisemminkin REST API:t käyttävät <a href="https://github.com/typicode/json-server#routes">reittien</a>, eli URL:ien ja käytettävien HTTP-pyyntöjen tyyppien suhteen.</p>

<p>REST:issä yksittäisiä asioita esim. meidän tapauksessamme muistiinpanoja kutsutaan <em>resursseiksi</em>. Jokaisella resurssilla on yksilöivä osoite eli URL. json-serverin noudattaman yleisen konvention mukaan yksittäistä muistiinpanoa kuvaavan resurssin URL on muotoa <em>notes/3</em>, missä 3 on resurssin tunniste. Osoite <em>notes</em> taas vastaa kaikkien yksittäisten muistiinpanojen kokoelmaa.</p>

<p>Resursseja haetaan palvelimelta HTTP GET -pyynnöillä. Esim. HTTP GET osoitteeseen <em>notes/3</em> palauttaa muistiinpanon, jonka id-kentän arvo on 3. Kun taas HTTP GET -pyyntö osoitteeseen <em>notes</em> palauttaa kaikki muistiinpanot.</p>

<p>Uuden muistiinpanoa vastaavan resurssin luominen tapahtuu json-serverin noudattamassa REST-konventiossa tekemällä HTTP POST -pyyntö, joka kohdistuu myös samaan osoiteeseen <em>notes</em>. Pyynnön mukana sen runkona eli <em>bodynä</em> lähetetään luotavan muistiinpanon tiedot.</p>

<p>json-server vaatii, että tiedot lähetetään JSON-muodossa, eli käytännössä sopivasti muotoiltuna merkkijonona ja asettamalla headerille <em>Content-Type</em> arvo <em>application/json</em>.</p>

<h2 id="datan-lähetys-palvelimelle">Datan lähetys palvelimelle</h2>

<p>Muutetaan nyt uuden muistiinpanon lisäämisestä huolehtivaa tapahtumankäsittelijää seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
    <span class="na">important</span><span class="p">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
  <span class="p">}</span>

  <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">,</span> <span class="nx">noteObject</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>eli luodaan muistiinpanoa vastaava olio, ei kuitenkaan lisätä sille kenttää <em>id</em>, parempi jättää id:n generointi palvelimen vastuulle!</p>

<p>Lähetetään sitten olio palvelimelle käyttämällä axiosin metodia <em>post</em>. Rekisteröidään tapahtumankäsittelijä, joka tulostaa konsoliin palvelimen vastauksen.</p>

<p>Kun nyt kokeillaan luoda uusi muistiinpano, konsoliin tulostus näyttää seuraavalta:</p>

<p><img src="http://localhost:4000/assets/2/11.png" alt="" /></p>

<p>Uusi muistiinpano on siis <em>response</em>-olion kentän <em>data</em> arvona. Palvelin on lisännyt muistiinpanolle tunnisteen, eli <em>id</em>-kentän.</p>

<p>Joskus on hyödyllistä tarkastella HTTP-pyyntöjä <a href="/osa0#http-get">osan 0 alussa</a> paljon käytetyn konsolin <em>Network</em>-välilehden kautta:</p>

<p><img src="http://localhost:4000/assets/2/12.png" alt="" /></p>

<p>Voimme, esim. tarkastaa onko POST-pyynnön mukana menevä data juuri se mitä oletimme, onko headerit asetettu oikein ym.</p>

<p>Koska POST-pyynnössä lähettämämme data oli Javascript-olio, osasi axios automaattisesti asettaa pyynnön <em>content-type</em> headerille oikean arvon eli <em>application/json</em>.</p>

<p>Uusi muistiinpano ei vielä renderöidy ruudulle, sillä emme aseta komponentille <em>App</em> uutta tilaa muistiinpanon luomisen yhteydessä. Viimeistellään sovellus vielä tältä osin:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
    <span class="na">important</span><span class="p">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
  <span class="p">}</span>

  <span class="nx">axios</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'http://localhost:3001/notes'</span><span class="p">,</span> <span class="nx">noteObject</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
        <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
        <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
      <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Palvelimen palauttama uusi muistiinpano siis lisätään tilassa olevien muiden muistiinpanojen joukkoon (kannattaa <a href="/osa0#taulukon-käsittelyä">muistaa tärkeä detalji</a> siitä, että metodi <em>concat</em> ei muuta komponentin alkuperäistä tilaa, vaan luo uuden taulukon) ja tyhjennetään lomakkeen teksti.</p>

<p>Kun palvelimella oleva data alkaa vaikuttaa web-sovelluksen toimintalogiikkaan, tulee sovelluskehitykseen heti iso joukko uusia haasteita, joita tuo mukanaan mm. kommunikoinnin asynkronisuus. Debuggaamiseenkin tarvitaan uusia strategiota, debug-printtaukset ym. muuttuvat vain tärkeämmäksi, myös Javascriptin runtimen periaatteita ja React-komponenttien elinkaarta on pakko tuntea riittävällä tasolla, arvaileminen ei riitä.</p>

<p>Palvelimen tilaa kannattaa tarkastella myös suoraan, esim. selaimella:</p>

<p><img src="http://localhost:4000/assets/2/13.png" alt="" /></p>

<p>näin on mahdollista varmistua, mm. siirtyykö kaikki oletettu data palvelimelle.</p>

<p>Kurssin seuraavassa osassa alamme toteuttaa itse myös palvelimella olevan sovelluslogiikan, tutustumme silloin tarkemmin palvelimen debuggausta auttaviin työkaluihin, mm. <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">postmaniin</a>. Tässä vaiheessa json-server-palvelimen tilan tarkkailuun riittänee selain.</p>

<blockquote>
  <p><strong>HUOM:</strong> sovelluksen nykyisessä versiossa selain lisää uudelle muistiinpanolle sen luomishetkeä kuvaavan kentän. Koska koneen oma kello voi näyttää periaatteessa mitä sattuu, on aikaleimojen generointi todellisuudessa viisaampaa hoitaa palvelimella ja tulemmekin tekemään tämän muutoksen kurssin seuraavassa osassa.</p>
</blockquote>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-5">githubissa</a>, tagissa <em>part2-5</em>.</p>

<h2 id="muistiinpanon-tärkeyden-muutos">Muistiinpanon tärkeyden muutos</h2>

<p>Lisätään muistiinpanojen yhteyteen painike, millä niiden tärkeyttä voi muuttaa.</p>

<p>Muistiinpanon määrittelevän komponentin muutos on seuraava:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="p">({</span><span class="nx">note</span><span class="p">,</span> <span class="nx">toggleImportance</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">?</span> <span class="s1">'make not important'</span> <span class="p">:</span> <span class="s1">'make important'</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">}</span> <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">toggleImportance</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">label</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/button&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Komponentissa on nappi, jolle on rekisteröity klikkaustapahtuman käsittelijäksi propsien avulla välitetty funktio <em>toggleImportance</em>.</p>

<p>Tapahtumankäsittelijän alustava versio on määritelty komponentissa <em>App</em> seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">toggleImportanceOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'importance of '</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">' needs to be toggled'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kyseessä on jälleen funktio, joka palauttaa funktion. Palataan sen sisältöön kohta.</p>

<p>Komponentin <em>App</em> metodissa <em>render</em> välitetään jokaiselle muistiinpanolle tapahtumankäsittelijäfunktio:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;ul&gt;</span>
  {notesToShow.map(note =&gt;
    <span class="nt">&lt;Note</span>
      <span class="na">key=</span><span class="s">{note.id}</span>
      <span class="na">note=</span><span class="s">{note}</span>
      <span class="na">toggleImportance=</span><span class="s">{this.toggleImportanceOf(note.id)}</span>
    <span class="nt">/&gt;</span>
  )}
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div></div>

<p>Jokaisen muistiinpanon tapahtumankäsittelijä on nyt <em>yksilöllinen</em>, sillä se sisältää muistiinpanon <em>id:n</em>. Esim. jos <em>note.id</em> on 3 tulee tapahtumankäsittelijäksi <em>this.toggleImportance(note.id)</em> eli käytännössä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'importance of 3 needs to be toggled'</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Eli komponentin <em>App</em> metodi <em>toggleImportanceOf</em> ei itsessään ole tapahtumankäsittelijä, vaan <em>tehdas</em>, jonka avulla kullekin muistiinpanolle luodaan oma tapahtumankäsittelijä.</p>

<p>Pieni huomio tähän väliin. Tapahtumankäsittelijän koodin tulostuksessa muodostetaan tulostettava merkkijono Javan tyyliin plussaamalla stringejä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'importance of '</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">' needs to be toggled'</span><span class="p">)</span>
</code></pre></div></div>

<p>ES6:n <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">template string</a> -ominaisuuden ansiosta Javascriptissa vastaavat merkkijonot voidaan kirjottaa hieman mukavammin:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`importance of </span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2"> needs to be toggled`</span><span class="p">)</span>
</code></pre></div></div>

<p>Merkkijonon sisälle voi nyt määritellä “dollari-aaltosulku”-syntaksilla kohtia, minkä sisälle evaluoidaan javascript-lausekkeita, esim. muuttujan arvo. Huomaa, että template stringien hipsutyyppi poikkeaa Javascriptin normaaleista merkkijonojen käyttämistä hipsuista.</p>

<p>Yksittäistä json-serverillä olevaa muistiinpanoa voi muuttaa kahdella tavalla, joko <em>korvaamalla</em> sen tekemällä HTTP PUT -pyyntö muistiinpanon yksilöivään osoitteeseen tai muuttamalla ainoastaan joidenkin muistiinpanon kenttien arvoja HTTP PATCH -pyynnöllä.</p>

<p>Korvaamme nyt muistiinpanon kokonaan, sillä samalla tulee esille muutama tärkeä React:iin ja Javascriptiin liittyvä seikka.</p>

<p>Metodi on seuraavassa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">toggleImportanceOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`http://localhost:3001/notes/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span>
    <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">changedNote</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">note</span><span class="p">,</span> <span class="na">important</span><span class="p">:</span> <span class="o">!</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">}</span>

    <span class="nx">axios</span>
      <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">changedNote</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
          <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span> <span class="p">?</span> <span class="nx">note</span> <span class="p">:</span> <span class="nx">changedNote</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Melkein joka riville sisältyy tärkeitä yksityiskohtia. Ensimmäinen rivi määrittelee jokaiselle muistiinpanolle id-kenttään perustuvan yksilöivän url:in.</p>

<p>Taulukon metodilla <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/find">find</a> etsitään muutettava muistiinpano ja talletetaan muuttujaan <em>note</em> viite siihen.</p>

<p>Sen jälkeen luodaan <em>uusi olio</em>, jonka sisältö on sama kuin vanhan olion sisältö poislukien kenttä important. Luominen näyttää hieman erikoiselta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">changedNote</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">note</span><span class="p">,</span> <span class="na">important</span><span class="p">:</span> <span class="o">!</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">}</span>
</code></pre></div></div>

<p>Kyseessä on vielä standardoimattoman <a href="https://github.com/tc39/proposal-object-rest-spread">object spread</a> -operaation soveltaminen.</p>

<p>Käytännössä <code>{...note}</code> luo olion, jolla on kenttinään kopiot olion <em>note</em> kenttien arvoista. Kun aaltosulkeisiin lisätään asioita, esim. <code>{ ...note, important: true }</code>, tulee uuden olion kenttä <em>important</em> saamaan arvon <em>true</em>. Eli esimerkissämme <em>important</em> saa uudessa oliossa vanhan arvonsa käänteisarvon.</p>

<p>Uusi olio olisi voitu luodan myös vanhemmalla komennolla <a href="https://developer.mozilla.org/nl/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">changedNote</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">note</span><span class="p">,</span> <span class="p">{</span><span class="na">important</span><span class="p">:</span> <span class="o">!</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span><span class="p">}</span> <span class="p">}</span>
</code></pre></div></div>

<p>Object spread -syntaksi on kuitenkin yleisesti käytössä Reactissa, joten mekin käytämme sitä.</p>

<p>Pari huomioita. Miksi teimme muutettavasta oliosta kopion vaikka myös seuraava koodi näyttää toimivan:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>
<span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="o">=</span> <span class="o">!</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">changedNote</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
</code></pre></div></div>

<p>Näin ei ole suositetavaa tehdä, sillä muuttuja <em>note</em> on viite komponentin tilassa, eli <em>this.state.notes</em>-taulukossa olevaan olioon, ja kuten muistamme tilaa ei Reactissa saa muuttaa suoraan!</p>

<p>Kannattaa myös huomata, että uusi olio <em>changedNote</em> on ainoastaan ns <a href="https://en.wikipedia.org/wiki/Object_copying#Shallow_copy">shallow copy</a>, eli uuden olion kenttien arvoina on vanhan olion kenttien arvot. Jos vanhan olion kentät olisivat itsessään olioita, viittaisivat uuden olion kentät samoihin olioihin.</p>

<p>Uusi muistiinpano lähetetään sitten PUT-pyynnön mukana palvelimelle, jossa se korvaa aiemman muistiinpanon.</p>

<p>Takaisinkutsufunktiossa asetetaan komponentin <em>App</em> tilaan kaikki vanhat muistiinpanot paitsi muuttuneen, josta tilaan asetetaan palvelimen palauttama versio:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span>
  <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">changedNote</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span> <span class="p">?</span> <span class="nx">note</span> <span class="p">:</span> <span class="nx">changedNote</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Tämä saadaan aikaan metodilla <em>map</em> joka siis luo uuden taulukon vanhan taulukon perusteella. Jokainen uuden taulukon alkio luodaan ehdollisesti siten, että jos ehto <em>note.id !== id</em> on tosi, otetaan uuteen taulukkoon suoraan vanhan taulukon kyseinen alkio. Jos ehto on epätosi, eli kyseessä on muutettu muistiinpano, otetaan uuteen taulukkoon muuttujassa <em>changedNote</em> oleva olio.</p>

<p>Käytetty <em>map</em>-kikka saattaa olla aluksi hieman hämmentävä. Asiaa kannattaakin miettiä tovi. Tapaa tullaan käyttämään kurssilla vielä kymmeniä kertoja.</p>

<h2 id="palvelimen-kanssa-tapahtuvan-kommunikoinnin-eristäminen-omaan-moduuliin">Palvelimen kanssa tapahtuvan kommunikoinnin eristäminen omaan moduuliin</h2>

<p><em>App</em>-komponentti alkaa kasvaa uhkaavasti kun myös palvelimen kanssa kommunikointi tapahtuu komponentissa. <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">Single responsibility</a> -periaatteen hengessä kommunikointi onkin viisainta eristää omaan <a href="#refaktorointia---moduulit">moduuliinsa</a>.</p>

<p>Luodaan hakemisto <em>src/services</em> ja sinne tiedosto <em>notes.js</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>
<span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'http://localhost:3001/notes'</span>

<span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">create</span> <span class="o">=</span> <span class="p">(</span><span class="nx">newObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span> <span class="nx">getAll</span><span class="p">,</span> <span class="nx">create</span><span class="p">,</span> <span class="nx">update</span> <span class="p">}</span>
</code></pre></div></div>

<p>Moduuli palauttaa nyt olion, jonka kenttinä on kolme muistiinpanojen käsittelyä hoitavaa funktiota. Funktiot palauttavat suoraan axiosin metodien palauttaman promisen.</p>

<p>Komponentti <em>App</em> saa moduulin käyttöön <em>import</em>-lauseella</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">noteService</span> <span class="k">from</span> <span class="s1">'./services/notes'</span>

<span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
</code></pre></div></div>

<p>moduulin funktioita käytetään importatun muuttujan <em>noteService</em> kautta seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">noteService</span>
    <span class="p">.</span><span class="nx">getAll</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">notes</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">noteService</span>
    <span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">noteObject</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
        <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
        <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
      <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="nx">toggleImportanceOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">noteService</span>
      <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">changedNote</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
          <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span> <span class="p">?</span> <span class="nx">note</span> <span class="p">:</span> <span class="nx">changedNote</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Voisimme viedä ratkaisua vielä askeleen pidemmälle, sillä käyttäessään moduulin funktioita komponentti <em>App</em> saa olion, joka sisältää koko HTTP-pyynnön vastauksen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">noteService</span>
  <span class="p">.</span><span class="nx">getAll</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">notes</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">})</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Eli asia mistä <em>App</em> on kiinnostunut on parametrin kentässä <em>response.data</em>.</p>

<p>Moduulia olisi miellyttävämpi käyttää, jos se HTTP-pyynnön vastauksen sijaan palauttaisi suoraan muistiinpanot sisältävän taulukon. Tällöin moduulin käyttö näyttäisi seuraavalta</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">noteService</span>
  <span class="p">.</span><span class="nx">getAll</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">notes</span><span class="p">:</span> <span class="nx">notes</span><span class="p">})</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>joka voitaisiin <a href="#kehittyneempi-tapa-olioliteraalien-kirjoittamiseen">ilmaista hieman tiiviimmin</a> seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">noteService</span>
  <span class="p">.</span><span class="nx">getAll</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">notes</span><span class="p">})</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Tämä onnistuu muuttamalla moduulin koodia seuraavasti (koodiin jää ikävästi copy-pastea, emme kuitenkaan nyt välitä siitä):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>
<span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'http://localhost:3001/notes'</span>

<span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">create</span> <span class="o">=</span> <span class="p">(</span><span class="nx">newObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span> <span class="nx">getAll</span><span class="p">,</span> <span class="nx">create</span><span class="p">,</span> <span class="nx">update</span> <span class="p">}</span>
</code></pre></div></div>

<p>eli enää ei palautetakaan suoraan axiosin palauttamaa promisea, vaan otetaan promise ensin muuttujaan <em>request</em> ja kutsutaan sille metodia <em>then</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Täydellisessä muodossa kirjoitettuna viimeinen rivi olisi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span> <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Myös nyt funktio <em>getAll</em> palauttaa promisen, sillä promisen metodi <em>then</em> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then">palauttaa promisen</a>.</p>

<p>Koska <em>then</em>:in parametri palauttaa suoraan arvon <em>response.data</em>, on funktion <em>getAll</em> palauttama promise sellainen, että jos HTTP-kutsu onnistuu, antaa promise takaisinkutsulleen HTTP-pyynnön mukana olleen datan, eli se toimii juuri niin kuin haluamme.</p>

<p>Moduulin muutoksen jälkeen täytyy komponentti <em>App</em> muokata <em>noteService</em>:n metodien takaisinkutsujen osalta ottamaan huomioon, että ne palauttavat datan suoraan:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">component</span> <span class="p">{</span>

  <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">noteService</span>
      <span class="p">.</span><span class="nx">getAll</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">notes</span><span class="p">:</span> <span class="nx">response</span> <span class="p">})</span>
      <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">noteService</span>
      <span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">noteObject</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">newNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
          <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">newNote</span><span class="p">),</span>
          <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
        <span class="p">})</span>
      <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">toggleImportanceOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ...</span>

      <span class="nx">noteService</span>
        <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">changedNote</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">changedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
            <span class="na">notes</span><span class="p">:</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">changedNote</span><span class="p">)</span>
          <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tämä kaikki on hieman monimutkaista ja asian selittäminen varmaan vaan vaikeuttaa sen ymmärtämistä. Internetistä löytyy paljon vaihtelevatasoista materiaalia aiheesta, esim. <a href="https://javascript.info/promise-chaining">tämä</a>.</p>

<p><a href="https://github.com/getify/You-Dont-Know-JS">You do not know JS</a> sarjan kirja “Async and performance” selittää asian <a href="https://github.com/getify/You-Dont-Know-JS/blob/master/async%20%26%20performance/ch3.md">hyvin</a> mutta tarvitsee selitykseen kohtuullisen määrän sivuja.</p>

<p>Promisejen ymmärtäminen on erittäin keskeistä modernissa Javascript-sovelluskehityksessä, joten asiaan kannattaa uhrata kohtuullisessa määrin aikaa.</p>

<h2 id="promise-ja-virheet">Promise ja virheet</h2>

<p>Jos sovelluksemme mahdollistaisi muistiinpanojen poistamisen, voisi syntyä tilanne, missä käyttäjä yrittää muuttaa sellaisen muistiinpanon tärkeyttä, joka on jo poistettu järjestelmästä.</p>

<p>Simuloidaan tälläistä tilannetta “kovakoodaamalla” noteServiceen funktioon <em>getAll</em> muistiinpano, jota ei ole todellisuudessa (eli palvelimella) olemassa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">nonExisting</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'Tätä muistiinpanoa ei ole palvelimelta'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T17:30:31.098Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">nonExisting</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kun valemuistiinpanon tärkeyttä yritetään muuttaa, konsoliin tulee virheilmoitus, joka kertoo palvelimen vastanneen urliin <em>/notes/10000</em> tehtyyn HTTP PUT -pyyntöön statuskoodilla 404 <em>not found</em>:</p>

<p><img src="http://localhost:4000/assets/2/14.png" alt="" /></p>

<p>Sovelluksen tulisi pystyä käsittelemään tilanne hallitusti. Jos konsoli ei ole auki, ei käyttäjä huomaa mitään muuta kuin sen, että muistiinpanon tärkeys ei vaihdu napin painelusta huolimatta.</p>

<p>Jo <a href="#axios-ja-promiset">aiemmin</a> mainittiin, että promisella voi olla kolme tilaa. Kun HTTP-pyyntö epäonnistuu, menee pyyntöä vastaava promise tilaan <em>rejected</em>. Emme tällä hetkellä käsittele koodissamme promisen epäonnistumista mitenkään.</p>

<p>Promisen epäonnistuminen <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises">käsitellään</a> antamalla <em>then</em> –metodille parametriksi myös toinen takaisinkutsufunktio, jota kutsutaan siinä tapauksessa jos promise epäonnistuu.</p>

<p>Ehkä yleisempi tapa kuin kahden tapahtumankäsittelijän käyttö on liittää promiseen epäonnistumistilanteen käsittelijä kutsumalla metodia <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch">catch</a>.</p>

<p>Käytännössä virhetilanteen käsittelijän rekisteröiminen tapahtuisi seuraavasti</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'http://example.com/propably_will_fail'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'success!'</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'fail'</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Jos pyyntö epäonnistuu, kutsutaan <em>catch</em>-metodin avulla rekisteröityä käsittelijää.</p>

<p>Metodia <em>catch</em> hyödynnetän usein siten, että se sijoitetaan syvemmälle promiseketjuun.</p>

<p>Kun sovelluksemme tekee HTTP-operaation syntyy oleellisesti ottaen <a href="https://javascript.info/promise-chaining">promiseketju</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span>
  <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">changedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Metodilla <em>catch</em> voidaan määritellä ketjun lopussa käsittelijäfunktio, jota kutsutaan siinä vaiheessa jos mikä tahansa ketjun promisesta epäonnistuu, eli menee tilaan <em>rejected</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span>
  <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">changedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'fail'</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Hyödynnetään tätä ominaisuutta, ja sijoitetaan virheenkäsittelijä komponenttiin <em>App</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">toggleImportanceOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">changedNote</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">note</span><span class="p">,</span> <span class="na">important</span><span class="p">:</span> <span class="o">!</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">}</span>

    <span class="nx">noteService</span>
      <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">changedNote</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">changedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
          <span class="na">notes</span><span class="p">:</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">changedNote</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">`muistiinpano '</span><span class="p">${</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">}</span><span class="s2">' on jo valitettavasti poistettu palvelimelta`</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">})</span>
      <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Virheilmoitus annetaan vanhan kunnon <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/alert">alert</a>-dialogin avulla ja palvelimelta poistettu muistiinpano poistetaan tilasta.</p>

<p>Olemattoman muistiinpanon poistaminen siis tapahtuu metodilla <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter">filter</a>, joka muodostaa uuden taulukon, jonka sisällöksi tulee aluperäisen taulukon sisällöstä ne alkiot, joille parametrina oleva funktio palauttaa arvon true:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>Alertia tuskin kannattaa käyttää todellisissa React-sovelluksissa. Opimme kohta kehittyneemmän menetelmän käyttäjille tarkoitettujen tiedotteiden antamiseen. Toisaalta on tilanteita, joissa simppeli battle tested -menetelmä kuten <em>alert</em> riittää aluksi aivan hyvin. Hienomman tavan voi sitten tehdä myöhemmin jos aikaa ja intoa riittää.</p>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-6">githubissa</a>, tagissa <em>part2-6</em>.</p>

<h3 id="tehtäviä-palvelimen-tilan-päivittämisestä">Tehtäviä palvelimen tilan päivittämisestä</h3>

<p>Tee nyt tehtävät <a href="/tehtävät#palvelimella-olevan-datan-päivittäminen">2.14-2.17</a></p>

<h2 id="tyylien-lisääminen">Tyylien lisääminen</h2>

<p>Sovelluksemme ulkoasu on tällä hetkellä hyvin vaatimaton. Osaan 0 liittyvissä <a href="/tehtävät/#web-sovellusten-perusteet">tehtävässä 0-1</a> oli tarkoitus tutustua Mozillan <a href="https://developer.mozilla.org/en-US/docs/Learn/Getting_started_with_the_web/CSS_basics">CSS-tutoriaaliin</a>.</p>

<p>Katsotaan vielä tämän osan lopussa nopeasti erästä tapaa liittää tyylejä React-sovellukseen. Tapoja on useita ja tulemme tarkastelemaan muita myöhemmin. Liitämme nyt CSS:n sovellukseemme vanhan kansan tapaan yksittäisenä, käsin eli ilman <a href="https://developer.mozilla.org/en-US/docs/Glossary/CSS_preprocessor">esiprosessorien</a> apua kirjoitettuna tiedostona (tämä ei itseasiassa ole täysin totta, kuten myöhemmin tulemme huomaamaan).</p>

<p>Tehdään sovelluksen hakemistoon <em>src</em> tiedosto <em>index.css</em> ja liitetään se sovellukseen lisäämällä tiedostoon <em>index.js</em> seuraava import:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s1">'./index.css'</span>
</code></pre></div></div>

<p>Lisätään seuraava sääntö tiedostoon <em>index.css</em>:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">h1</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">green</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>CSS-säännöt koostuvat valitsimesta, eli <em>selektorista</em> ja määrittelystä eli <em>deklaraatiosta</em>. Valitsin määrittelee, mihin elementteihin sääntö kohdistuu. Valitsimena on nyt <em>h1</em>, eli kaikki sovelluksessa käytetyt <em>h1</em>-otsikkotägit.</p>

<p>Määrittelyosa asettaa ominaisuuden <em>color</em>, eli fontin värin arvoksi vihreän, eli <em>green</em>.</p>

<p>Sääntö voi sisältää mielivaltaisen määrän määrittelyjä. Muutetaan edellistä siten, että tekstistä tulee kursivoitua, eli fontin tyyliksi asetetaan <em>italics</em>:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">h1</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="no">green</span><span class="p">;</span>
  <span class="nl">font-style</span><span class="p">:</span> <span class="nb">italic</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Erilaisia selektoreja eli tapoja valita tyylien kohde on <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors">lukuisia</a>.</p>

<p>Jos haluamme kohdistaa tyylejä esim. jokaiseen muistiinpanoon, voisimme nyt käyttää selektoria <em>li</em>, sillä muistiinpanot ovat <em>li</em>-tagien sisällä:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">note</span><span class="p">,</span> <span class="nx">toggleImportance</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">?</span> <span class="s1">'make not important'</span> <span class="p">:</span> <span class="s1">'make important'</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span> <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">toggleImportance</span><span class="si">}</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">label</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>lisätään tyylitiedostoon seuraava (koska osaamiseni tyylikkäiden web-sivujen tekemiseen on lähellä nollaa, nyt käytettävissä tyyleissä ei ole sinänsä mitään järkeä):</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">li</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="n">grey</span><span class="p">;</span>
  <span class="nl">padding-top</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">15px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tyylien kohdistaminen elementtityypin sijaan on kuitenkin hieman ongelmallista, jos sovelluksessa olisi myös muita <em>li</em>-tageja, kaikki saisivat samat tyylit.</p>

<p>Jos haluamme kohdistaa tyylit nimenomaan muistiinpanoihin, on parempi käyttää <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Class_selectors">class selectoreja</a>.</p>

<p>Normaalissa HTML:ssä luokat määritellään elementtien attribuutin <em>class</em> arvona:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"note"</span><span class="nt">&gt;</span>
  tekstiä
<span class="nt">&lt;/li&gt;</span>
</code></pre></div></div>

<p>Reactissa tulee kuitenkin classin sijaan käyttää attribuuttia <a href="https://reactjs.org/docs/dom-elements.html#classname">className</a>, eli muutetaan komponenttia <em>Note</em> seuraavasti:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">note</span><span class="p">,</span> <span class="nx">toggleImportance</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">?</span> <span class="s1">'make not important'</span> <span class="p">:</span> <span class="s1">'make important'</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">className=</span><span class="s2">"note"</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span> <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">toggleImportance</span><span class="si">}</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">label</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Luokkaselektori määritellään syntaksilla <em>.classname</em>, eli:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.note</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="n">grey</span><span class="p">;</span>
  <span class="nl">padding-top</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">15px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Jos nyt lisäät sovellukseen muita li-elementtejä, ne eivät saa muistiinpanoille määriteltyjä tyylejä.</p>

<h3 id="parempi-virheilmoitus">Parempi virheilmoitus</h3>

<p>Toteutimme äsken olemassaolemattoman muistiinpanon tärkeyden muutokseen liittyvän virheilmoituksen <em>alert</em>-metodilla. Toteutetaan se nyt Reactilla omana komponenttinaan.</p>

<p>Komponentti on yksinkertainen:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Notification</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">message</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">message</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className=</span><span class="s2">"error"</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">message</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Jos propsin <em>message</em> arvo on <em>null</em> ei renderöidä mitään, muussa tapauksessa renderöidään viesti div-elementtiin. Elementille on liitetty tyylien lisäämistä varten luokka <em>error</em>.</p>

<p>Lisätään komponentin <em>App</em> tilaan kenttä <em>error</em> virheviestiä varten, laitetaan kentälle jotain sisältöä, jotta pääsemme heti testaamaan komponenttia:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">notes</span><span class="p">:</span> <span class="p">[],</span>
      <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">showAll</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">error</span><span class="p">:</span> <span class="s1">'something went wrong...'</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Renderöidään uusi komponentti:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//...</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nc">Notification</span> <span class="na">message=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="si">}</span><span class="p">/&gt;</span>

        ...
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lisätään sitten virheviestille sopiva tyyli:</p>

<pre><code class="language-error">.error {
  color: red;
  background: lightgrey;
  font-size: 20px;
  border-style: solid;
  border-radius: 5px;
  padding: 10px;
  margin-bottom: 10px;
}
</code></pre>

<p>Nyt olemme valmiina lisäämään virheviestin logiikan. Alustetaan virheviesti konstruktorissa arvoon <em>null</em> ja muutetaan metodia <em>toggleImportanceOf</em> seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">toggleImportanceOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">//...</span>

      <span class="nx">noteService</span>
        <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">changedNote</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">changedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="c1">// ...</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
            <span class="na">error</span><span class="p">:</span> <span class="s2">`muistiinpano '</span><span class="p">${</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">}</span><span class="s2">' on jo valitettavasti poistettu palvelimelta`</span><span class="p">,</span>
            <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span>
          <span class="p">})</span>
          <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">error</span><span class="p">:</span> <span class="kc">null</span><span class="p">})</span>
          <span class="p">},</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Eli virheen yhteydessä asetetaan tilan kenttään <em>error</em> sopiva virheviesti. Samalla käynnistetään ajastin, joka asettaa 5 sekunnin kuluttua tilan <em>error</em>-kentän arvoksi <em>null</em>.</p>

<p>Lopputulos näyttää seuraavalta</p>

<p><img src="http://localhost:4000/images/2/15b.png" alt="" /></p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part2-7">githubissa</a>, tagissa <em>part2-7</em>.</p>

<h3 id="loppuhuipennus">Loppuhuipennus</h3>

<p>Tee nyt tehtävät <a href="/tehtävät#tyylit">2.18 ja 2.19</a></p>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
             Full stack open 2018 
          </li>
          <li>
            <a href="mailto:mluukkai@cs.helsinki.fi">mluukkai@cs.helsinki.fi</a>
          </li>
          <li>
            <a href="https://github.com/mluukkai"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mluukkai</span></a>

          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
           
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>
        <br />Materiaali on lisensoitu
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons BY-NC-SA 3.0 -lisenssillä</a>.
        </p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
