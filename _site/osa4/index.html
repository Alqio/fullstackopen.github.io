<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>osa 4</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/osa4/">
  <link rel="alternate" type="application/rss+xml" title="Full stack open 2018" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Full stack open 2018</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">osa 4</h1>
  </header>

  <div class="post-content">
    <h2 id="osan-4-oppimistavoitteet">Osan 4 oppimistavoitteet</h2>

<ul>
  <li>Node.js / Express
    <ul>
      <li>Router</li>
      <li>sovelluksen jakaminen osiin</li>
    </ul>
  </li>
  <li>Node.js -sovellusten testaus
    <ul>
      <li>jest/supertest</li>
    </ul>
  </li>
  <li>JS
    <ul>
      <li>async/await</li>
    </ul>
  </li>
  <li>Mongoose
    <ul>
      <li>Monimutkaisemmat skeemat</li>
      <li>Viittaukset kokoelmien välillä</li>
      <li>populointi</li>
    </ul>
  </li>
  <li>Web
    <ul>
      <li>Token-autentikaatio</li>
      <li>JWT</li>
    </ul>
  </li>
</ul>

<h2 id="sovelluksen-rakenteen-parantelu">Sovelluksen rakenteen parantelu</h2>

<p>Jatketaan <a href="/osa3">osassa 3</a> tehdyn muistiinpanosovelluksen backendin kehittämistä.</p>

<p>Muutetaan sovelluksen rakennetta siten, että projektin juuressa oleva <em>index.js</em> ainoastaan konfiguroi sovelluksen tietokannan ja käytettävät middlewaret. Routejen määrittely siirretään omaan tiedostoonsa, eli siitä tehdään <a href="/osa3/#tietokantamäärittelyjen-eriyttäminen-omaksi-moduuliksi">moduuli</a>.</p>

<p>Routejen tapahtumankäsittelijöitä kutsutaan usein <em>kontrollereiksi</em>. Luodaankin hakemisto <em>controllers</em> ja sinne tiedosto <em>notes.js</em> johon tulemme siirtämään kaikki muistiinpanoihin liittyvien reittien määrittelyt.</p>

<p>Tiedoston sisältö on seuraava:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notesRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">).</span><span class="nx">Router</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/note'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">formatNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">))</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findByIdAndRemove</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">204</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="kc">false</span> <span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">note</span>
    <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">formattedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formattedNote</span><span class="p">)</span>
    <span class="p">})</span>

<span class="p">})</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span>
  <span class="p">}</span>

  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">note</span><span class="p">,</span> <span class="p">{</span> <span class="na">new</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">updatedNote</span><span class="p">))</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">notesRouter</span>
</code></pre></div></div>

<p>Kyseessä on käytännössä melkein suora copypaste tiedostosta <em>index.js</em>.</p>

<p>Muutoksia on muutama. Tiedoston alussa luodaan <a href="http://expressjs.com/en/api.html#router">router</a>-olio:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notesRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">).</span><span class="nx">Router</span><span class="p">()</span>

<span class="c1">//...</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">notesRouter</span>
</code></pre></div></div>

<p>Tiedosto eksporttaa moduulin käyttäjille määritellyn routerin.</p>

<p>Kaikki määriteltävät routet liitetään router-olioon, samaan tapaan kuin aiemmassa versiossa routet liitettiin sovellusta edustavaan olioon.</p>

<p>Huomioinarvoinen seikka routejen määrittelyssä on se, että polut ovat typistyneet, aiemmin määrittelimme esim.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/api/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</code></pre></div></div>

<p>nyt riittää määritellä</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</code></pre></div></div>

<p>Mistä routereissa oikeastaan on kyse? Expressin manuaalin sanoin</p>

<blockquote>
  <p>A router object is an isolated instance of middleware and routes. You can think of it as a “mini-application,” capable only of performing middleware and routing functions. Every Express application has a built-in app router.</p>
</blockquote>

<p>Router on siis <em>middleware</em>, jonka avulla on mahdollista määritellä joukko “toisiinsa liittyviä” routeja yhdessä paikassa, yleensä omassa moduulissaan.</p>

<p>Ohjelman käynnistystiedosto, eli määrittelyt tekevä <em>index.js</em> ottaa määrittelemämme routerin käyttöön seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notesRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./controllers/notes'</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="nx">notesRouter</span><span class="p">)</span>
</code></pre></div></div>

<p>Näin määrittelemäämme routeria käytetään <em>jos</em> polun alkuosa on <em>/api/notes</em>. notesRouter-olion sisällä täytyy tämän takia käyttää ainoastaan polun loppuosia, eli tyhjää polkua <em>/</em> tai pelkkää parametria <em>/:id</em>.</p>

<h3 id="sovelluksen-muut-osat">sovelluksen muut osat</h3>

<p>Sovelluksen käynnistyspisteenä toimiva <em>index.js</em> näyttää muutosten jälkeen seuraavalta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cors'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">middleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./utils/middleware'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">notesRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./controllers/notes'</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'dotenv'</span><span class="p">).</span><span class="nx">config</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">mongoose</span>
  <span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_URI</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'connected to database'</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_URI</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">'build'</span><span class="p">))</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">logger</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="nx">notesRouter</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3001</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tiedostossa siis otetaan käyttöön joukko middlewareja, näistä yksi on polkuun <em>/api/notes</em> kiinnitettävä <em>notesRouter</em> (tai notes-kontrolleri niin kuin jotkut sitä kutsuisivat).</p>

<p>Tietokannan yhteydenmuodostuksen suorittavaan funktioon on myös lisätty tapahtumankäsittelijä, joka ilmoittaa onko yhteyden muodostus onnistunut vai ei.</p>

<p>Middlewareista kaksi <em>middleware.logger</em> ja <em>middleware.error</em> on määritelty hakemiston <em>utils</em> tiedostossa <em>middleware.js</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Method:'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Path:  '</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Body:  '</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'---'</span><span class="p">)</span>
  <span class="nx">next</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'unknown endpoint'</span> <span class="p">})</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">logger</span><span class="p">,</span>
  <span class="nx">error</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tietokantayhteyden muodostaminen on nyt siirretty konfiguraatiot tekevän <em>index.js</em>:n vastuulle. Hakemistossa <em>models</em> oleva tiedosto <em>note.js</em> sisältää nyt ainoastaan muistiinpanojen skeeman määrittelyn.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Note</span>
</code></pre></div></div>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-1">githubissa</a>, tagissa <em>part4-1</em>:</p>

<p><img src="http://localhost:4000/master/4/1b.png" alt="" /></p>

<p>Jos kloonaat projektin itsellesi, suorita komento <em>npm install</em> ennen käynnistämistä eli komentoa <em>npm start</em>.</p>

<p>Express-sovelluksien rakenteelle, eli hakemistojen ja tiedostojen nimennälle ei ole olemassa mitään yleismaailmallista standardia samaan tapaan kuin esim. Ruby on Railsissa. Tässä käyttämämme malli noudattaa eräitä internetissä vastaan tulevia hyviä käytäntöjä.</p>

<h2 id="tehtäviä">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#sovelluksen-alustus-ja-rakenne">4.1 ja 4.2</a></p>

<h2 id="node-sovellusten-testaaminen">node-sovellusten testaaminen</h2>

<p>Olemme laiminlyöneet ikävästi yhtä oleellista ohjelmistokehityksen osa-aluetta, automatisoitua testaamista.</p>

<p>Aloitamme yksikkötestauksesta. Sovelluksemme logiikka on sen verran yksinkertaista, että siinä ei ole juurikaan mielekästä yksikkötestattavaa. Luodaan tiedosto <em>utils/for_testing.js</em> ja määritellään sinne pari yksinkertaista funktiota testattavaksi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">palindrom</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">average</span> <span class="o">=</span> <span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">reducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">item</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">reducer</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">palindrom</span><span class="p">,</span>
  <span class="nx">average</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Metodi <em>average</em> käyttää taulukoiden metodia <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce">reduce</a>. Jos metodi ei ole vieläkään tuttu, on korkea aika katsoa youtubesta <a href="https://www.youtube.com/watch?v=BMUiFMZr7vk&amp;list=PL0zVEGEvSaeEd9hlmCXrk5yUyqUag-n84">Functional Javascript</a> -sarjasta ainakin kolme ensimmäistä videoa.</p>
</blockquote>

<p>Javascriptiin on tarjolla runsaasti erilaisia testikirjastoja eli <em>test runnereita</em>. Käytämme tällä kurssilla Facebookin kehittämää ja sisäisesti käyttämää <a href="https://facebook.github.io/jest/">jest</a>:iä, joka on toiminnaltaan ja syntakstiltaankin hyvin samankaltainen kuin tämän hetken eniten käytetty testikirjasto <a href="https://mochajs.org/">Mocha</a>. Muitakin mahdollisuuksia olisi, esim. eräissä piireissä suosiota nopeasti saavuttanut <a href="https://github.com/avajs/ava">ava</a>.</p>

<p>Jest on tälle kurssille luonteva valinta, sillä se sopii hyvin backendien testaamiseen, mutta suorastaan loistaa Reactilla tehtyjen frontendien testauksessa.</p>

<blockquote>
  <p><em>Huomio Windows-käyttäjille:</em> jest ei välttämättä toimi, jos projektin hakemistopolulla on hakemisto, jonka nimessä on välilyöntejä.</p>
</blockquote>

<p>Koska testejä on tarkoitus suorittaa ainoastaan sovellusta kehitettäessä, asennetaan <em>jest</em> kehitysaikaiseksi riippuvuudeksi komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install <span class="nt">--save-dev</span> jest
</code></pre></div></div>

<p>määritellään <em>npm</em> skripti <em>test</em> suorittamaan testaus jestillä ja raportoimaan testien suorituksesta <em>verbose</em>-tyylillä:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  //...
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"start"</span>: <span class="s2">"node index.js"</span>,
    <span class="s2">"watch"</span>: <span class="s2">"nodemon index.js"</span>,
    <span class="s2">"lint"</span>: <span class="s2">"eslint ."</span>,
    <span class="s2">"test"</span>: <span class="s2">"jest --verbose"</span>
  <span class="o">}</span>,
  //...
<span class="o">}</span>
</code></pre></div></div>

<p>Tehdään testejä varten hakemisto <em>tests</em> ja sinne tiedosto <em>palindrom.test.js</em>, jonka sisältö on seuraava</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">palindrom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../utils/for_testing'</span><span class="p">).</span><span class="nx">palindrom</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'palindrom of a'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">palindrom</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'a'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'palindrom of react'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">palindrom</span><span class="p">(</span><span class="s1">'react'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'tcaer'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'palindrom of saippuakauppias'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">palindrom</span><span class="p">(</span><span class="s1">'saippuakauppias'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'saippuakauppias'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Edellisessä osassa käyttöön ottamamme ESlint valittaa testien käyttämistä komennoista <em>test</em> ja <em>expect</em> sillä käyttämämme konfiguraatio kieltää <em>globaalina</em> määriteltyjen asioiden käytön. Poistetaan valitus lisäämällä tiedostoon <em>.eslintrc.js</em> kenttä <em>globals</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"env"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"es6"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s2">"node"</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="s2">"extends"</span><span class="p">:</span> <span class="s2">"eslint:recommended"</span><span class="p">,</span>
    <span class="s2">"rules"</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">//...</span>
    <span class="p">},</span>
    <span class="s2">"globals"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"test"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s2">"expect"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s2">"describe"</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Testi ottaa ensimmäisellä rivillä käyttöön testattavan funktion sijoittaen sen muuttujaan <em>palindrom</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">palindrom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../utils/for_testing'</span><span class="p">).</span><span class="nx">palindrom</span>
</code></pre></div></div>

<p>Yksittäiset testitapaukset määritellään funktion <em>test</em> avulla. Ensimmäisenä parametrina on merkkijonomuotoinen testin kuvaus. Toisena parametrina on <em>funktio</em>, joka määrittelee testitapauksen toiminnallisuuden. Esim. toisen testitapauksen toiminnallisuus näyttää seuraavalta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">palindrom</span><span class="p">(</span><span class="s1">'react'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'tcaer'</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ensin suoritetaan testattava koodi, eli generoidaan merkkijonon <em>react</em> palindromi. Seuraavaksi varmistetaan tulos metodin <a href="https://facebook.github.io/jest/docs/en/expect.html#content">expect</a> avulla. Expect käärii tuloksena olevan arvon olioon, joka tarjoaa joukon <em>matcher</em>-funktioita, joiden avulla tuloksen oikeellisuutta voidaan tarkastella. Koska kyse on kahden merkkijonon samuuden vertailusta, sopii tilanteeseen matcheri <a href="https://facebook.github.io/jest/docs/en/expect.html#tobevalue">toBe</a>.</p>

<p>Kuten odotettua, testit menevät läpi:</p>

<p><img src="http://localhost:4000/assets/4/1.png" alt="" /></p>

<p>Jest olettaa oletusarvoisesti, että testitiedoston nimessä on merkkijono <em>.test</em>. Käytetään kurssilla konventiota, millä testitiedostojen nimen loppu on <em>.test.js</em></p>

<p>Jestin antamat virheilmoitukset ovat hyviä, rikotaan testi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="s1">'palindrom of react'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">palindrom</span><span class="p">(</span><span class="s1">'react'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'tkaer'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>seurauksena on seuraava virheilmotus</p>

<p><img src="http://localhost:4000/assets/4/2.png" alt="" /></p>

<p>Lisätään muutama testi metodille <em>average</em>, tiedostoon <em>tests/average.test.js</em>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">average</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../utils/for_testing'</span><span class="p">).</span><span class="nx">average</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'average'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'of one value is the value itself'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">average</span><span class="p">([</span><span class="mi">1</span><span class="p">])).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'of many is caclulated right'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">average</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">3.5</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'of empty array is zero'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">average</span><span class="p">([])).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>Testi paljastaa, että metodi toimii väärin tyhjällä taulukolla (sillä nollallajaon tulos on Javascriptissä <em>NaN</em>):</p>

<p><img src="http://localhost:4000/assets/4/3.png" alt="" /></p>

<p>Metodi on helppo korjata</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">average</span> <span class="o">=</span> <span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">reducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">item</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="nx">array</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">reducer</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Eli jos taulukon pituus on 0, palautetaan 0 ja muussa tapauksessa palautetaan metodin <em>reduce</em> avulla laskettu keskiarvo.</p>

<p>Pari huomiota keskiarvon testeistä. Määrittelimme testien ympärille nimellä <em>average</em> varustetun <em>describe</em>-lohkon.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'average'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// testit</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Describejen avulla yksittäisessä tiedostossa olevat testit voidaan jaotella loogisiin kokonaisuuksiin. Testituloste hyödyntää myös describe-lohkon nimeä:</p>

<p><img src="http://localhost:4000/assets/4/4.png" alt="" /></p>

<p>Kuten myöhemmin tulemme näkemään, <em>describe</em>-lohkot ovat tarpeellisia siinä vaiheessa, jos haluamme osalle yksittäisen testitiedoston testitapauksista jotain yhteisiä alustus- tai lopetustoimenpiteitä.</p>

<p>Toisena huomiona se, että kirjoitimme testit aavistuksen tiiviimmässä muodossa, ottamatta testattavan metodin tulosta erikseen apumuuttujaan:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">test</span><span class="p">(</span><span class="s1">'of empty array is zero'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">average</span><span class="p">([])).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></div></div>

<h2 id="tehtäviä-1">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#yksikkötestaus">4.3-4.7</a></p>

<h2 id="apin-testaaminen">API:n testaaminen</h2>

<p>Joissain tilanteissa voisi olla mielekästä suorittaa ainakin osa backendin testauksesta siten, että oikea tietokanta eristettäisiin testeistä ja korvattaisiin “valekomponentilla” eli mockilla. Eräs tähän sopiva ratkaisu olisi <a href="https://github.com/williamkapke/mongo-mock">mongo-mock</a>.</p>

<p>Koska sovelluksemme backend on koodiltaan kuitenkin suhteellisen yksinkertainen, päätämme testata sitä kokonaisuudessaan, siten että myös testeissä käytetään tietokantaa. Tämän kaltaisia, useita sovelluksen komponentteja yhtäaikaa käyttäviä testejä voi luonnehtia <a href="https://en.wikipedia.org/wiki/Integration_testing">integraatiotesteiksi</a>.</p>

<h3 id="test-ympäristö">test-ympäristö</h3>

<p>Edellisen osan luvussa <a href="/osa3#sovelluksen-vieminen tuotantoon">Sovelluksen vieminen tuotantoon</a> mainitsimme, että kun sovellusta suoritetaan Herokussa, on se <em>production</em>-moodissa.</p>

<p>Noden konventiona on määritellä projektin suoritusmoodi ympäristömuuttujan <em>NODE_ENV</em> avulla. Lataammekin sovelluksen nykyisessä versiossa tiedostossa <em>.env</em> määritellyt ympäristömuuttujat ainoastaan jos sovellus <em>ei ole</em> production moodissa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'dotenv'</span><span class="p">).</span><span class="nx">config</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Yleinen käytäntö on määritellä sovelluksille omat moodinsa myös sovelluskehitykseen ja testaukseen.</p>

<p>Määrtellään nyt tiedostossa <em>package.json</em>, että testejä suorittaessa sovelluksen <em>NODE_ENV</em> saa arvokseen <em>test</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  // ...
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"start"</span>: <span class="s2">"NODE_ENV=production node index.js"</span>,
    <span class="s2">"watch"</span>: <span class="s2">"NODE_ENV=development nodemon index.js"</span>,
    <span class="s2">"test"</span>: <span class="s2">"NODE_ENV=test jest --verbose"</span>,
    <span class="s2">"lint"</span>: <span class="s2">"eslint ."</span>
  <span class="o">}</span>,
  // ...
<span class="o">}</span>
</code></pre></div></div>

<p>Samalla määriteltiin, että suoritettaessa sovellusta komennolla <em>npm run watch</em> eli nodemonin avulla, on sovelluksen moodi <em>development</em>. Jos sovellusta suoritetaan normaalisti Nodella, on moodiksi määritelty <em>production</em>.</p>

<p>Määrittelyssämme on kuitenkin pieni ongelma, se ei toimi windowsilla. Tilanne korjautuu asentamalla kirjasto <a href="https://www.npmjs.com/package/cross-env">cross-env</a> komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install <span class="nt">--save-dev</span> cross-env
</code></pre></div></div>

<p>ja muuttamalla <em>package.js</em> kaikilla käyttöjärjestelmillä toimivaan muotoon</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  // ...
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"start"</span>: <span class="s2">"cross-env NODE_ENV=production node index.js"</span>,
    <span class="s2">"watch"</span>: <span class="s2">"cross-env NODE_ENV=development nodemon index.js"</span>,
    <span class="s2">"test"</span>: <span class="s2">"cross-env NODE_ENV=test jest --verbose"</span>,
    <span class="s2">"lint"</span>: <span class="s2">"eslint ."</span>
  <span class="o">}</span>,
  // ...
<span class="o">}</span>
</code></pre></div></div>

<p>Nyt sovelluksen toimintaa on mahdollista muokata sen suoritusmoodiin perustuen. Eli voimme määritellä, esim. että testejä suoritettaessa ohjelma käyttää erillistä, testejä varten luotua tietokantaa.</p>

<p>Sovelluksen testikanta voidaan luoda tuotantokäytön ja sovelluskehityksen tapaan <a href="https://mlab.com/">mlabiin</a>. Ratkaisu ei ole optimaalinen erityisesti, jos sovellusta on tekemässä yhtä aikaa useita henkilöitä. Testien suoritus nimittäin yleensä edellyttää, että samaa tietokantainstanssia ei ole yhtä aikaa käyttämässä useampia testiajoja.</p>

<p>Testaukseen kannattaakin käyttää verkossa olevaa jaettua tietokantaa mielummin esim. sovelluskehittäjän paikallisen koneen tietokantaa. Optimiratkaisu olisi tietysti se, että jokaista testiajoa varten olisi käytettävissä oma tietokanta, sekin periaatteessa onnistuu “suhteellisen helposti” mm. <a href="https://docs.mongodb.com/manual/core/inmemory/">keskusmuistissa toimivan Mongon</a> ja <a href="https://www.docker.com">docker</a>-kontainereiden avulla. Etenemme kuitenkin nyt lyhyemmän kaavan mukaan ja käytetään testikantana normaalia Mongoa.</p>

<p>Voisimme kirjoittaa ympäristökohtaiset konfiguraatiot, esim. oikean tietokannan valinnan suoraan tiedostoon <em>index.js</em>, se kuitenkin tekisi tiedoston koodista sekavan. Eristetään sovelluksen ympäristökohtainen konfigurointi omaan tiedostoon <em>utils/config.js</em> sijoitettavaan moduuliin.</p>

<p>Ideana on, että <em>index.js</em> voi käyttää konfiguraatioita seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./utils/config'</span><span class="p">)</span>

<span class="c1">// ...</span>

<span class="nx">mongoose</span>
  <span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">mongoUrl</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'connected to database'</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">mongoUrl</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">})</span>


<span class="c1">// ...</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span>
</code></pre></div></div>

<p>Konfiguraation suorittavan moduulin koodi on seuraavassa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'dotenv'</span><span class="p">).</span><span class="nx">config</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span>
<span class="kd">let</span> <span class="nx">mongoUrl</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_URI</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">'test'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TEST_PORT</span>
  <span class="nx">mongoUrl</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TEST_MONGODB_URI</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">mongoUrl</span><span class="p">,</span>
  <span class="nx">port</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Koodi lataa ympäristömuuttujat tiedostosta <em>.env</em> jos se <em>ei ole</em> tuotantomoodissa. Tuotantomoodissa käytetään Herokuun asetettuja ympäristömuuttujia.</p>

<p>Tiedostossa <em>.env</em> on nyt määritelty <em>erikseen</em> sekä sovelluskehitysympäristön ja testausympäristön tietokannan osoite (esimerkissä molemmat ovat sovelluskehityskoneen lokaaleja mongo-kantoja) ja portti:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">MONGODB_URI</span><span class="o">=</span>mongodb://fullstack:sekred@ds111078.mlab.com:11078/fullstact-notes-dev
<span class="nv">PORT</span><span class="o">=</span>3001

<span class="nv">TEST_PORT</span><span class="o">=</span>3002
<span class="nv">TEST_MONGODB_URI</span><span class="o">=</span>mongodb://fullstack:sekred@ds113098.mlab.com:13098/fullstack-notes-test
</code></pre></div></div>

<p>Eri porttien käyttö mahdollistaa sen, että sovellus voi olla käynnissä testien suorituksen aikana.</p>

<p>Omatekemämme eri ympäristöjen konfiguroinnista huolehtivaa <em>config</em>-moduuli toimii hieman samassa hengessä kuin <a href="https://github.com/lorenwest/node-config">node-config</a>-kirjasto. Omatekemä konfigurointiympäristö sopii tarkoitukseemme, sillä sovellus on yksinkertainen ja oman konfiguraatio-moduulin tekeminen on myös jossain määrin opettavaista. Isommissa sovelluksissa kannattaa harkita valmiiden kirjastojen, kuten <a href="https://github.com/lorenwest/node-config">node-config</a>:in käyttöä.</p>

<p>Tiedosto <em>index.js</em> muutetaan nyt muotoon:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cors'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">middleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./utils/middleware'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">notesRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./controllers/notes'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./utils/config'</span><span class="p">)</span>

<span class="nx">mongoose</span>
  <span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">mongoUrl</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'connected to database'</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">mongoUrl</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">'build'</span><span class="p">))</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">logger</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="nx">notesRouter</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running on port </span><span class="p">${</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'close'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">,</span> <span class="nx">server</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p><strong>HUOM</strong>: koska käytämme useimpia kirjastoja koodissa vain kerran, olisi mahdollista tiivistää koodia hiukan kirjoittamalla esim. <code>app.use(cors())</code> sijaan <code>app.use(require('cors')())</code> ja jättää apumuuttuja <em>cors</em> kokonaan määrittelemättä. On kuitenkin epäselvää kannattaako tälläiseen koodirivien säästelyyn lähteä. Ei ainakaan silloin jos koodin ymmärrettävyys kärsisi.</p>
</blockquote>

<p>Tiedoston lopussa on muutama tärkeä muutos.</p>

<p>Sovelluksen käynnistäminen tapahtuu nyt <em>server</em>-muuttujassa olevan olion kautta. Serverille määritellään tapahtumankäsitteljäfunktio tapahtumalle <em>close</em> eli tilanteeseen, missä sovellus sammutetaan. Tapahtumankäsittelijä sulkee tietokantayhteyden.</p>

<p>Sekä sovellus <em>app</em> että sitä suorittava <em>server</em>-olio määritellään eksportattavaksi tiedostosta. Tämä mahdollistaa sen, että testit voivat käynnistää ja sammuttaa backendin.</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-2">githubissa</a>, tagissa <em>part4-2</em>.</p>

<h3 id="supertest">supertest</h3>

<p>Käytetään API:n testaamiseen Jestin apuna <a href="https://github.com/visionmedia/supertest">supertest</a>-kirjastoa.</p>

<p>Kirjasto asennetaan kehitysaikaiseksi riippuvuudeksi komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install <span class="nt">--save-dev</span> supertest
</code></pre></div></div>

<p>Luodaan heti ensimmäinen testi tiedostoon <em>tests/note_api.test.js:</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">supertest</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'supertest'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">server</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../index'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">supertest</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'notes are returned as json'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">afterAll</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Toisella rivillä testi käynnistää backendin ja käärii sen kolmannella rivillä funktion <em>supertest</em> avulla ns. <a href="https://github.com/visionmedia/superagent">superagent</a>-olioksi. Tämä olio sijoitetaan muuttujaan <em>api</em> ja sen kautta testit voivat tehdä HTTP-pyyntöjä backendiin.</p>

<p>Testimetodi tekee HTTP GET -pyynnön osoitteeseen <em>api/notes</em> ja varmistaa, että pyyntöön vastataan statuskoodilla 200 ja että data palautetaan oikeassa muodossa, eli että <em>Content-Type</em>:n arvo on <em>application/json</em>.</p>

<p>Testissä on muutama detalji joihin tutustumme vasta <a href="#async-await">hieman myöhemmin</a> tässä osassa. Testikoodin määrittelevä nuolifunktio alkaa sanalla <em>async</em> ja <em>api</em>-oliolle tehtyä metodikutsua edeltää sama <em>await</em>. Teemme ensin muutamia testejä ja tutustumme sen jälkeen async/await-magiaan. Tällä hetkellä niistä ei tarvitse välittää, kaikki toimii kun kirjoitat testimetodit esimerkin mukaan. Async/await-syntaksin käyttö liittyy siihen, että palvelimelle tehtävät pyynnöt ovat <em>asynkronisia</em> operaatioita. <a href="https://facebook.github.io/jest/docs/en/asynchronous.html">Async/await-kikalla</a> saamme pyynnön näyttämään koodin tasolla synkroonisesti toimivalta.</p>

<p>Huom! Jos eslint herjaa async -syntaksista, niin saat ongelman korjattua lisäämällä seuraavan <code class="highlighter-rouge">.eslintrc</code> tiedostoon</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module.exports = {
  //...
  "parserOptions": {
    "ecmaVersion": 2017
  }
}
</code></pre></div></div>

<p>Kaikkien testien (joita siis tällä kertaa on vain yksi) päätteeksi on vielä lopputoimenpiteenä pyydettävä backendia suorittava <em>server</em>-olio sammuttamaan itsensä. Tämä onnistuu helposti metodissa <a href="https://facebook.github.io/jest/docs/en/api.html#afterallfn-timeout">afterAll</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">afterAll</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<p>HTTP-pyyntöjen tiedot loggaava middleware <em>logger</em> häiritsee hiukan testien tulostusta. Jos haluat hiljentää sen testien suorituksen ajaksi, muuta funktiota esim. seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">'test'</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Method:'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Path:  '</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Body:  '</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'---'</span><span class="p">)</span>
  <span class="nx">next</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tehdään pari testiä lisää:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="s1">'there are five notes'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'the first note is about HTTP methods'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">content</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'HTML on helppoa'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Molemmat testit sijoittavat pyynnön vastauksen muuttujaan <em>response</em> ja toisin kuin edellinen testi, joka käytti <em>supertestin</em> mekanismeja statuskoodin ja vastauksen headereiden oikeellisuuden varmistamiseen, tällä kertaa tutkitaan vastauksessa olevan datan, eli <em>response.body</em>:n oikeellisuutta Jestin <a href="https://facebook.github.io/jest/docs/en/expect.html#content">expect</a>:in avulla.</p>

<p>Async/await-kikan hyödyt tulevat nyt selkeästi esiin. Normaalisti tarvitsisimme asynkronisten pyyntöjen vastauksiin käsille pääsemiseen promiseja ja takaisinkutsuja, mutta nyt kaikki menee mukavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
  <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

<span class="c1">// tänne tullaan vasta kun edellinen komento eli HTTP-pyyntö on suoritettu</span>
<span class="c1">// muuttujassa res on nyt HTTP-pyynnön tulos</span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p>Testit menevät läpi. Testit ovat kuitenkin huonoja, niiden läpimeno riippuu tietokannan tilasta (joka sattuu omassa testikannassani olemaan sopiva). Jotta saisimme robustimmat testit, tulee tietokannan tila nollata testien alussa ja sen jälkeen laittaa kantaan hallitusti testien tarvitsema data.</p>

<h3 id="error-listen-eaddrinuse-3002">Error: listen EADDRINUSE :::3002</h3>

<p>Jos jotain patologista tapahtuu voi käydä niin, että testien suorittama palvelin jää päälle. Tällöin uusi testiajo aiheuttaa ongelmia, ja seurauksena on virheilmoitus</p>

<pre>
Error: listen EADDRINUSE :::3002
</pre>

<p>Ratkaisu tilanteeseen on tappaa palvelinta suorittava prosessi. Portin 3002 varaava prosessi löytyy OSX:lla ja Linuxilla esim. komennolla <code>lsof -i :3002</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COMMAND  PID     USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
node    8318 mluukkai   14u  IPv6 0x5428af4833b85e8b      0t0  TCP <span class="k">*</span>:redwood-broker <span class="o">(</span>LISTEN<span class="o">)</span>
</code></pre></div></div>

<p>Windowsissa portin varaavan prosessin näkee resmon.exe:n Verkko-välilehdeltä.</p>

<p>Komennon avulla selviää ikävyyksiä aiheuttavan prosesin PID eli prosessi-id. Prosessin saa tapettua komennolla <code>KILL 8318</code> olettaen että PID on 8318 niin kuin kuvassa. Joskus prosessi on sitkeä eikä kuole ennen kuin se tapetaan komennolla <code>KILL -9 8318</code>.</p>

<p>Windowsissa vastaava komento on <code>taskkill /f /pid 8318</code>.</p>

<h2 id="tietokannan-alustaminen-ennen-testejä">Tietokannan alustaminen ennen testejä</h2>

<p>Testimme käyttää jo jestin metodia <a href="https://facebook.github.io/jest/docs/en/api.html#afterallfn-timeout">afterAll</a> sulkemaan backendin testien suoritusten jälkeen. Jest tarjoaa joukon muitakin <a href="https://facebook.github.io/jest/docs/en/setup-teardown.html#content">funktioita</a>, joiden avulla voidaan suorittaa operaatioita ennen yhdenkään testin suorittamista tai ennen jokaisen testin suoritusta.</p>

<p>Päätetään alustaa tietokanta ennen kaikkien testin suoritusta, eli funktiossa <a href="https://facebook.github.io/jest/docs/en/api.html#beforeallfn-timeout">beforeAll</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">supertest</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'supertest'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span><span class="nx">app</span><span class="p">,</span> <span class="nx">server</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../index'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">supertest</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/note'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">initialNotes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">remove</span><span class="p">({})</span>

  <span class="kd">let</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">initialNotes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="kr">await</span> <span class="nx">noteObject</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

  <span class="nx">noteObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">initialNotes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="kr">await</span> <span class="nx">noteObject</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tietokanta siis tyhjennetään aluksi ja sen jälkeen kantaan lisätään kaksi taulukkoon <em>initialNotes</em> talletettua muistiinpanoa. Näin testien suoritus aloitetaan aina hallitusti samasta tilasta.</p>

<p>Muutetaan kahta jälkimmäistä testiä vielä seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="s1">'all notes are returned'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialNotes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'a specific note is within the returned notes'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">contents</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Huomaa jälkimmäisen testin ekspektaatio. Komennolla <code>response.body.map(r =&gt; r.content)</code> muodostetaan taulukko API:n palauttamien muistiinpanojen sisällöistä. Jestin <a href="https://facebook.github.io/jest/docs/en/expect.html#tocontainitem">toContain</a>-ekspektaatiometodilla tarkistetaan että parametrina oleva muistiinpano on kaikkien API:n palauttamien muistiinpanojen joukossa.</p>

<p>Ennen kun teemme lisää testejä, tarkastellaan tarkemmin mitä <em>async</em> ja <em>await</em> tarkoittavat.</p>

<h2 id="async-await">async-await</h2>

<p>Async- ja await ovat ES7:n mukanaan tuoma uusi syntaksi, joka mahdollistaa <em>promisen palauttavien asynkronisten funktioiden</em> kutsumisen siten, että kirjoitettava koodi näyttää synkroniselta.</p>

<p>Esim. muistiinpanojen hakeminen tietokannasta hoidetaan promisejen avulla seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Note</span>
  <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'operaatio palautti seuraavat muistiinpanot'</span><span class="p">,</span> <span class="nx">notes</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Metodikutsu <em>Note.find()</em> palauttaa promisen, ja saamme itse operaation tuloksen rekisteröimällä promiselle tapahtumankäsittelijän metodilla <em>then</em>.</p>

<p>Kaikki operaation suorituksen jälkeinen koodi kirjoitetaan tapahtumankäsittelijään. Jos haluaisimme tehdä peräkkäin useita asynkronisia funktiokutsuja, menisi tilanne ikävämmäksi. Joutuisimme tekemään kutsut tapahtumankäsittelijästä. Näin syntyisi potentiaalisesti monimutkaista koodia, pahimmassa tapauksessa jopa niin sanottu <a href="http://callbackhell.com/">callback-helvetti</a>.</p>

<p><a href="https://javascript.info/promise-chaining">Ketjuttamalla promiseja</a> tilanne pysyy jollain tavalla hallinnassa, callback-helvetin eli monien sisäkkäisten callbackien sijaan saadaan aikaan siistihkö <em>then</em>-kutsujen ketju. Olemmekin nähneet jo kurssin aikana muutaman sellaisen. Seuraavassa vielä erittäin keinotekoinen esimerkki, joka hakee ensin kaikki muistiinpanot ja sitten tuhoaa niistä ensimmäisen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Note</span>
  <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">remove</span><span class="p">()</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the first note is removed'</span><span class="p">)</span>
    <span class="c1">// more code here</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Then-ketju on ok, mutta parempaankin pystytään. Jo ES6:ssa esitellyt <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator">generaattorifunktiot</a> mahdollistivat <a href="https://github.com/getify/You-Dont-Know-JS/blob/master/async%20%26%20performance/ch4.md#iterating-generators-asynchronously">ovelan tavan</a> määritellä asynkronista koodia siten että se “näyttää synkroniselta”. Syntaksi ei kuitenkaan ole täysin luonteva ja sitä ei käytetä kovin yleisesti.</p>

<p>ES7:ssa <em>async</em> ja <em>await</em> tuovat generaattoreiden tarjoaman toiminnallisuuden ymmärrettävästi ja syntaksin puolesta selkeällä tavalla koko Javascript-kansan ulottuville.</p>

<p>Voisimme hakea tietokannasta kaikki muistiinpanot <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">await</a>-operaattoria hyödyntäen seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'operaatio palautti seuraavat muistiinpanot '</span><span class="p">,</span> <span class="nx">notes</span><span class="p">)</span>
</code></pre></div></div>

<p>Koodi siis näyttää täsmälleen synkroniselta koodilta. Suoritettavan koodinpätkän suhteen tilanne on se, että suoritus pysähtyy komentoon <code>const notes = await Note.find({})</code> ja jatkuu kyselyä vastaavan promisen <em>fulfillmentin</em> eli onnistuneen suorituksen jälkeen seuraavalta riviltä. Kun suoritus jatkuu, promisea vastaavan operaation tulos on muuttujassa <em>notes</em>.</p>

<p>Ylempänä oleva monimutkaisempi esimerkki suoritettaisiin awaitin avulla seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
<span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">remove</span><span class="p">()</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the first note is removed'</span><span class="p">)</span>
</code></pre></div></div>

<p>Koodi siis yksinkertaistuu huomattavasti verrattuna promiseja käyttävään then-ketjuun.</p>

<p>Awaitin käyttöön liittyy parikin tärkeää seikkaa. Jotta asynkronisia operaatioita voi kutsua awaitin avulla, niiden täytyy olla promiseja. Tämä ei sinänsä ole ongelma, sillä myös “normaaleja” callbackeja käyttävä asynkroninen koodi on helppo kääriä promiseksi.</p>

<p>Mistä tahansa kohtaa Javascript-koodia ei awaitia kuitenkaan pysty käyttämään. Awaitin käyttö onnistuu ainoastaan jos ollaan <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_functio">async</a>-funktiossa.</p>

<p>Eli jotta edelliset esimerkit toimisivat, on ne suoritettava async-funktioiden sisällä, huomaa funktion määrittelevä rivi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'operaatio palautti seuraavat muistiinpanot'</span><span class="p">,</span> <span class="nx">notes</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">remove</span><span class="p">()</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'the first note is removed'</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Koodi määrittelee ensin asynkronisen funktion, joka sijoitetaan muuttujaan <em>main</em>. Määrittelyn jälkeen koodi kutsuu metodia komennolla <code>main()</code></p>

<h3 id="testin-beforeall-metodin-optimointi">testin beforeAll-metodin optimointi</h3>

<p>Palataan takaisin testien pariin, ja tarkastellaan määrittelemäämme testit alustavaa funktiota <em>beforeAll</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">initialNotes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">remove</span><span class="p">({})</span>

  <span class="kd">let</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">initialNotes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="kr">await</span> <span class="nx">noteObject</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

  <span class="nx">noteObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">initialNotes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="kr">await</span> <span class="nx">noteObject</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Funktio tallettaa tietokantaan taulukon <em>initialNotes</em> nollannen ja ensimmäisen alkion, kummankin erikseen taulukon alkioita indeksöiden. Ratkaisu on ok, mutta jos haluaisimme tallettaa alustuksen yhteydessä kantaan useampia alkioita, olisi toisto parempi ratkaisu:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">remove</span><span class="p">({})</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'cleared'</span><span class="p">)</span>

  <span class="nx">initialNotes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
    <span class="kr">await</span> <span class="nx">noteObject</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'saved'</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'notes are returned as json'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'entered test'</span><span class="p">)</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Talletamme siis taulukossa <em>initialNotes</em> määritellyt muistiinpanot tietokantaan <em>forEach</em>-loopissa. Testeissä kuitenkin ilmenee jotain häikkää, ja sitä varten koodin sisään on lisätty aputulosteita.</p>

<p>Konsoliin tulostuu</p>

<pre>
cleared
done
entered test
saved
saved
</pre>

<p>Yllättäen ratkaisu ei async/awaitista huolimatta toimi niin kuin oletamme, testin suoritus aloitetaan ennen kun tietokannan tila on saatu alustettua!</p>

<p>Ongelma on siinä, että jokainen forEach-loopin läpikäynti generoi oman asynkronisen operaation ja <em>beforeAll</em> ei odota näiden suoritusta. Eli forEach:in sisällä olevat <em>await</em>-komennot eivät ole funktiossa <em>beforeAll</em> vaan erillisissä funktioissa joiden päättymistä <em>beforeAll</em> ei odota.</p>

<p>Koska testien suoritus alkaa heti <em>beforeAll</em> metodin suorituksen jälkeen, testien suoritus ehditään jo aloittaa ennen kuin tietokanta on alustettu toivottuun alkutilaan.</p>

<p>Toimiva ratkaisu tilanteessa on odottaa asynkronisten talletusoperaatioiden valmistumista <em>beforeAll</em>-funktiossa, esim. metodin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all</a> avulla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">remove</span><span class="p">({})</span>

  <span class="kd">const</span> <span class="nx">noteObjects</span> <span class="o">=</span> <span class="nx">initialNotes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
  <span class="kd">const</span> <span class="nx">promiseArray</span> <span class="o">=</span> <span class="nx">noteObjects</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">save</span><span class="p">())</span>
  <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promiseArray</span><span class="p">)</span>
<span class="p">})</span>

</code></pre></div></div>

<p>Ratkaisu on varmasti aloittelijalle tiiviydestään huolimatta hieman haastava. Taulukkoon <em>noteObjects</em> talletetaan taulukkoon <em>initialNotes</em> talletettuja Javascript-oliota vastaavat <em>Note</em>-konstruktorifunktiolla generoidut Mongoose-oliot. Seuraavalla rivillä luodaan uusi taulukko, joka <em>muodostuu promiseista</em>, jotka saadaan kun jokaiselle <em>noteObjects</em> taulukon alkiolle kutsutaan metodia <em>save</em>, eli ne talletetaan kantaan.</p>

<p>Metodin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all</a> avulla saadaan koostettua taulukollinen promiseja yhdeksi promiseksi, joka valmistuu, eli menee tilaan <em>fulfilled</em> kun kaikki sen parametrina olevan taulukon promiset ovat valmistuneet.
Siispä viimeinen rivi, <code>await Promise.all(promiseArray)</code> odottaa, että kaikki tietokantaan talletetusta vastaavat promiset ovat valmiina, eli alkiot on talletettu tietokantaan.</p>

<blockquote>
  <p>Promise.all-metodia käyttäessä päästään tarvittaessa käsiksi sen parametrina olevien yksittäisten promisejen arvoihin, eli promiseja vastaavien operaatioiden tuloksiin. Jos odotetaan promisejen valmistumista <em>await</em>-syntaksilla <code>const results = await Promise.all(promiseArray)</code> palauttaa operaatio taulukon, jonka alkioina on <em>promiseArray</em>:n promiseja vastaavat arvot samassa järjestyksessä kuin promiset ovat taulukossa.</p>
</blockquote>

<p>Promise.all suorittaa kaikkia syötteenä saamiaan promiseja rinnakkain. Jos operaatioiden suoritusjärjestyksellä on merkitystä, voi tämä aiheuttaa ongelmia. Tällöin asynkroniset operaatiot on mahdollista määrittää <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...of">for…of</a> lohkon sisällä, jonka suoritusjärjestys on taattu.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">remove</span><span class="p">({})</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">note</span> <span class="k">of</span> <span class="nx">initialNotes</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
    <span class="kr">await</span> <span class="nx">noteObject</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Javascriptin asynkroninen suoritusmalli aiheuttaakin siis helposti yllätyksiä ja myös async/await-syntaksin kanssa pitää olla koko ajan tarkkana. Vaikka async/await peittää monia promisejen käsittelyyn liittyviä seikkoja, promisejen toiminta on syytä tuntea mahdollisimman hyvin!</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-3">githubissa</a>, tagissa <em>part4-3</em>.</p>

<h3 id="asyncawait-backendissä">async/await backendissä</h3>

<p>Muutetaan nyt backend käyttämään asyncia ja awaitia. Koska kaikki asynkroniset operaatiot tehdään joka tapauksessa funktioiden sisällä, awaitin käyttämiseen riittää, että muutamme routejen käsittelijät async-funktioiksi.</p>

<p>Kaikkien muistiinpanojen hakemisesta vastaava route muuttuu seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Voimme varmistaa refaktoroinnin onnistumisen selaimella, sekä suorittamalla juuri määrittelemämme testit.</p>

<h3 id="eslint-ja-asyncawait-nuolifunktioissa">ESlint ja async/await nuolifunktioissa</h3>

<p>Ennen testejä tehdään pieni täsmennyt ESlint-konfiguraatioon. Tällä hetkellä ESlint valittaa <em>async</em>-määreellä varustetuista nuolifunktioista:</p>

<p><img src="http://localhost:4000/images/4/4b.png" alt="" /></p>

<p>kyse on siitä, että ESlint ei vielä osaa tulkita uutta syntaksia kunnolla. Pääsemme valituksesta eroon asentamalla <em>babel-eslint</em>-pluginin:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install babel-eslint <span class="nt">--save-dev</span>
</code></pre></div></div>

<p>Pluginin käyttöönotto tulee määritellä tiedostossa <em>.eslintrc.js</em> :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module.exports <span class="o">=</span> <span class="o">{</span>
  <span class="s2">"env"</span>: <span class="o">{</span>
    <span class="s2">"node"</span>: <span class="nb">true</span>,
    <span class="s2">"es6"</span>: <span class="nb">true</span>
  <span class="o">}</span>,
  <span class="s2">"parser"</span>: <span class="s2">"babel-eslint"</span>,
  // ...
<span class="o">}</span>
</code></pre></div></div>

<p>Aiheeton valitus poistuu.</p>

<h3 id="testejä-ja-backendin-refaktorointia">Testejä ja backendin refaktorointia</h3>

<p>Koodia refaktoroidessa vaanii aina <a href="https://en.wikipedia.org/wiki/Regression_testing">regression</a> vaara, eli on olemassa riski, että jo toimineet ominaisuudet hajoavat. Tehdäänkin muiden operaatioiden refaktorointi siten, että ennen koodin muutosta tehdään jokaiselle API:n routelle sen toiminnallisuuden varmistavat testit.</p>

<p>Aloitetaan lisäysoperaatiosta. Tehdään testi, joka lisää uuden muistiinpanon ja tarkistaa, että API:n palauttamien muistiinpanojen määrä kasvaa, ja että lisätty muistiinpano on palautettujen joukossa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="s1">'a valid note can be added '</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newNote</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'async/await yksinkertaistaa asynkronisten funktioiden kutsua'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newNote</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">initialNotes</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">contents</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'async/await yksinkertaistaa asynkronisten funktioiden kutsua'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Kuten odotimme ja toivoimme, menee testi läpi.</p>

<p>Tehdään myös testi, joka varmistaa, että muistiinpanoa, jolle ei ole asetettu sisältöä, ei talleteta</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="s1">'note without content is not added '</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newNote</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">intialNotes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newNote</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">intialNotes</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Testi ei mene läpi.</p>

<p>Käy ilmi, että myös operaation suoritus postman tai Visual Studio Coden REST clientillä johtaa virhetilanteeseen. Koodissa on siis bugi.</p>

<blockquote>
  <p><strong>Huom:</strong> testejä tehdessä täytyy aina varmistua siitä, että testi testaa oikeaa asiaa, ja usein ensimmäistä kertaa testiä tehdessä se että testi ei mene läpi tarkoittaa sitä, että testi on tehty väärin. Myös päinvastaista tapahtuu, eli testi menee läpi mutta koodissa onkin virhe, eli testi ei testaa sitä mitä sen piti testata. Tämän takia testit kannattaa aina “testata” rikkomalla koodi ja varmistamalla, että testi huomaa koodiin tehdyt virheet.</p>
</blockquote>

<p>Kun suoritamme operaation postmanilla konsoli paljastaa, että kyseessä on <em>Unhandled promise rejection</em>, eli koodi ei käsittele promisen virhetilannetta:</p>

<pre>
Server running on port 3001
Method: POST
Path:   /api/notes/
Body:   { important: true }
---
(node:28657) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): Error: Can't set headers after they are sent.
(node:28657) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.
</pre>

<p>Kuten jo edellisessä osassa mainittiin, tämä ei ole hyvä idea. Kannattaakin aloittaa lisäämällä promise-ketjuun metodilla <em>catch</em> virheenkäisttelijä, joka tulostaa konsoliin virheen syyn:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">note</span>
    <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">formattedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formattedNote</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'something went wrong...'</span> <span class="p">})</span>
    <span class="p">})</span>
</code></pre></div></div>

<p>Konsoliin tulostuu seuraava virheilmoitus</p>

<pre>
Error: Can't set headers after they are sent.
    at validateHeader (_http_outgoing.js:489:11)
    at ServerResponse.setHeader (_http_outgoing.js:496:3)
</pre>

<p>Aloittelijalle virheilmoitus ei välttämättä kerro paljoa, mutta googlaamalla virheilmoituksella, pieni etsiminen tuottaisi jo tuloksen.</p>

<p>Kyse on siitä, että koodi kutsuu <em>response</em>-olion metodia <em>send</em> kaksi kertaa, tai oikeastaan koodi kutsuu metodia <em>json</em>, joka kutsuu edelleen metodia <em>send</em>.</p>

<p>Kaksi kertaa tapahtuva <em>send</em>-kutsu johtuu siitä, että koodin alun <em>if</em>-lauseessa on ongelma:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span> <span class="p">})</span>
    <span class="c1">// suoritus jatkuu!</span>
  <span class="p">}</span>

  <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>kun koodi kutsuu <code>response.status(400).json(...)</code> suoritus jatkaa koodin alla olevaa osaan ja se taas aiheuttaa uuden <code>response.json()</code>-kutsun.</p>

<p>Korjataan ongelma lisäämällä <em>if</em>-lauseeseen <em>return</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Edellisen osan lopussa koodi oli vielä oikein, mutta siirtäessämme osan alussa koodia tiedostosta <em>index.js</em> uuteen paikkaan, on <em>return</em> kadonnut matkalta.</p>

<p>Promiseja käyttävä koodi toimii nyt ja testitkin menevät läpi. Olemme valmiit muuttamaan koodin käyttämään async/await-syntaksia.</p>

<p>Koodi muuttuu seuraavasti (huomaa, että käsittelijän alkuun on laitettava määre <em>async</em>):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="kc">false</span> <span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="kd">const</span> <span class="nx">savedNote</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">note</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Koodiin jää kuitenkin pieni ongelma: virhetilanteita ei nyt käsitellä ollenkaan. Miten niiden suhteen tulisi toimia?</p>

<h3 id="virheiden-käsittely-ja-asyncawait">virheiden käsittely ja async/await</h3>

<p>Jos sovellus POST-pyyntöä käsitellessään aiheuttaa jonkinlaisen ajonaikaisen virheen, syntyy jälleen tuttu tilanne:</p>

<pre>
(node:30644) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): TypeError: formattedNote.nonexistingMethod is not a function
</pre>

<p>eli käsittelemätön promisen rejektoituminen. Pyyntöön ei vastata tilanteessa mitenkään.</p>

<p>Async/awaitia käyttäessä kannattaa käyttää vanhaa kunnon <em>try/catch</em>-mekanismia virheiden käsittelyyn:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
      <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
      <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="kc">false</span> <span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
      <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="kd">const</span> <span class="nx">savedNote</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">note</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'something went wrong...'</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Iso try/catch tuo koodiin hieman ikävän vivahteen, mutta mikään ei ole ilmaista.</p>

<p>Tehdään sitten testit yksittäisen muistiinpanon tietojen katsomiselle ja muistiinpanon poistolle:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="s1">'a specific note can be viewed'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">resultAll</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">aNoteFromAll</span> <span class="o">=</span> <span class="nx">resultAll</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="kd">const</span> <span class="nx">resultNote</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/api/notes/</span><span class="p">${</span><span class="nx">aNoteFromAll</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="nx">resultNote</span><span class="p">.</span><span class="nx">body</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">noteObject</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">aNoteFromAll</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">'a note can be deleted'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newNote</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP DELETE poistaa resurssin'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">addedNote</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newNote</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">notesAtBeginningOfOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/api/notes/</span><span class="p">${</span><span class="nx">addedNote</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">notesAfterDelete</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">notesAfterDelete</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">contents</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'HTTP DELETE poistaa resurssin'</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">notesAfterDelete</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">notesAtBeginningOfOperation</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Testit eivät tässä vaiheessa ole optimaaliset, parannetaan niitä kohta. Ensin kuitenkin refaktoroidaan backend käyttämään async/awaitia.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/:id'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">}</span>

  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/:id'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">findByIdAndRemove</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">204</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Async/await ehkä selkeyttää koodia jossain määrin, mutta saavutettava hyöty ei ole sovelluksessamme vielä niin iso mitä se tulee olemaan jos asynkronisia kutsuja on tehtävä useampia.</p>

<p>Kaikki eivät kuitenkaan ole vakuuttuneita siitä, että async/await on hyvä lisä Javascriptiin, lue esim. <a href="https://spion.github.io/posts/es7-async-await-step-in-the-wrong-direction.html">ES7 async functions - a step in the wrong direction</a></p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-4">githubissa</a>, tagissa <em>part4-4</em>. Samassa on “vahingossa” mukana testeistä seuraavan luvun jälkeinen paranneltu versio.</p>

<h3 id="varoitus">Varoitus</h3>

<p>Jos huomaat kirjoittavasi sekaisin async/awaitia ja <em>then</em>-kutsuja, on 99% varmaa, että teet jotain väärin. Käytä siis jompaa kumpaa tapaa, älä missään tapauksessa “varalta” molempia.</p>

<h2 id="tehtäviä-2">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#api:n-testaaminen">4.8-4.11</a></p>

<h2 id="testien-refaktorointi">Testien refaktorointi</h2>

<p>Testimme sisältävät tällä hetkellä jossain määrin toisteisuutta ja niiden rakenne ei ole optimaalinen. Testit ovat myös osittain epätäydelliset, esim. reittejä GET /api/notes/:id ja DELETE /api/notes/:id ei tällä hetkellä testata epävalidien id:iden osalta.</p>

<p>Testeissä on myös eräs hieman ikävä ja jopa riskialtis piirre. Testit luottavat siihen, että ne suoritetaan siinä järjestyksessä, missä ne on kirjoitettu testitiedostoon. Tämä pitää kyllä paikkansa, vaikkakin se ei ole kovin selkeästi määritelty ominaisuus eli siihen ei ole hyvä luottaa. Testit tuleekin kirjoittaa siten, että yksittäiset testit ovat riippumattoimia toistensa suorituksesta.</p>

<p>Parannellaan testejä hiukan.</p>

<p>Tehdään testejä varten muutama apufunktio moduuliin <em>tests/test_helper.js</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/note'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">initialNotes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="kd">const</span> <span class="nx">format</span> <span class="o">=</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">nonExistingId</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">()</span>
  <span class="kr">await</span> <span class="nx">note</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
  <span class="kr">await</span> <span class="nx">note</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>

  <span class="k">return</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">notesInDb</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="k">return</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">format</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">initialNotes</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">nonExistingId</span><span class="p">,</span> <span class="nx">notesInDb</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tärkein apufunktioista on <em>notesInDb</em> joka palauttaa kaikki tietokannassa kutsuhetkellä olevat oliot.</p>

<p>Jossain määrin parannellut testit seuraavassa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">supertest</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'supertest'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">server</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../index'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">supertest</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/note'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">initialNotes</span><span class="p">,</span> <span class="nx">nonExistingId</span><span class="p">,</span> <span class="nx">notesInDb</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./test_helper'</span><span class="p">)</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'when there is initially some notes saved'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nx">Note</span><span class="p">.</span><span class="nx">remove</span><span class="p">({})</span>

    <span class="kd">const</span> <span class="nx">noteObjects</span> <span class="o">=</span> <span class="nx">initialNotes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>
    <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">noteObjects</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">save</span><span class="p">()))</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'all notes are returned as json by GET /api/notes'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">notesInDatabase</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>

    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">notesInDatabase</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">returnedContents</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
    <span class="nx">notesInDatabase</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">returnedContents</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'individual notes are returned as json by GET /api/notes/:id'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">notesInDatabase</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">aNote</span> <span class="o">=</span> <span class="nx">notesInDatabase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/api/notes/</span><span class="p">${</span><span class="nx">aNote</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">aNote</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'404 returned by GET /api/notes/:id with nonexisting valid id'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">validNonexistingId</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">nonExistingId</span><span class="p">()</span>

    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/api/notes/</span><span class="p">${</span><span class="nx">validNonexistingId</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'400 is returned by GET /api/notes/:id with invalid id'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">invalidId</span> <span class="o">=</span> <span class="s2">"5a3d5da59070081a82a3445"</span>

    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/api/notes/</span><span class="p">${</span><span class="nx">invalidId</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">'addition of a new note'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="nx">test</span><span class="p">(</span><span class="s1">'POST /api/notes succeeds with valid data'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">notesAtStart</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>

      <span class="kd">const</span> <span class="nx">newNote</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="s1">'async/await yksinkertaistaa asynkronisten funktioiden kutsua'</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>

      <span class="kr">await</span> <span class="nx">api</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newNote</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>

      <span class="kd">const</span> <span class="nx">notesAfterOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">notesAtStart</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

      <span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">contents</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'async/await yksinkertaistaa asynkronisten funktioiden kutsua'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="s1">'POST /api/notes fails with proper statuscode if content is missing'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">newNote</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>

      <span class="kd">const</span> <span class="nx">notesAtStart</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>

      <span class="kr">await</span> <span class="nx">api</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newNote</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>

      <span class="kd">const</span> <span class="nx">notesAfterOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>

      <span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">notesAtStart</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">'deletion of a note'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">addedNote</span>

    <span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">addedNote</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
        <span class="na">content</span><span class="p">:</span> <span class="s1">'poisto pyynnöllä HTTP DELETE'</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">})</span>
      <span class="kr">await</span> <span class="nx">addedNote</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="s1">'DELETE /api/notes/:id succeeds with proper statuscode'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">notesAtStart</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>

      <span class="kr">await</span> <span class="nx">api</span>
        <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/api/notes/</span><span class="p">${</span><span class="nx">addedNote</span><span class="p">.</span><span class="nx">_id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span>

      <span class="kd">const</span> <span class="nx">notesAfterOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>

      <span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">contents</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="nx">addedNote</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">notesAtStart</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">afterAll</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
  <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>Muutama huomio testeistä. Olemme jaotelleet testejä <a href="http://facebook.github.io/jest/docs/en/api.html#describename-fn">desribe</a>-lohkojen avulla ja muutamissa lohkoissa on oma <a href="http://facebook.github.io/jest/docs/en/api.html#beforeallfn-timeout">beforeAll</a>-funktiolla suoritettava alustuskoodi.</p>

<p>Joissain tapauksissa tämä olisi parempi tehdä operaatioilla <a href="https://facebook.github.io/jest/docs/en/api.html#beforeeachfn-timeout">beforeEach</a>, joka suoritetaan <em>ennen jokaista testiä</em>, näin testeistä saisi varmemmin toisistaan riippumattomia. Esimerkissä beforeEachia ei kuitenkaan ole käytetty.</p>

<p>Testien raportointi tapahtuu <em>describe</em>-lohkojen ryhmittelyn mukaan:</p>

<p><img src="http://localhost:4000/assets/4/5.png" alt="" /></p>

<p>Backendin tietokannan tilaa muuttavat testit, esim. uuden muistiinpanon lisäämistä testaava testi <em>‘addition of a new note’</em>, on tehty siten, että ne ensin aluksi selvittävät tietokannan tilan apufunktiolla <em>notesInDb()</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notesAtBeginningOfOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>
</code></pre></div></div>

<p>suorittavat testattavan operaation:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">newNote</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="s1">'async/await yksinkertaistaa asynkronisten funktioiden kutsua'</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kr">await</span> <span class="nx">api</span>
  <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newNote</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>
</code></pre></div></div>

<p>selvittävät tietokannan tilan operaation jälkeen</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">notesAfterOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">notesInDb</span><span class="p">()</span>
</code></pre></div></div>

<p>ja varmentavat, että operaation suoritus vaikutti tietokantaan halutulla tavalla</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">expect</span><span class="p">(</span><span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">notesAtBeginningOfOperation</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">notesAfterOperation</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">contents</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'async/await yksinkertaistaa asynkronisten funktioiden kutsua'</span><span class="p">)</span>
</code></pre></div></div>

<p>Testeihin jää vielä paljon parannettavaa mutta on jo aika siirtyä eteenpäin.</p>

<p>Käytetty tapa API:n testaamiseen, eli HTTP-pyyntöinä tehtävät operaatiot ja tietokannan tilan tarkastelu Mongoosen kautta ei ole suinkaan ainoa tai välttämättä edes paras tapa tehdä API-tason integraatiotestausta. Universaalisti parasta tapaa testien tekoon ei ole, vaan kaikki on aina suhteessa käytettäviin resursseihin ja testattavaan ohjelmistoon.</p>

<h2 id="tehtäviä-3">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#lisää-toiminnallisuutta-ja-testejä">4.12-4.14</a></p>

<h2 id="käyttäjien-hallinta-ja-monimutkaisempi-tietokantaskeema">Käyttäjien hallinta ja monimutkaisempi tietokantaskeema</h2>

<p>Haluamme toteuttaa sovellukseemme käyttäjien hallinnan. Käyttäjät tulee tallettaa tietokantaan ja jokaisesta muistiinpanosta tulee tietää sen luonut käyttäjä. Muistiinpanojen poisto ja editointi tulee olla sallittua ainoastaan muistiinpanot tehneelle käyttäjälle.</p>

<p>Aloitetaan lisäämällä tietokantaan tieto käyttäjistä. Käyttäjän (User) ja muistiinpanojen (Note) välillä on yhden suhde moneen -yhteys:</p>

<p><img src="https://yuml.me/a187045b.png" alt="" /></p>

<p>Relaatiotietokantoja käytettäessä ratkaisua ei tarvitsisi juuri miettiä. Molemmille olisi oma taulunsa ja muistiinpanoihin liitettäisiin sen luonutta käyttäjää vastaava id vierasavaimeksi (foreign key).</p>

<p>Dokumenttitietokantoja käytettäessä tilanne on kuitenkin toinen, erilaisia tapoja mallintaa tilanne on useita.</p>

<p>Olemassaoleva ratkaisumme tallentaa jokaisen luodun muistiinpanon tietokantaan <em>notes</em>-kokoelmaan eli <em>collectioniin</em>. Jos emme halua muuttaa tätä, lienee luontevinta tallettaa käyttäjät omaan kokoelmaansa, esim. nimeltään <em>users</em>.</p>

<p>Mongossa voidaan kaikkien dokumenttitietokantojen tapaan käyttää olioiden id:itä viittaamaan muissa kokoelmissa talletettaviin dokumentteihin, vastaavasti kuten viiteavaimia käytetään relaatiotietokannoissa.</p>

<p>Dokumenttitietokannat kuten Mongo eivät kuitenkaan tue relaatiotietokantojen <em>liitoskyselyitä</em> vastaavaa toiminnallisuutta, joka mahdollistaisi useaan kokoelmaan kohdistuvan tietokantahaun (tämä ei ole tarkalleen ottaen enää välttämättä pidä paikkaansa, sillä versiosta 3.2. alkaen Mongo on tukenut useampaan kokoelmaan kohdistuvia <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/">lookup-aggregaattikyselyitä</a>, emme kuitenkaan käsittele niitä kurssilla).</p>

<p>Jos tarvitsemme liitoskyselyitä vastaavaa toiminnallisuutta, tulee se toteuttaa sovelluksen tasolla, eli käytännössä tekemällä tietokantaan useita kyselyitä. Tietyissä tilanteissa mongoose-kirjasto osaa hoitaa liitosten tekemisen, jolloin kysely näyttää mongoosen käyttäjälle toimivan liitoskyselyn tapaan. Mongoose tekee kuitenkin näissä tapauksissa taustalla useamman kyselyn tietokantaan.</p>

<h3 id="viitteet-kokoelmien-välillä">Viitteet kokoelmien välillä</h3>

<p>Jos käyttäisimme relaatiotietokantaa, muistiinpano sisältäisi <em>viiteavaimen</em> sen tehneeseen käyttäjään. Dokumenttitietokannassa voidaan toimia samoin.</p>

<p>Oletetaan että kokoelmassa <em>users</em> on kaksi käyttäjää:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="s1">'mluukkai'</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">123456</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="s1">'hellas'</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">141414</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Kokoelmassa <em>notes</em> on kolme muistiinpanoa, kaikkien kenttä <em>user</em> viittaa <em>users</em>-kentässä olevaan käyttäjään:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">221212</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="mi">123456</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">221255</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="mi">123456</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'Java on kieli, jota käytetään siihen asti kunnes aurinko sammuu'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">221244</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="mi">141414</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Mikään ei kuitenkaan määrää dokumenttitietokannoissa, että viitteet on talletettava muistiinpanoihin, ne voivat olla <em>myös</em> (tai ainoastaan) käyttäjien yhteydessä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="s1">'mluukkai'</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>
    <span class="na">notes</span><span class="p">:</span> <span class="p">[</span><span class="mi">221212</span><span class="p">,</span> <span class="mi">221255</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'hellas'</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">141414</span><span class="p">,</span>
    <span class="na">notes</span><span class="p">:</span> <span class="p">[</span><span class="mi">141414</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Koska käyttäjiin liittyy potentiaalisesti useita muistiinpanoja, niiden id:t talletetaan käyttäjän kentässä <em>notes</em> olevaan taulukkoon.</p>

<p>Dokumenttitietokannat tarjoavat myös radikaalisti erilaisen tavan datan organisointiin, joissain tilanteissa saattaisi olla mielekästä tallettaa muistiinpanot kokonaisuudessa käyttäjien sisälle:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="s1">'mluukkai'</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>
    <span class="na">notes</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'hellas'</span><span class="p">,</span>
    <span class="na">_id</span><span class="p">:</span> <span class="mi">141414</span><span class="p">,</span>
    <span class="na">notes</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="s1">'Java on kieli, jota käytetään siihen asti kunnes aurinko sammuu'</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Muistiinpanot olisivat tässä skeemaratkaisussa siis yhteen käyttäjään alisteisia kenttiä, niillä ei olisi edes omaa identiteettiä, eli id:tä tietokannan tasolla.</p>

<p>Dokumenttitietokantojen yhteydessä skeeman rakenne ei siis ole ollenkaan samalla tavalla ilmeinen kuin relaatiotietokannoissa, ja valittava ratkaisu kannattaa määritellä siten että se tukee parhaalla tavalla sovelluksen käyttötapauksia. Tämä ei luonnollisestikaan ole helppoa, sillä järjestelmän kaikki käyttötapaukset eivät yleensä ole selvillä kun projektin alkuvaiheissa mietitään datan organisointitapaa.</p>

<p>Hieman paradoksaalisesti tietokannan tasolla skeematon Mongo edellyttääkin projektin alkuvaiheissa jopa radikaalimpien datan organisoimiseen liittyvien ratkaisujen tekemistä kuin tietokannan tasolla skeemalliset relaatiotietokannat, jotka tarjoavat keskimäärin kaikkiin tilanteisiin melko hyvin sopivan tavan organisoida dataa.</p>

<h3 id="käyttäjien-mongoose-skeema">Käyttäjien mongoose-skeema</h3>

<p>Päätetään tallettaa käyttäjän yhteyteen myös tieto käyttäjän luomista muistiinpanoista, eli käytännössä muistiinpanojen id:t. Määritellään käyttäjää edustava model tiedostoon <em>models/user:</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">passwordHash</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">notes</span><span class="p">:</span> <span class="p">[{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="s1">'Note'</span> <span class="p">}]</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">User</span>
</code></pre></div></div>

<p>Muistiinpanojen id:t on talletettu käyttäjien sisälle taulukkona mongo-id:itä. Määrittely on seuraava</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="nl">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="nx">ref</span><span class="p">:</span> <span class="s1">'Note'</span> <span class="p">}</span>
</code></pre></div></div>

<p>kentän tyyppi on <em>ObjectId</em> joka viittaa <em>Note</em>-tyyppisiin dokumentteihin. Mongo ei itsessään tiedä mitään siitä, että kyse on kentästä joka viittaa nimenomaan muistiinpanoihin, kyseessä onkin puhtaasti mongoosen syntaksi.</p>

<p>Laajennetaan tiedostossa <em>model/note.js</em> olevaa muistiinpanon skeemaa siten, että myös muistiinpanossa on tieto sen luoneesta käyttäjästä</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span><span class="p">,</span>
  <span class="na">user</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="s1">'User'</span> <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Relaatiotietokantojen käytänteistä poiketen <em>viitteet on nyt talletettu molempiin dokumentteihin</em>, muistiinpano viittaa sen luoneeseen käyttäjään ja käyttäjä sisältää taulukollisen viitteitä sen luomiin muistiinpanoihin.</p>

<h3 id="käyttäjien-luominen">Käyttäjien luominen</h3>

<p>Toteutetaan seuraavaksi route käyttäjien luomista varten. Käyttäjällä on siis <em>username</em> jonka täytyy olla järjestelmässä yksikäsitteinen, nimi eli <em>name</em> sekä <em>passwordHash</em>, eli salasanasta <a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">yksisuuntaisen funktion</a> perusteella laskettu tunniste. Salasanojahan ei ole koskaan viisasta tallentaa tietokantaan selväsanaisena!</p>

<p>Asennetaan salasanojen hashaamiseen käyttämämme <a href="https://github.com/kelektiv/node.bcrypt.js">bcrypt</a>-kirjasto:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install bcrypt <span class="nt">--save</span>
</code></pre></div></div>

<p>Käyttäjien luominen tapahtuu osassa 3 läpikäytyjä <a href="/osa3#rest">RESTful</a>-periaatteita seuraten tekemällä HTTP POST -pyyntö polkuun <em>users</em>.</p>

<p>Määritellään käyttäjienhallintaa varten oma <em>router</em> tiedostoon <em>controllers/users.js</em>, ja liitetään se <em>index.js</em>-tiedostossa huolehtimaan polulle <em>/api/users/</em> tulevista pyynnöistä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">usersRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./controllers/users'</span><span class="p">)</span>

<span class="c1">// ...</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/api/users'</span><span class="p">,</span> <span class="nx">usersRouter</span><span class="p">)</span>
</code></pre></div></div>

<p>Routerin alustava sisältö on seuraava:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bcrypt'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">usersRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">).</span><span class="nx">Router</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/user'</span><span class="p">)</span>

<span class="nx">usersRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

    <span class="kd">const</span> <span class="nx">saltRounds</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="kd">const</span> <span class="nx">passwordHash</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">saltRounds</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="nx">passwordHash</span>
    <span class="p">})</span>

    <span class="kd">const</span> <span class="nx">savedUser</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">savedUser</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'something went wrong...'</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">usersRouter</span>
</code></pre></div></div>

<p>Tietokantaan siis <em>ei</em> talleteta pyynnön mukana tulevaa salasanaa, vaan funktion <em>bcrypt.hash</em> avulla laskettu <em>hash</em>.</p>

<p>Materiaalin tilamäärä ei valitettavasti riitä käsittelemään sen tarkemmin salasanojen <a href="https://codahale.com/how-to-safely-store-a-password/">tallennuksen perusteita</a>, esim. mitä maaginen luku 10 muuttujan <a href="https://github.com/kelektiv/node.bcrypt.js/#a-note-on-rounds">saltRounds</a> arvona tarkoittaa. Lue linkkien takaa lisää.</p>

<p>Koodissa ei tällä hetkellä ole mitään virheidenkäsittelyä eikä validointeja, eli esim. käyttäjätunnuksen ja salasanan halutun muodon tarkastuksia.</p>

<p>Uutta ominaisuutta voidaan ja kannattaakin joskus testailla käsin esim. postmanilla. Käsin tapahtuva testailu muuttuu kuitenkin nopeasti työlääksi, etenkin kun tulemme pian vaatimaan, että samaa käyttäjätunnusta ei saa tallettaa kantaan kahteen kertaan.</p>

<p>Pienellä vaivalla voimme tehdä automaattisesti suoritettavat testit, jotka helpottavat sovelluksen kehittämistä merkittävästi.</p>

<p>Alustava testi näyttää seuraavalta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/user'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">initialNotes</span><span class="p">,</span> <span class="nx">nonExistingId</span><span class="p">,</span> <span class="nx">notesInDb</span><span class="p">,</span> <span class="nx">usersInDb</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./test_helper'</span><span class="p">)</span>

<span class="c1">//...</span>

<span class="nx">describe</span><span class="p">.</span><span class="nx">only</span><span class="p">(</span><span class="s1">'when there is initially one user at db'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">remove</span><span class="p">({})</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="s1">'root'</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="s1">'sekret'</span> <span class="p">})</span>
    <span class="kr">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="s1">'POST /api/users succeeds with a fresh username'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">usersBeforeOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">usersInDb</span><span class="p">()</span>

    <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">username</span><span class="p">:</span> <span class="s1">'mluukkai'</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="s1">'Matti Luukkainen'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="s1">'salainen'</span>
    <span class="p">}</span>

    <span class="kr">await</span> <span class="nx">api</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/users'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newUser</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">usersAfterOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">usersInDb</span><span class="p">()</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">usersAfterOperation</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">usersBeforeOperation</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">usernames</span> <span class="o">=</span> <span class="nx">usersAfterOperation</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">u</span><span class="o">=&gt;</span><span class="nx">u</span><span class="p">.</span><span class="nx">username</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">usernames</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="nx">newUser</span><span class="p">.</span><span class="nx">username</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Koska testi on määritelty <a href="https://facebook.github.io/jest/docs/en/api.html#describeonlyname-fn">describe.only</a>-lohkoksi, suorittaa <em>Jest</em> ainoastaan lohkon sisälle määritellyt testit. Tämä on alkuvaiheessa hyödyllistä, sillä ennen kuin uusia käyttäjiä lisäävä toiminnallisuus on valmis, kannattaa suorittaa testeistä ainoastaan kyseistä toiminnallisuutta tutkivat testitapaukset.</p>

<p>Testit käyttävät myös tiedostossa <em>tests/test_helper.js</em> määriteltyä apufunktiota <em>usersInDb()</em> tarkastamaan lisäysoperaation jälkeisen tietokannan tilan:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/user'</span><span class="p">)</span>

<span class="c1">// ...</span>

<span class="kd">const</span> <span class="nx">usersInDb</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="k">return</span> <span class="nx">users</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">initialNotes</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">nonExistingId</span><span class="p">,</span> <span class="nx">notesInDb</span><span class="p">,</span> <span class="nx">usersInDb</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lohkon <em>beforeAll</em> lisää kantaan käyttäjän, jonka username on <em>root</em>. Voimmekin tehdä uuden testin, jolla varmistetaan, että samalla käyttäjätunnuksella ei voi luoda uutta käyttäjää:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="s1">'POST /api/users fails with proper statuscode and message if username already taken'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">usersBeforeOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">usersInDb</span><span class="p">()</span>

  <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="s1">'root'</span><span class="p">,</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'Superuser'</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="s1">'salainen'</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">api</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/users'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newUser</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="sr">/application</span><span class="se">\/</span><span class="sr">json/</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'username must be unique'</span><span class="p">})</span>

  <span class="kd">const</span> <span class="nx">usersAfterOperation</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">usersInDb</span><span class="p">()</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">usersAfterOperation</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">usersBeforeOperation</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Testi ei tietenkään mene läpi tässä vaiheessa. Toimimme nyt oleellisesti <a href="https://en.wikipedia.org/wiki/Test-driven_development">TDD:n eli test driven developmentin</a> hengessä, uuden ominaisuuden testi on kirjoitettu ennen ominaisuuden ohjelmointia.</p>

<p>Koodi laajenee seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">usersRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

    <span class="kd">const</span> <span class="nx">existingUser</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">username</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">})</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">existingUser</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'username must be unique'</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">//...</span>

  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Eli haetaan tietokannasta ne user-dokumentit, joiden <em>username</em>-kentän arvo on sama kuin pyynnössä oleva. Jos sellainen user-dokumentti löytyy, vastataan pyyntöön statuskoodilla <em>400 bad request</em> ja kerrotaan syy ongelmaan.</p>

<p>Voisimme toteuttaa käyttäjien luomisen yhteyteen myös muita tarkistuksia, esim. onko käyttäjätunnus tarpeeksi pitkä, koostuuko se sallituista merkeistä ja onko salasana tarpeeksi hyvä. Jätämme ne kuitenkin harjoitustehtäväksi.</p>

<p>Ennen kuin menemme eteenpäin, lisätään alustava versio joka palauttaa kaikki käyttäjät palauttavasta käsittelijäfunktiosta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatUser</span> <span class="o">=</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
    <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
    <span class="na">name</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">notes</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">notes</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">usersRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">formatUser</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Lista näyttää seuraavalta</p>

<p><img src="http://localhost:4000/images/4/5b.png" alt="" /></p>

<h3 id="formatointifunktioiden-siirto-modelien-märittelyn-yhteyteen">Formatointifunktioiden siirto modelien märittelyn yhteyteen</h3>

<p>Kuten muistinpanojenkin tapauksessa, olemme myös nyt määritellet apufunktion <em>formatUser</em>, joka muodostaa tietokannan palauttamista <em>user</em>-olioista selaimelle lähetettävän muodon, joista on mm. poistettu kenttä <em>passwordHash</em>.</p>

<p>Formatointifunktio on nyt sijoitettu routejen määrittelyn yhteyteen. Paikka ei välttämättä ole optimaalinen ja päätetäänkin viedä formatointi <em>User</em>-skeeman vastuulle, sen <a href="http://mongoosejs.com/docs/guide.html#statics">staattiseksi metodiksi</a>.</p>

<p>Tehdään seuraava muutos tiedostoon <em>models/user.js</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
  <span class="na">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">passwordHash</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">notes</span><span class="p">:</span> <span class="p">[{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="s1">'Note'</span> <span class="p">}]</span>
<span class="p">})</span>

<span class="nx">userSchema</span><span class="p">.</span><span class="nx">statics</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
    <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
    <span class="na">name</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
    <span class="na">notes</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">notes</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">User</span>
</code></pre></div></div>

<p>Näin määriteltyä metodia kutsutaan <em>User.format(user)</em>. Voimme muuttaa tiedostosta <em>controllesr/users.js</em> olevat routet seuraavaan muotoon:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">usersRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">format</span><span class="p">))</span>
<span class="p">})</span>

<span class="nx">usersRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">const</span> <span class="nx">savedUser</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">savedUser</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Formatointifunktion määritteleminen skeeman määrittelyn yhteydessä on sikäli luontevaa, että jos skeemaan tulee muutoksia, on formatointifunktio samassa tiedostossa ja todennäköisyys sen päivittämisen unohtamiselle pienenee.</p>

<p>Tehdään sama muutos muistiinpanojen formatointiin, eli muutetaan <em>models/note.js</em> muotoon</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">noteSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span><span class="p">,</span>
  <span class="na">user</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="s1">'User'</span> <span class="p">}</span>
<span class="p">})</span>

<span class="nx">noteSchema</span><span class="p">.</span><span class="nx">statics</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="nx">noteSchema</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Note</span>
</code></pre></div></div>

<p>ja muutetaan tiedostosta <em>controllers/notes.js</em> metotodikutsut <em>formatNote(note)</em> muotoon <em>Note.format(note)</em> ja kutsu <em>notes.map(formatNote)</em> muotoon <em>notes.map(Note.format)</em></p>

<p>Testien suoritus varmistaa, että sovelluksemme ei hajonnut refaktoroinnin myötä.</p>

<p>Pääsemme nyt eroon myös testien yhteyteen määritellystä muistiinpanoja formatoivasta apumetodista <em>format</em>, sillä myös testeissä kannattaa hyödyntää funktiota <em>Note.format</em>.</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-5">githubissa</a>, tagissa <em>part4-5</em>.</p>

<h3 id="muistiinpanon-luominen">Muistiinpanon luominen</h3>

<p>Muistiinpanot luovaa koodia on nyt mukautettava siten, että uusi muistiinpano tulee liitetyksi sen luoneeseen käyttäjään.</p>

<p>Laajennetaan ensin olemassaolevaa toteutusta siten, että tieto muistiinpanon luovan käyttäjän id:stä lähetetään pyynnön rungossa kentän <em>userId</em> arvona:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/user'</span><span class="p">)</span>

<span class="c1">//...</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
      <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
      <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="kc">false</span> <span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
      <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">user</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span>
    <span class="p">})</span>

    <span class="kd">const</span> <span class="nx">savedNote</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">note</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nx">user</span><span class="p">.</span><span class="nx">notes</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span>
    <span class="kr">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Note</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'something went wrong...'</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Huomionarvoista on nyt se, että myös <em>user</em>-olio muuttuu. Sen kenttään <em>notes</em> talletetaan luodun muistiinpanon <em>id</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>

<span class="nx">user</span><span class="p">.</span><span class="nx">notes</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span>
<span class="kr">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
</code></pre></div></div>

<p>Kokeillaan nyt lisätä uusi muistiinpano</p>

<p><img src="http://localhost:4000/assets/4/6.png" alt="" /></p>

<p>Operaatio vaikuttaa toimivan. Lisätään vielä yksi muistiinpano ja mennään kaikkien käyttäjien sivulle:</p>

<p><img src="http://localhost:4000/assets/4/7.png" alt="" /></p>

<p>Huomaamme siis, että käyttäjällä on kaksi muistiinpanoa.</p>

<p>Jos laajennamme muistiinpanojen JSON:in muotoileman koodin näyttämään muistiinpanoon liittyvän käyttäjän</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">noteSchema</span><span class="p">.</span><span class="nx">statics</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">user</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>tulee muistiinpanon luoneen käyttäjän id näkyviin muistiinpanon yhteyteen.</p>

<p><img src="http://localhost:4000/assets/4/8.png" alt="" /></p>

<h3 id="populate">populate</h3>

<p>Haluaisimme API:n toimivan siten, että haettaessa esim. käyttäjien tiedot polulle <em>/api/users</em> tehtävällä HTTP GET -pyynnöllä tulisi käyttäjien tekemien muistiinpanojen id:iden lisäksi näyttää niiden sisältö. Relaatiotietokannoilla toiminnallisuus toteutettaisiin <em>liitoskyselyn</em> avulla.</p>

<p>Kuten aiemmin mainittiin, eivät dokumenttitietokannat tue (kunnolla) eri kokoelmien välisiä liitoskyselyitä. Mongoose-kirjasto osaa kuitenkin tehdä liitoksen puolestamme. Mongoose toteuttaa liitoksen tekemällä useampia tietokantakyselyitä, joten siinä mielessä kyseessä on täysin erilainen tapa kuin relaatiotietokantojen liitoskyselyt, jotka ovat <em>transaktionaalisia</em>, eli liitoskyselyä tehdessä tietokannan tila ei muutu. Mongoosella tehtävä liitos taas on sellainen, että mikään ei takaa sitä, että liitettävien kokoelmien tila on konsistentti, toisin sanoen jos tehdään users- ja notes-kokoelmat liittävä kysely, kokoelmien tila saattaa muuttua kesken mongoosen liitosoperaation.</p>

<p>Liitoksen tekeminen suoritetaan mongoosen komennolla <a href="http://mongoosejs.com/docs/populate.html">populate</a>. Päivitetään ensin kaikkien käyttäjien tiedot palauttava route:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">usersRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span>
    <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
    <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'notes'</span><span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">format</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Funktion <a href="http://mongoosejs.com/docs/populate.html">populate</a> kutsu siis ketjutetaan kyselyä vastaavan metodikutsun (tässä tapauksessa <em>find</em>) perään. Populaten parametri määrittelee, että <em>user</em>-dokumenttien <em>notes</em>-kentässä olevat <em>note</em>-olioihin viittaavat <em>id</em>:t korvataan niitä vastaavilla dokumenteilla.</p>

<p>Lopputulos on jo melkein haluamamme kaltainen:</p>

<p><img src="http://localhost:4000/images/4/9a.png" alt="" /></p>

<p>Populaten yhteydessä on myös mahdollista rajata mitä kenttiä sisällytettävistä dokumenteista otetaan mukaan. Rajaus tapahtuu Mongon <a href="https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/#return-the-specified-fields-and-the-id-field-only">syntaksilla</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">usersRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span>
    <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
    <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'notes'</span><span class="p">,</span> <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">date</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">format</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tulos on nyt halutun kaltainen (:</p>

<p><img src="http://localhost:4000/images/4/10a.png" alt="" /></p>

<p>Lisätään sopiva käyttäjän tietojen populointi, muistiinpanojen yhteyteen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">notesRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
    <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="p">{</span> <span class="na">username</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">Note</span><span class="p">.</span><span class="nx">format</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Nyt käyttäjän tiedot tulevat muistiinpanon kenttään <em>user</em>.</p>

<p><img src="http://localhost:4000/images/4/11a.png" alt="" /></p>

<p>Korostetaan vielä, että tietokannan tasolla ei siis ole mitään määrittelyä siitä, että esim. muistiinpanojen kenttään <em>user</em> talletetut id:t viittaavat käyttäjä-kokoelman dokumentteihin.</p>

<p>Mongoosen <em>populate</em>-funktion toiminnallisuus perustuu siihen, että olemme määritelleet viitteiden “tyypit” olioiden mongoose-skeemaan <em>ref</em>-kentän avulla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span><span class="p">,</span>
  <span class="na">user</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="s1">'User'</span> <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="kirjautuminen">Kirjautuminen</h2>

<p>Käyttäjien tulee pystyä kirjautumaan sovellukseemme ja muistiinpanot pitää automaattisesti liittää kirjautuneen käyttäjän tekemiksi.</p>

<p>Toteutamme nyt backendiin tuen <a href="https://scotch.io/tutorials/the-ins-and-outs-of-token-based-authentication#toc-how-token-based-works">token-perustaiselle</a> autentikoinnille.</p>

<p>Token-autentikaation periaatetta kuvaa seuraava sekvenssikaavio:</p>

<p><img src="http://localhost:4000/images/4/12a.png" alt="" /></p>

<ul>
  <li>Alussa käyttäjä kirjaantuu Reactilla toteutettua kirjautumislomaketta käyttäen
    <ul>
      <li>lisäämme kirjautumislomakkeen frontendiin <a href="osa5">osassa 5</a></li>
    </ul>
  </li>
  <li>Tämän seurauksena selaimen React-koodi lähettää käyttäjätunnuksen ja salasanan HTTP POST -pyynnöllä palvelimen osoitteeseen <em>/api/login</em></li>
  <li>Jos käyttäjätunnus ja salasana ovat oikein, generoi palvelin <em>Tokenin</em>, jonka yksilöi jollain tavalla kirjautumisen tehneen käyttäjän
    <ul>
      <li>token on kryptattu, joten sen väärentäminen on (kryptografisesti) mahdotonta</li>
    </ul>
  </li>
  <li>backend vastaa selaimelle onnistumisesta kertovalla statuskoodilla ja palauttaa Tokenin vastauksen mukana</li>
  <li>Selain tallentaa tokenin esimerkiksi React-sovelluksen tilaan</li>
  <li>Kun käyttäjä luo uuden muistiinpanon (tai tekee jonkin operaation, joka edellyttää tunnistautumista), lähettää React-koodi Tokenin pyynnön mukana palvelimelle</li>
  <li>Palvelin tunnistaa pyynnön tekijän tokenin perusteella</li>
</ul>

<p>Tehdään ensin kirjautumistoiminto. Asennetaan <a href="https://github.com/auth0/node-jsonwebtoken">jsonwebtoken</a>-kirjasto, jonka avulla koodimme pystyy generoimaan <a href="https://jwt.io/">JSON web token</a> -muotoisia tokeneja.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install jsonwebtoken <span class="nt">--save</span>
</code></pre></div></div>

<p>Tehdään kirjautumisesta vastaava koodi tiedostoon <em>controllers/login.js</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'jsonwebtoken'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bcrypt'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">loginRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">).</span><span class="nx">Router</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../models/user'</span><span class="p">)</span>

<span class="nx">loginRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="p">})</span>
  <span class="kd">const</span> <span class="nx">passwordCorrect</span> <span class="o">=</span> <span class="nx">user</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">?</span>
    <span class="kc">false</span> <span class="p">:</span>
    <span class="kr">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">passwordHash</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="nx">user</span> <span class="o">&amp;&amp;</span> <span class="nx">passwordCorrect</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'invalid username or password'</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">userForToken</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">userForToken</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">token</span><span class="p">,</span> <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="p">})</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">loginRouter</span>
</code></pre></div></div>

<p>Koodi aloittaa etsimällä pyynnön mukana olevaa <em>username</em>:a vastaavan käyttäjän tietokannasta. Seuraavaksi katsotaan onko pyynnön mukana oleva <em>password</em> oikea. Koska tietokantaan ei ole talletettu salasanaa, vaan salasanasta laskettu <em>hash</em>, tehdään vertailu metodilla <em>bcrypt.compare</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">passwordHash</span><span class="p">)</span>
</code></pre></div></div>

<p>Jos käyttäjää ei ole olemassa tai salasana on väärä, vastataan kyselyyn statuskoodilla <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 unauthorized</a> ja kerrotaan syy vastauksen bodyssä.</p>

<p>Jos salasana on oikein, luodaan metodin <em>jwt.sign</em> avulla token, joka sisältää kryptatussa muodossa käyttäjätunnuksen ja käyttäjän id:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">userForToken</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
  <span class="na">id</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">userForToken</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">)</span>
</code></pre></div></div>

<p>Token on digitaalisesti allekirjoitettu käyttämällä <em>salaisuutena</em> ympäristömuuttujassa <em>SECRET</em> olevaa merkkijonoa. Digitaalinen allekirjoitus varmistaa sen, että ainoastaan salaisuuden tuntevilla on mahdollisuus generoida validi token. Ympäristömuuttujalle pitää muistaa asettaa arvo tiedostoon .env.</p>

<p>Onnistuneeseen pyyntöön vastataan statuskoodilla <em>200 ok</em> ja generoitu token sekä kirjautuneen käyttäjän käyttäjätunnus ja nimi lähetetään vastauksen bodyssä pyynnön tekijälle.</p>

<p>Kirjautumisesta huolehtiva koodi on vielä liitettävä sovellukseen lisäämällä tiedostoon <em>index.js</em> muiden routejen käyttöönoton yhteyteen</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">loginRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./controllers/login'</span><span class="p">)</span>

<span class="c1">//...</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/api/login'</span><span class="p">,</span> <span class="nx">loginRouter</span><span class="p">)</span>
</code></pre></div></div>

<p>Kokeillaan kirjautumista, käytetään VS Coden REST-clientiä:</p>

<p><img src="http://localhost:4000/images/4/12b.png" alt="" /></p>

<p>Kirjautuminen ei kuitenkaan toimi, konsoli näyttää seuraavalta:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Method: POST
Path:   /api/login
Body:   <span class="o">{</span> username: <span class="s1">'mluukkai'</span>, password: <span class="s1">'salainen'</span> <span class="o">}</span>
<span class="nt">---</span>
<span class="o">(</span>node:17486<span class="o">)</span> UnhandledPromiseRejectionWarning: Unhandled promise rejection <span class="o">(</span>rejection id: 2<span class="o">)</span>: Error: secretOrPrivateKey must have a value
</code></pre></div></div>

<p>Ongelman aiheuttaa komento <em>jwt.sign(userForToken, process.env.SECRET)</em> sillä ympäristömuuttujalle <em>SECRET</em> on unohtunut määritellä arvo. Kun arvo määritellään tiedostoon <em>.env</em>, alkaa kirjautuminen toimia.</p>

<p>Onnistunut kirjautuminen palauttaa kirjautuneen käyttäjän tiedot ja tokenin:</p>

<p><img src="http://localhost:4000/images/4/12c.png" alt="" /></p>

<p>Virheellisellä käyttäjätunnuksella tai salasanalla kirjautuessa annetaan asianmukaisella statuskoodilla varustettu virheilmoitus</p>

<p><img src="http://localhost:4000/images/4/12d.png" alt="" /></p>

<h3 id="muistiinpanojen-luominen-vain-kirjautuneille">Muistiinpanojen luominen vain kirjautuneille</h3>

<p>Muutetaan vielä muistiinpanojen luomista, siten että luominen onnistuu ainoastaan jos luomista vastaavan pyynnön mukana on validi token. Muistiinpano talletetaan tokenin identifioiman käyttäjän tekemien muistiinpanojen listaan.</p>

<p>Tapoja tokenin välittämiseen selaimesta backendiin on useita. Käytämme ratkaisussamme <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization">Authorization</a>-headeria. Tokenin lisäksi headerin avulla kerrotaan mistä <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication#Authentication_schemes">autentikointiskeemasta</a> on kyse. Tämä voi olla tarpeen, jos palvelin tarjoaa useita eri tapoja autentikointiin. Skeeman ilmaiseminen kertoo näissä tapauksissa palvelimelle, miten mukana olevat kredentiaalit tulee tulkita.
Meidän käyttöömme sopii <em>Bearer</em>-skeema.</p>

<p>Käytännössä tämä tarkoittaa, että jos token on esimerkiksi merkkijono <em>eyJhbGciOiJIUzI1NiIsInR5c2VybmFtZSI6Im1sdXVra2FpIiwiaW</em>, laitetaan pyynnöissä headerin Authorization arvoksi merkkijono</p>
<pre>
Bearer eyJhbGciOiJIUzI1NiIsInR5c2VybmFtZSI6Im1sdXVra2FpIiwiaW
</pre>

<p>Modifioitu muistiinpanojen luomisesta huolehtiva koodi seuraavassa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'jsonwebtoken'</span><span class="p">)</span>

<span class="c1">// ...</span>

<span class="kd">const</span> <span class="nx">getTokenFrom</span> <span class="o">=</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">authorization</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'authorization'</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">authorization</span> <span class="o">&amp;&amp;</span> <span class="nx">authorization</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'bearer '</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">authorization</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span>
<span class="p">}</span>

<span class="nx">notesRouter</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">getTokenFrom</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">decodedToken</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span> <span class="o">||</span> <span class="o">!</span><span class="nx">decodedToken</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'token missing or invalid'</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">decodedToken</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
      <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
      <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="kc">false</span> <span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
      <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">user</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span>
    <span class="p">})</span>

    <span class="kd">const</span> <span class="nx">savedNote</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">note</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nx">user</span><span class="p">.</span><span class="nx">notes</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">.</span><span class="nx">_id</span><span class="p">)</span>
    <span class="kr">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">Note</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exception</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">'JsonWebTokenError'</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="nx">exception</span><span class="p">.</span><span class="nx">message</span> <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'something went wrong...'</span> <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Apufunktio <em>getTokenFrom</em> eristää tokenin headerista <em>authorization</em>. Tokenin oikeellisuus varmistetaan metodilla <em>jwt.verify</em>. Metodi myös dekoodaa tokenin, eli palauttaa olion, jonka perusteella token on laadittu:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">decodedToken</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">)</span>
</code></pre></div></div>

<p>Tokenista dekoodatun olion sisällä on kentät <em>username</em> ja <em>id</em> eli se kertoo palvelimelle kuka pyynnön on tehnyt.</p>

<p>Jos tokenia ei ole tai tokenista dekoodattu olio ei sisällä käyttäjän identiteettiä (eli <em>decodedToken.id</em> ei ole määritelty), palautetaan virheestä kertova statuskoodi <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 unauthorized</a> ja kerrotaan syy vastauksen bodyssä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span> <span class="o">||</span> <span class="o">!</span><span class="nx">decodedToken</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'token missing or invalid'</span> <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kun pyynnön tekijän identiteetti on selvillä, jatkuu suoritus entiseen tapaan.</p>

<p>Tokenin verifiointi voi myös aiheuttaa poikkeuksen <em>JsonWebTokenError</em>. Syynä tälle voi olla viallinen, väärennetty tai eliniältään vanhentunut token. Poikkeusten käsittelyssä haaraudutaan virheen tyypin perusteella ja vastataan 401 jos poikkeus johtuu tokenista, ja muuten vastataan <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 internal server error</a>.</p>

<p>Uuden muistiinpanon luominen onnistuu nyt postmanilla jos <em>authorization</em>-headerille asetetaan oikeanlainen arvo, eli merkkijono <em>bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ</em>, missä osa on <em>login</em>-operaation palauttama token.</p>

<p>Postmanilla luominen näyttää seuraavalta</p>

<p><img src="http://localhost:4000/assets/4/14.png" alt="" /></p>

<p>ja Visual Studio Coden REST clientillä</p>

<p><img src="http://localhost:4000/images/4/14a.png" alt="" /></p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-6">githubissa</a>, tagissa <em>part4-6</em>.</p>

<p>Jos sovelluksessa on useampia rajapintoja jotka vaativat kirjautumisen kannattaa JWT:n validointi eriyttää omaksi middlewarekseen, tai käyttää jotain jo olemassa olevaa kirjastoa kuten <a href="https://www.npmjs.com/package/express-jwt">express-jwt</a>.</p>

<h3 id="loppuhuomioita">Loppuhuomioita</h3>

<p>Koodissa on tapahtunut paljon muutoksia ja matkan varrella on tapahtunut tyypillinen kiivaasti etenevän ohjelmistoprojektin ilmiö: suuri osa testeistä on hajonnut. Koska kurssin tämä osa on jo muutenkin täynnä uutta asiaa, jätämme testien korjailun harjoitustehtäväksi.</p>

<p>Käyttäjätunnuksia, salasanoja ja tokenautentikaatiota hyödyntäviä sovelluksia tulee aina käyttää salatun <a href="https://en.wikipedia.org/wiki/HTTPS">HTTPS</a>-yhteyden yli. Voimme käyttää sovelluksissamme Noden <a href="https://nodejs.org/docs/latest-v8.x/api/http.html">HTTP</a>-serverin sijaan <a href="https://nodejs.org/api/https.html">HTTPS</a>-serveriä. Toisaalta koska sovelluksemme tuotantoversio on Herokussa, sovelluksemme pysyy käyttäjien kannalta suojattuna sen ansiosta, että Heroku reitittää kaiken liikenteen selaimen ja Herokun palvelimien välillä HTTPS:n yli.</p>

<p>Toteutamme kirjautumisen frontendin puolelle kurssin <a href="/osa5">seuraavassa osassa</a>.</p>

<h2 id="tehtäviä-4">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtavat#blogilistan-käyttäjät">4.15-4.21</a></p>

<!---
note left of kayttaja
  käyttäjä täyttää kirjautumislomakkeelle
  käyttäjätunnuksen ja salasanan
end note
kayttaja -> selain: painetaan login-nappia

selain -> backend: HTTP POST /api/login {username, password}
note left of backend
  backend generoi käyttäjän identifioivan TOKENin
end note
backend -> selain: TOKEN palautetaan vastauksen bodyssä
note left of selain
  selain tallettaa TOKENin
end note
note left of kayttaja
  käyttäjä luo uden muistiinpanon
end note
kayttaja -> selain: painetaan create note -nappia
selain -> backend: HTTP POST /api/notes {content} headereissa TOKEN
note left of backend
  backend tunnistaa TOKENin perusteella kuka käyttää kyseessä
end note

backend -> selain: 201 created

kayttaja -> kayttaja:
-->

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
             Full stack open 2018 
          </li>
          <li>
            <a href="mailto:mluukkai@cs.helsinki.fi">mluukkai@cs.helsinki.fi</a>
          </li>
          <li>
            <a href="https://github.com/mluukkai"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mluukkai</span></a>

          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
           
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>
        <br />Materiaali on lisensoitu
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons BY-NC-SA 3.0 -lisenssillä</a>.
        </p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
