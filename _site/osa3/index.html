<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>osa 3</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/osa3/">
  <link rel="alternate" type="application/rss+xml" title="Full stack open" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Full stack open</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">osa 3</h1>
  </header>

  <div class="post-content">
    <h2 id="osan-3-oppimistavoitteet">Osan 3 oppimistavoitteet</h2>

<ul>
  <li>Web-sovellusten toiminnan perusteet
    <ul>
      <li>RESTful-periaatteiden alkeet
        <ul>
          <li>HTTP-pyyntötyypit</li>
          <li>statuskoodit</li>
          <li>resurssiperustaiset URL:it</li>
          <li>HTTP-pyyntöjen- safety ja idempotence-ominaisuudet</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>node.js/express
    <ul>
      <li>npm
        <ul>
          <li>sovelluksen luominen</li>
          <li>riippuvuuksien hallinta</li>
          <li>npm-skriptien alkeet</li>
          <li>versiointi</li>
          <li>nodemon</li>
        </ul>
      </li>
      <li>HTTP-pyyntöjen käsittely
        <ul>
          <li>reittien määrittely</li>
          <li>pyyntöihin vastaaminen eri statuskoodein</li>
        </ul>
      </li>
      <li>middlewaret</li>
      <li>node.js-sovellusten debuggaaminen</li>
      <li>sovelluksen vieminen tuotantoon</li>
      <li>sovelluskehitys- ja tuotantoversion tietokantojen erottaminen</li>
    </ul>
  </li>
  <li>mongo
    <ul>
      <li>dokumenttitietokantojen perusteet</li>
      <li>mlab:in (tai vastaavan palvelun) mongon peruskäyttö</li>
      <li>mongoose
        <ul>
          <li>skeema ja model</li>
          <li>olioiden hakeminen, tallettaminen, editointi ja poisto</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>konfiguraatiot
    <ul>
      <li>ESlint</li>
    </ul>
  </li>
</ul>

<h2 id="muutama-huomio">Muutama huomio</h2>

<h3 id="setstate-on-asynkrooninen">setState on asynkrooninen</h3>

<p>Muutamat ovat jo törmänneet siihen, että <strong>React kutsuu funktiota setState asynkroonisesti</strong>, eli jos meillä on seuraava koodi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="p">)</span>
<span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">counter</span><span class="p">:</span> <span class="mi">55</span><span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="p">)</span>
</code></pre></div></div>

<p>tulostavat molemmat rivit saman arvon, sillä Reactin tila <strong>ei saa uutta arvoa</strong> heti komennon <em>this.setState</em> jälkeen, vaan vasta sitten kun suorituksen alla oleva metodi on suoritettu loppuun ja <em>setState</em> on saanut mahdollisuuden suoritukselle.</p>

<h3 id="consolelog">console.log</h3>

<p><em>Mikä erottaa kokeneen ja kokemattoman Javascript-ohjelmoijan? Kokeneet käyttävät 10-100 kertaa enemmän console.logia</em>.</p>

<p>Paradoksaalista kyllä tämä näyttää olevan tilanne, vaikka kokematon ohjelmoija oikeastaan tarvitsisi console.logia (tai jotain muita debuggaustapoja) huomattavissa määrin kokenutta enemmän.</p>

<p>Eli kun joku ei toimi, älä arvaile vaan logaa tai käytä jotain muita debuggauskeinoja.</p>

<p><strong>HUOM</strong> kun käytät komentoa <em>console.log</em> debuggaukseen, älä yhdistele asioita “javamaisesti” plussalla, eli sen sijaan että kirjoittaisit</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'propsin arvo on'</span> <span class="o">+</span> <span class="nx">props</span><span class="p">)</span>
</code></pre></div></div>

<p>erottele tulostettavat asiat pilkulla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'propsin arvo on'</span><span class="p">,</span> <span class="nx">props</span><span class="p">)</span>
</code></pre></div></div>

<p>Jos yhdistät merkkijonoon olion, tuloksena on suhteellisen hyödytön tulostustmuoto</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>propsin arvo on <span class="o">[</span>Object object]
</code></pre></div></div>

<p>kun taas pilkulla tulostettavat asiat erotellessa saat developer-konsoliin olion, jonka sisältöä on mahdollista tarkastella.</p>

<h3 id="visual-studio-coden-snippetit">Visual Studio Coden snippetit</h3>

<p>VS Codeen on helppo määritellä “snippettejä”, eli Netbeansin “sout”:in tapaisia oikoteitä yleisesti käytettyjen koodinpätkien generointiin. Ohje snippetien luomiseen <a href="https://github.com/FullStack-HY/FullStack-Hy.github.io/blob/master/snippet_ohje.md">täällä</a></p>

<p>VS Code -plugineina löytyy myös hyödyllisiä valmiiksi määriteltyjä snippetejä, esim.
<a href="https://marketplace.visualstudio.com/items?itemName=xabikos.ReactSnippets">tämä</a></p>

<h3 id="pakolliset-tehtävät-tehtävien-vaikutus-arvosanaan">Pakolliset tehtävät, tehtävien vaikutus arvosanaan</h3>

<p>Joissain yhteyksissä on ollut pientä epäselvyyttä mitä tiettyjen tehtävien pakollisuus tarkoittaa, ja mikä eipakollisten tehtävien rooli on. Tarkennusta asiaan tehtävien sivun <a href="/tehtävät">alussa</a>.</p>

<h3 id="linkkivinkit">linkkivinkit</h3>

<p>Kurssisivun alaisuudessa on nyt <a href="https://fullstack-hy.github.io/linkit/">osio</a>, jonne kaikkien toivotaan lisäilevän hyödyllisiksi kokemiaan linkkejä. Lisääminen onnistuu tekemällä pull request <a href="https://github.com/FullStack-HY/FullStack-Hy.github.io/blob/master/linkit.md">tänne</a></p>

<p>Kun lisäät linkin, laita linkin yhteyteen pieni kuvaus mitä linkin takaa löytyy.</p>

<h2 id="nodejs">Node.js</h2>

<p>Siirrämme tässä osassa fokuksen backendiin, eli palvelimella olevaan toiminnallisuuteen.</p>

<p>Backendin toteutusympäristönä käytämme <a href="https://nodejs.org/en/">Node.js</a>:ää, joka on melkein missä vaan, erityisesti palvelimilla ja omalla koneellasikin toimiva, Googlen <a href="https://developers.google.com/v8/">chrome V8</a> -Javascriptmoottoriin perustuva Javascriptin suoritusympäristö.</p>

<p>Kurssimateriaalia tehtäessä on ollut käytössä Node.js:n versio <em>v8.6.0</em>. Huolehdi että omasi on vähintään yhtä tuore (ks. komentoriviltä <em>node -v</em>).</p>

<p>Kuten <a href="/osa1#javascriptiä">osassa 1</a> todettiin, selaimet eivät vielä osaa uusimpia Javascriptin ominaisuuksia ja siksi selainpuolen koodi täytyy kääntää eli <em>transpiloida</em> esim <a href="https://babeljs.io/">babel</a>:illa. Backendissa tilanne on kuitenkin toinen, uusin Node hallitsee riittävissä määrin myös Javascriptin uusia versioita (muutamia vielä standardoimattomia ominaisuuksia lukuunottamatta), joten suoritamme Nodella suoraan kirjoittamaamme koodia ilman transpilointivaihetta.</p>

<p>Tavoitteenamme on tehdä <a href="/osa2">osan 2</a> muistiinpanosovellukseen sopiva backend. Aloitetaan kuitenkin ensin perusteiden läpikäyminen toteuttamalla perinteinen “hello world”-sovellus.</p>

<p>Osassa 2 oli jo puhe <a href="/osa2#npm">npm</a>:stä, eli Javascript-projektien hallintaan liittyvästä, alunperin Node-ekosysteemistä kotoisin olevasta työkalusta. Mennään sopivaan hakemistoon ja luodaan projektimme runko komennolla <em>npm init</em>. Vastaillaan kysymyksiin sopivasti ja tuloksena on hakemiston juureen sijoitettu projektin tietoja kuvaava tiedosto <em>package.json</em></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"notebackend"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="s2">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index.js"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Matti Luukkainen"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MIT"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Tiedosto määrittelee mm. että ohjelmamme käynnistyspiste on tiedosto <em>index.js</em>.</p>

<p>Tehdään kenttään <em>scripts</em> pieni lisäys:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  // ...
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"start"</span>: <span class="s2">"node index.js"</span>,
    <span class="s2">"test"</span>: <span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span>
  <span class="o">}</span>,
  // ...
<span class="o">}</span>
</code></pre></div></div>

<p>Luodaan sitten sovelluksen ensimmäinen versio, eli projektin juureen sijoitettava tiedosto <em>index.js</em> ja sille seuraava sisältö:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello world'</span><span class="p">)</span>
</code></pre></div></div>

<p>Voimme suorittaa ohjelman joko “suoraan” nodella, komentorivillä</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node index.js
</code></pre></div></div>

<p>tai <a href="https://docs.npmjs.com/misc/scripts">npm scriptinä</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm start
</code></pre></div></div>

<p>npm-skripti <em>start</em> toimii koska määrittelimme sen tiedostoon <em>package.json</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  // ...
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"start"</span>: <span class="s2">"node index.js"</span>,
    <span class="s2">"test"</span>: <span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span>
  <span class="o">}</span>,
  // ...
<span class="o">}</span>
</code></pre></div></div>

<p>Vaikka esim. projektin suorittaminen onnistuukin suoraan käyttämällä komentoa <em>node index.js</em>, on npm-projekteille suoritettavat operaatiot yleensä tapana määritellä nimenomaan npm-skripteinä.</p>

<p>Oletusarvoinen <em>package.json</em> määrittelee valmiiksi myös toisen yleisesti käytetyn npm-scriptin eli <em>npm test</em>. Koska projektissamme ei ole vielä testikirjastoa, ei <em>npm test</em> kuitenkaan tee vielä muuta kuin suorittaa komennon</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"Error: no test specified"</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>1
</code></pre></div></div>

<h3 id="yksinkertainen-web-palvelin">Yksinkertainen web-palvelin</h3>

<p>Muutetaan sovellus web-palvelimeksi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'text/plain'</span> <span class="p">})</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'Hello World'</span><span class="p">)</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3001</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>

<p>Konsoliin tulostuu</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Server running on port 3001
</code></pre></div></div>

<p>Voimme avata selaimella osoitteessa <a href="http://localhost:3001">http://localhost:3001</a> olevan vaatimattoman sovelluksemme:</p>

<p><img src="http://localhost:4000/assets/3/1.png" alt="" /></p>

<p>Palvelin toimii itseasiassa täsmälleen samalla tavalla riippumatta urlin loppuosasta, eli myös sivun <a href="http://localhost:3001/foo/bar">http://localhost:3001/foo/bar</a> sisältö on sama.</p>

<p><strong>HUOM</strong> jos koneesi portti 3001 on jo jonkun sovelluksen käytössä, aiheuttaa käynnistäminen virheen:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> notebackend@0.0.1 start /Users/mluukkai/opetus/_2018fullstack_koodi/materiaali/osa3/notebackend
<span class="o">&gt;</span> node index.js

Server running on port 3001
events.js:182
      throw er<span class="p">;</span> // Unhandled <span class="s1">'error'</span> event
      ^

Error: listen EADDRINUSE :::3001
    at Object._errnoException <span class="o">(</span>util.js:1019:11<span class="o">)</span>
</code></pre></div></div>

<p>Sammuta portissa 3001 oleva sovellus (edellisessä osassa json-server käynnistettiin porttiin 3001) tai määrittele sovellukselle jokin toinen portti.</p>

<p>Tarkastellaan koodia hiukan. Ensimmäinen rivi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">)</span>
</code></pre></div></div>

<p>ottaa käyttöön Noden sisäänrakennetun <a href="https://nodejs.org/docs/latest-v8.x/api/http.html">web-palvelimen</a> määrittelevän moduulin. Kyse on käytännössä samasta asiasta, mihin olemme selainpuolen koodissa tottuneet hieman syntaksiltaan erilaisessa muodossa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">http</span> <span class="k">from</span> <span class="s1">'http'</span>
</code></pre></div></div>

<p>Selaimen puolella käytetään (nykyään) ES6:n moduuleita, eli moduulit määritellään <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/export">exportilla</a> ja otetaan käyttöön <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import">importilla</a>.</p>

<p>Node.js kuitenkin käyttää ns. <a href="https://en.wikipedia.org/wiki/CommonJS">CommonJS</a>-moduuleja. Syy tälle on siinä, että Node-ekosysteemillä oli tarve moduuleihin jo kauan ennen kuin Javascript tuki kielen tasolla moduuleja. Node ei toistaiseksi tue ES-moduuleja, mutta tuki on todennäköisesti jossain vaiheessa <a href="https://nodejs.org/api/esm.html">tulossa</a>.</p>

<p>CommonJS-moduulit toimivat kohtuullisessa määrin samaan tapaan kuin ES6-moduulit, ainakin tämän kurssin tarpeiden puitteissa.</p>

<p>Koodi jatkuu seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'text/plain'</span> <span class="p">})</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'Hello World'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>koodi luo <a href="https://nodejs.org/docs/latest-v8.x/api/http.html">http</a>-palvelimen metodilla <em>createServer</em> web-palvelimen, jolle se rekisteröi <em>tapahtumankäsittelijän</em>, joka suoritetaan <em>jokaisen</em> osoitteen <a href="http:/localhost:3001/">http:/localhost:3001/</a> alle tulevan HTTP-pyynnön yhteydessä.</p>

<p>Pyyntöön vastataan statuskoodilla 200, asettamalla <em>Content-Type</em>-headerille arvo <em>text/plain</em> ja asettamalla palautettavan sivun sisällöksi merkkijono <em>Hello World</em>.</p>

<p>Viimeiset rivit sitovat muuttujaan <em>app</em> sijoitetun http-palvelimen kuuntelemaan porttiin 3001 tulevia HTTP-pyyntöjä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3001</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>

<p>Koska tällä kurssilla palvelimen rooli on pääasiassa tarjota frontille JSON-muotoista “raakadataa”, muutetaan heti palvelinta siten, että se palauttaa kovakoodatun listallisen JSON-muotoisia muistiinpanoja:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">notes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T17:30:31.098Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'Selain pystyy suorittamaan vain javascriptiä'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T18:39:34.091Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'HTTP-protokollan tärkeimmät metodit ovat GET ja POST'</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s1">'2017-12-10T19:20:14.298Z'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span> <span class="p">})</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">notes</span><span class="p">))</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Käynnistetään palvelin uudelleen (palvelin sammutetaan painamalla <em>ctrl</em> ja <em>c</em> yhtä aikaa konsolissa) ja refreshataan selain.</p>

<p>Headerin <em>Content-Type</em> arvolla <em>application/json</em> kerrotaan, että kyse on JSON-muotoisesta datasta. Muuttujassa <em>notes</em> oleva taulukko muutetaan jsoniksi metodilla <code>JSON.stringify(notes)</code>.</p>

<p>Kun avaamme selaimen, on tulostusasu sama kuin <a href="/osa2#datan-haku-palvelimelta">osassa 2</a> käytetyn <a href="https://github.com/typicode/json-server">json-serverin</a> tarjoamalla muistiinpanojen listalla:</p>

<p><img src="http://localhost:4000/assets/3/2.png" alt="" /></p>

<p>Voimme jo melkein ruveta käyttämään uutta backendiämme osan 2 muistiinpano-frontendin kanssa. Mutta vain <em>melkein</em>, sillä kun käynnistämme frontendin, tulee konsoliin virheilmoitus</p>

<p><img src="http://localhost:4000/assets/3/3.png" alt="" /></p>

<p>Syy virheelle selviää pian, parantelemme kuitenkin ensin koodia muilta osin.</p>

<h2 id="express">Express</h2>

<p>Palvelimen koodin tekeminen suoraan Noden sisäänrakennetun web-palvelimen <a href="https://nodejs.org/docs/latest-v8.x/api/http.html">http</a>:n päälle on mahdollista, mutta työlästä, erityisesti jos sovellus kasvaa hieman isommaksi.</p>

<p>Nodella tapahtuvaa web-sovellusten ohjelmointia helpottamaan onkin kehitelty useita <em>http</em>:tä miellyttävämmän ohjelmoitirajapinnan tarjoamia kirjastoja. Näistä ylivoimaisesti suosituin on <a href="http://expressjs.com">express</a>.</p>

<p>Otetaan express käyttöön määrittelemällä se projektimme riippuvuudeksi komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install express <span class="nt">--save</span>
</code></pre></div></div>

<p>Riippuvuus tulee nyt määritellyksi tiedostoon <em>package.json</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  // ...
  <span class="s2">"dependencies"</span>: <span class="o">{</span>
    <span class="s2">"express"</span>: <span class="s2">"^4.16.2"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Riippuvuuden koodi asentuu kaikkien projektin riippuvuuksien tapaan projektin juuressa olevaan hakemistoon <em>node_modules</em>. Hakemistosta löytyy expressin lisäksi suuri määrä muutakin tavaraa</p>

<p><img src="/assets/3/4.png" height="200" /></p>

<p>Kyseessä ovat expressin riippuvuudet ja niiden riippuvuudet ym… eli projektimme <a href="https://lexi-lambda.github.io/blog/2016/08/24/understanding-the-npm-dependency-model/">transitiiviset riippuvuudet</a>.</p>

<p>Projektiin asentui expressin versio 4.16.2. Mitä tarkoittaa <em>package.json:issa</em> versiomerkinnän edessä oleva väkänen, eli miksi muoto on</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.16.2"</span><span class="w">
</span></code></pre></div></div>

<p>npm:n yhteydessä käytetään ns. <a href="https://docs.npmjs.com/getting-started/semantic-versioning">semanttista versiointia</a>.</p>

<p>Merkintä <em>^4.16.2</em> tarkoittaa, että jos/kun projektin riippuvuudet päivitetään, asennetaan expressistä versio, joka on vähintään <em>4.16.2</em>, mutta asennetuksi voi tulla versio, jonka <em>patch</em> eli viimeinen numero tai <em>minor</em> eli keskimmäinen numero voi olla suurempi. Pääversio eli <em>major</em> täytyy kuitenkin olla edelleen sama.</p>

<p>Voimme päivittää projektin riippuvuudet komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm update
</code></pre></div></div>

<p>Vastaavasti jos aloitamme projektin koodaamisen toisella koneella, saamme haettua ajantasaiset, <em>package.json</em>:in määrittelyn kanssa yhteensopivat riippuvuudet komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install
</code></pre></div></div>

<p>Jos riippuvuuden <em>major</em>-versionumero ei muutu, uudempien versioiden pitäisi olla <a href="https://en.wikipedia.org/wiki/Backward_compatibility">taaksepäin yhteensopivia</a>, eli jos ohjelmamme käyttäisi tulevaisuudessa esim. expressin versiota 4.99.175, tässä osassa tehtävän koodin pitäisi edelleen toimia ilman muutoksia. Sen sijaan tulevaisuudessa joskus julkaistava express 5.0.0. voi sisältää sellaisia muutoksia, että koodimme ei enää toimisi.</p>

<h3 id="web-ja-express">Web ja express</h3>

<p>Palataan taas sovelluksen ääreen ja muutetaan se muotoon:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="kd">let</span> <span class="nx">notes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">...</span>
<span class="p">]</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'&lt;h1&gt;Hello World!&lt;/h1&gt;'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">)</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3001</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Jotta sovelluksen uusi versio saadaan käyttöön, on sovellus uudelleenkäynnistettävä.</p>

<p>Sovellus ei muutu paljoa. Heti alussa otetaan käyttöön <em>express</em>, joka on tällä kertaa <em>funktio</em>, jota kutsumalla luodaan muuttujaan <em>app</em> sijoitettava express-sovellusta vastaava olio:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
</code></pre></div></div>

<p>Seuraavaksi määritellään sovellukselle kaksi <em>routea</em>. Näistä ensimmäinen määrittelee tapahtumankäsittelijän, joka hoitaa sovelluksen juureen eli polkuun <em>/</em> tulevia HTTP GET -pyyntöjä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'&lt;h1&gt;Hello World!&lt;/h1&gt;'</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tapahtumankäsittelijäfunktiolla on kaksi parametria. Näistä ensimmäinen eli <a href="http://expressjs.com/en/4x/api.html#req">request</a> sisältää kaikki HTTP-pyynnön tiedot ja toisen parametrin <a href="http://expressjs.com/en/4x/api.html#res">response</a>:n avulla määritellään, miten pyyntöön vastataan.</p>

<p>Koodissa pyyntöön vastataan käyttäen <em>response</em>-olion metodia <a href="http://expressjs.com/en/4x/api.html#res.send">send</a>, jonka kutsumisen seurauksena palvelin vastaa HTTP-pyyntöön lähettämällä vastaukseksi <em>send</em>:in parametrina olevan merkkijonon <em>&lt;h1&gt;Hello World!&lt;/h1&gt;</em>. Koska parametri on merkkijono, tulee vastauksessa <em>content-type</em>-headerin arvoksi <em>text/html</em>, statuskoodiksi tulee oletusarvoisesti 200.</p>

<p>Routeista toinen määrittelee tapahtumankäsittelijän, joka hoitaa sovelluksen polkuun <em>notes</em> tulevia HTTP GET -pyyntöjä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Pyyntöön vastataan <em>response</em>-olion metodilla <a href="http://expressjs.com/en/4x/api.html#res.json">json</a>, joka lähettää HTTP-pyynnön vastaukseksi parametrina olevaa Javascript-olioa (eli taulukkoa <em>notes</em>) vastaavan JSON-muotoisen merkkijonon. Express asettaa headerin <em>Content-type</em> arvoksi <em>application/json</em>.</p>

<p>Pieni huomio JSON-muodossa palautettavasta datasta.</p>

<p>Aiemmassa, pelkkää Nodea käyttämässä versiossa, jouduimme muuttamaan palautettavan datan json-muotoon metodilla <em>JSON.stringify</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">notes</span><span class="p">))</span>
</code></pre></div></div>

<p>Expressiä käytettäessä tämä ei ole tarpeen, sillä muunnos tapahtuu automaattisesti.</p>

<p>Kannattaa huomata, että <a href="https://en.wikipedia.org/wiki/JSON">JSON</a> on merkkijono, eikä Javascript-olio kuten muuttuja <em>notes</em>.</p>

<p>Seuraava interaktiivisessa <a href="https://nodejs.org/docs/latest-v8.x/api/repl.html">node-repl</a>:issä suoritettu kokeilu havainnollistaa asiaa:</p>

<p><img src="/assets/3/5.png" height="200" /></p>

<p>Saat käynnistettyä interaktiivisen node-repl:in kirjoittamalla komentoriville <em>node</em>. Esim. joidenkin komentojen toimivuuttaa on koodatessa kätevä tarkastaa konsolissa, suosittelen!</p>

<h2 id="nodemon">nodemon</h2>

<p>Jos muutamme sovelluksen koodia, joudumme uudelleenkäynnistämään sovelluksen (eli ensin sammuttamaan konsolista <em>ctrl</em> ja <em>c</em> ja sitten käynnistämään uudelleen), jotta muutokset tulisivat voimaan. Verrattuna Reactin mukavaan workflowhun, missä selain päivittyi automaattisesti koodin muuttuessa tuntuu uudelleenkäynnistely kömpelöltä.</p>

<p>Ongelmaan ratkaisu on <a href="https://github.com/remy/nodemon">nodemon</a>:</p>

<blockquote>
  <p>nodemon will watch the files in the directory in which nodemon was started, and if any files change, nodemon will automatically restart your node application.</p>
</blockquote>

<p>Asennetaan nodemon määrittelemällä se <em>kehitysaikaiseksi riippuvuudeksi</em> (development dependency) komennolla:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install <span class="nt">--save-dev</span> nodemon
</code></pre></div></div>

<p>Tiedoston <em>package.json</em> sisältö muuttuu seuraavasti:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  //...
  <span class="s2">"dependencies"</span>: <span class="o">{</span>
    <span class="s2">"express"</span>: <span class="s2">"^4.16.2"</span>
  <span class="o">}</span>,
  <span class="s2">"devDependencies"</span>: <span class="o">{</span>
    <span class="s2">"nodemon"</span>: <span class="s2">"^1.13.3"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Jos nodemon-riippuvuus kuitenkin meni normaaliin “dependencies”-ryhmään, päivitä package.json manuaalisesti vastaamaan yllä näkyvää (versiot kuitenkin säilyttäen).</p>

<p>Kehitysaikaisilla riippuvuuksilla tarkoitetaan työkaluja, joita tarvitaan ainoastaan sovellusta kehitettäessä, esim. testaukseen tai sovelluksen automaattiseen uudelleenkäynnistykseen kuten <em>nodemon</em>.</p>

<p>Kun sovellusta suoritetaan tuotantomoodissa, eli samoin kun sitä tullaan suorittamaan tuotantopalvelimella (esim. Herokussa, mihin tulemme kohta siirtämään sovelluksemme), ei kehitysaikaisia riippuvuuksia tarvita.</p>

<p>Voimme käynnistää ohjelman <em>nodemon</em>:illa seuraavasti:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node_modules/.bin/nodemon index.js
</code></pre></div></div>

<p>Sovelluksen koodin muutokset aiheuttavat nyt automaattisen palvelimen uudelleenkäynnistymisen. Kannattaa huomata, että vaikka palvelin uudelleenkäynnistyy automaattisesti, selain täytyy kuitenkin refreshata, sillä toisin kuin Reactin yhteydessä, meillä ei nyt ole eikä tässä skenaariossa (missä palautamme JSON-muotoista dataa) edes voisikaan olla selainta päivittävää <a href="https://gaearon.github.io/react-hot-loader/getstarted/">hot reload</a> -toiminnallisuutta.</p>

<p>Komento on ikävä, joten määritellään sitä varten <em>npm-skripti</em> tiedostoon <em>package.json</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  // ..
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"start"</span>: <span class="s2">"node index.js"</span>,
    <span class="s2">"watch"</span>: <span class="s2">"nodemon index.js"</span>,
    <span class="s2">"test"</span>: <span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span>
  <span class="o">}</span>,
  // ..
<span class="o">}</span>
</code></pre></div></div>

<p>Skriptissä ei ole tarvetta käyttää nodemonin polusta sen täydellistä muotoa <em>node_modules/.bin/nodemon</em> sillä <em>npm</em> osaa etsiä automaattisesti suoritettavaa tiedostoa kyseisestä hakemistosta.</p>

<p>Voimme nyt käynnistää palvelimen sovelluskehitysmoodissa komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run watch
</code></pre></div></div>

<p>Toisin kuin skriptejä <em>start</em> tai <em>test</em> suoritettaessa, joudumme sanomaan myös <em>run</em>.</p>

<h2 id="lisää-routeja">Lisää routeja</h2>

<p>Laajennetaan sovellusta siten, että se toteuttaa samanlaisen RESTful-periaatteeseen nojaavan HTTP-rajapinnan kun <a href="https://github.com/typicode/json-server#routes">json-server</a>.</p>

<h3 id="rest">REST</h3>

<p>Representational State Transfer eli REST on Roy Fieldingin vuonna 2000 ilmestyneessä <a href="https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm">väitöskirjassa</a> määritelty skaalautuvien web-sovellusten rakentamiseksi tarkoitettu arkkitehtuurityyli.</p>

<p>Emme nyt rupea määrittelemään REST:iä Fieldingiläisittäin tai rupea väittämään mitä REST on tai mitä se ei ole vaan otamme hieman <a href="https://en.wikipedia.org/wiki/Representational_state_transfer#Applied_to_Web_services">kapeamman näkökulman</a> miten REST tai RESTful API:t yleensä tulkitaan Web-sovelluksissa. Alkuperäinen REST-periaate ei edes sinänsä rajoitu Web-sovelluksiin.</p>

<p>Mainitsimme jo <a href="/osa2#rest-api:n-käyttö">edellisestä osassa</a>, että yksittäisiä asioita, meidän tapauksessamme muistiinpanoja kutsutaan RESTful-ajattelussa <em>resursseiksi</em>. Jokaisella resurssilla on URL eli sen yksilöivä osoite.</p>

<p>Erittäin yleinen konventio on muodostaa resurssien yksilöivät URLit liittäen resurssityypin nimi ja resurssin yksilöivä tunniste.</p>

<p>Oletetaan että palvelumme juuriosoite on <em>www.example.com/api</em></p>

<p>Jos nimitämme muistiinpanoja <em>note</em>-resursseiksi, yksilöidään yksittäinen muistiinpano, jonka tunniste on 10 URLilla <em>www.example.com/api/notes/10</em>.</p>

<p>Kaikkia muistiinpanoja edustavan kokoelmaresurssin URL taas on <em>www.example.com/api/notes</em></p>

<p>Resursseille voi suorittaa erilaisia operaatiota. Suoritettavan operaation määrittelee HTTP-operaation tyyppi, jota kutsutaan usein myös <em>verbiksi</em>:</p>

<table>
  <thead>
    <tr>
      <th>URL</th>
      <th>verbi</th>
      <th>toiminnallisuus</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>notes/10   </td>
      <td>GET</td>
      <td>hakee yksittäisen resurssin</td>
    </tr>
    <tr>
      <td>notes</td>
      <td>GET</td>
      <td>hakee kokoelman kaikki resurssit</td>
    </tr>
    <tr>
      <td>notes</td>
      <td>POST</td>
      <td>luo uuden resurssin pyynnön mukana olevasta datasta</td>
    </tr>
    <tr>
      <td>notes/10</td>
      <td>DELETE   </td>
      <td>poistaa yksilöidyn resurssin</td>
    </tr>
    <tr>
      <td>notes/10</td>
      <td>PUT</td>
      <td>korvaa yksilöidyn resurssin pyynnön mukana olevalla datalla</td>
    </tr>
    <tr>
      <td>notes/10</td>
      <td>PATCH</td>
      <td>korvaa yksilöidyn resurssin osan pyynnön mukana olevalla datalla</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Näin määrittyy suurin piirtein asia, mitä REST kutsuu nimellä <a href="https://en.wikipedia.org/wiki/Representational_state_transfer#Architectural_constraints">uniform interface</a>, eli jossain määrin yhtenäinen tapa määritellä rajapintoja, jotka mahdollistavat (tietyin tarkennuksin) järjestelmien yhteiskäytön.</p>

<p>Tämänkaltaista tapaa tulkita REST:iä on nimitetty kolmiportaisella asteikolla <a href="https://martinfowler.com/articles/richardsonMaturityModel.html">kypsyystason 2</a> REST:iksi. REST:in kehittäjän Roy Fieldingin mukaan tällöin kyseessä ei vielä ole ollenkaan asia, jota tulisi kutsua <a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">REST-apiksi</a>. Maailman “REST”-apeista valtaosa ei täytäkään puhdasverisen Fieldingiläisen REST-apin määritelmää.</p>

<p>Joissain yhteyksissä (ks. esim <a href="http://shop.oreilly.com/product/9780596529260.do">Richardsom, Ruby: RESTful Web Services</a>) edellä esitellyn kaltaista suoraviivaisehkoa resurssien <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a>-tyylisen manipuloinnin mahdollistavaa API:a nimitetään REST:in sijaan <a href="https://en.wikipedia.org/wiki/Resource-oriented_architecture">resurssipohjaiseksi</a> arkkitehtuurityyliksi. Emme nyt kuitenkaan takerru liian tarkasti määritelmällisiin asioihin vaan jatkamme sovelluksen parissa.</p>

<h3 id="yksittäisen-resurssin-haku">Yksittäisen resurssin haku</h3>

<p>Laajennetaan nyt sovellusta siten, että se tarjoaa muistiinpanojen operointiin REST-rajapinnan. Tehdään ensin <a href="http://expressjs.com/en/guide/routing.html">route</a> yksittäisen resurssin katsomista varten.</p>

<p>Yksittäisen muistiinpanon identifioi URL, joka on muotoa <em>notes/10</em>, missä lopussa oleva numero vastaa resurssin muistiinpanon id:tä.</p>

<p>Voimme määritellä expressin routejen poluille <a href="http://expressjs.com/en/guide/routing.html">parametreja</a> käyttämällä kaksoispistesyntaksia:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span> <span class="p">)</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Nyt <code>app.get('/notes/:id', ...)</code> käsittelee kaikki HTTP GET -pyynnöt, jotka ovat muotoa <em>note/JOTAIN</em>, missä <em>JOTAIN</em> on mielivaltainen merkkijono.</p>

<p>Polun parametrin <em>id</em> arvoon päästään käsiksi pyynnön tiedot kertovan olion <a href="http://expressjs.com/en/api.html#req">request</a> kautta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
</code></pre></div></div>

<p>Jo tutuksi tulleella taulukon <em>find</em>-metodilla haetaan taulukosta parametria vastaava muistiinpano ja palautetaan se pyynnön tekijälle.</p>

<p>Kun sovellusta testataan menemällä selaimella osoitteeseen <a href="http://localhost:3001/notes/1">http://localhost:3001/notes/1</a>, havaitaan että se ei toimi, selain näyttää tyhjältä. Tämä on tietenkin softadevaajan arkipäivää, ja on ruvettava debuggaamaan.</p>

<p>Vanha hyvä keino on alkaa lisäillä koodiin <em>console.log</em>-komentoja:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Konsoliin tulostuu</p>

<pre>
1
undefined
</pre>

<p>eli halutun muistiinpanon id välittyy sovellukseen aivan oikein, mutta <em>find</em> komento ei löydä mitään.</p>

<p>Päätetään tulostella konsoliin myös <em>find</em>-komennon sisällä olevasta vertailijafunktiosta, joka onnistuu helposti kun tiiviissä muodossa oleva funktio <code>note =&gt; note.id === id</code> kirjoitetaan eksplisiittisen returnin sisältävässä muodossa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span>
  <span class="p">})</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Jokaisesta vertailufunktion kutsusta tulostetaan nyt monta asiaa. Konsolin tulostus on seuraava:</p>

<pre>
1 'number' '1' 'string' false
2 'number' '1' 'string' false
3 'number' '1' 'string' false
</pre>

<p>ongelman syy selviää: muuttujassa <em>id</em> on tallennettuna merkkijono ‘1’ kun taas muistiinpanojen id:t ovat numeroita. Javascriptissä === vertailu katsoo kaikki eri tyyppiset arvot oletusarvoisesti erisuuriksi, joten 1 ei ole ‘1’.</p>

<p>Korjataan ongelma, muuttamalla parametrina oleva merkkijonomuotoinen id <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number">numeroksi</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>ja nyt yksittäisen resurssin hakeminen toimii</p>

<p><img src="/assets/3/6.png" height="200" /></p>

<p>toiminnallisuuteen jää kuitenkin pieni ongelma.</p>

<p>Jos haemme muistiinpanoa sellaisella indeksillä, mitä vastaavaa muistiinpanoa ei ole olemassa, vastaa palvelin seuraavasti</p>

<p><img src="http://localhost:4000/assets/3/7.png" alt="" /></p>

<p>HTTP-statuskoodi on onnistumisesta kertova 200. Vastaukseen ei liity dataa, sillä headerin <em>content-length</em> arvo on 0, ja samaa todistaa selain: mitään ei näy.</p>

<p>Syynä tälle käyttäytymiselle on se, että muuttujan <em>note</em> arvoksi tulee <em>undefined</em> jos muistiinpanoa ei löydy. Tilanne tulisi käsitellä palvelimella järkevämmin, eli statuskoodin 200 sijaan tulee vastata statuskoodilla <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 not found</a>.</p>

<p>Tehdään koodiin muutos</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">note</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Koska vastaukseen ei nyt liity mitään dataa käytetään statuskoodin asettavan metodin <a href="http://expressjs.com/en/4x/api.html#res.status">status</a> lisäksi metodia <a href="http://expressjs.com/en/4x/api.html#res.end">end</a> ilmoittamaan siitä, että pyyntöön tulee vastata ilman dataa.</p>

<p>Koodin haarautumisessa hyväksikäytetään sitä, että mikä tahansa Javascript-olio on <a href="https://developer.mozilla.org/en-US/docs/Glossary/Truthy">truthy</a>, eli katsotaan todeksi vertailuoperaatiossa. undefined taas on <a href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy">falsy</a> eli epätosi.</p>

<p>Nyt sovellus toimii, eli palauttaa oikean virhekoodin. Sovellus ei kuitenkaan palauta mitään käyttäjälle näytettävää kuten web-sovellukset yleensä tekevät jos mennään osoitteeseen jota ei ole olemassa. Emme kuitenkaan tarvitse nyt mitään näytettävää, sillä REST API:t ovat ohjelmalliseen käyttöön tarkoitettuja rajapintoja ja pyyntöön liitetty virheestä kertova statuskoodi on riittävä.</p>

<h3 id="resurssin-poisto">Resurssin poisto</h3>

<p>Toteutetaan seuraavaksi resurssin poistava route. Poisto tapahtuu tekemällä HTTP DELETE -pyyntö resurssin urliin:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="nx">notes</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">204</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Jos poisto onnistuu, eli poistettava muistiinpano on olemassa, vastataan statuskoodilla <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.5">204 no content</a> sillä mukaan ei lähetetä mitään dataa.</p>

<p>Ei ole täyttä yksimielisyyttä siitä mikä statuskoodi DELETE-pyynnöstä pitäisi palauttaa jos poistettavaa resurssia ei ole olemassa. Vaihtoehtoja ovat lähinnä 204 ja 404. Yksinkertaisuuden vuoksi sovellus palauttaa nyt molemmissa tilanteissa statuskoodin 204.</p>

<h3 id="postman">Postman</h3>

<p>Herää kysymys miten voimme testata poisto-operaatiota? HTTP GET -pyyntöjä on helppo testata selaimessa. Voisimme toki kirjoittaa Javascript-koodin, joka testaa deletointia, mutta jokaiseen mahdolliseen tilanteeseen testikoodinkaan tekeminen ei ole aina paras ratkaisu.</p>

<p>On olemassa useita backendin testaamista helpottavia työkaluja, eräs näistä on edellisessä osassa nopeasti mainittu komentorivityökalu <a href="https://curl.haxx.se">curl</a>.</p>

<p>Käytetään nyt kuitenkin <a href="https://www.getpostman.com/">postman</a>-nimistä sovellusta.</p>

<p>Asennetaan postman ja kokeillaan</p>

<p><img src="http://localhost:4000/assets/3/8.png" alt="" /></p>

<p>Postmanin käyttö on tässä tilanteessa suhteellisen yksinkertaista, riittää määritellä url ja valita oikea pyyntötyyppi.</p>

<p>Palvelin näyttää vastaavan oikein. Tekemällä HTTP GET osoitteeseen <em>http://localhost:3001/notes</em> selviää että poisto-operaatio oli onnistunut, muistiinpanoa, jonka id on 2 ei ole enää listalla.</p>

<p>Koska muistiinpanot on talletettu palvelimen muistiin, uudelleenkäynnistys palauttaa tilanteen ennalleen.</p>

<h3 id="visual-studio-coden-rest-client">Visual Studio Coden REST client</h3>

<p>Jos käytät Visual Studio Codea, voit postmanin sijaan käyttää VS Coden
<a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client">REST client</a> -pluginia.</p>

<p>Kun plugin on asennettu, on sen käyttö erittäin helppoa. Tehdään projektin juureen hakemisto <em>requests</em>, jonka sisään talletetaan REST Client -pyynnöt <em>.rest</em>-päätteisinä tiedostoina.</p>

<p>Luodaan kaikki muistiinpanot hakevan pyynnön määrittelevä tiedosto <em>get_all_notes.rest</em></p>

<p><img src="http://localhost:4000/images/3/8a.png" alt="" /></p>

<p>Klikkaamalla <em>Send request</em> -tekstiä, REST client suorittaa määritellyn HTTP-pyynnön ja palvelimen vastaus avautuu editoriin:</p>

<p><img src="http://localhost:4000/images/3/8b.png" alt="" /></p>

<h3 id="datan-vastaanottaminen">Datan vastaanottaminen</h3>

<p>Toteutetaan seuraavana uusien muistiinpanojen lisäys, joka siis tapahtuu tekemällä HTTP POST -pyyntö osoitteeseen <em>http://localhost:3001/notes</em> ja liittämällä pyynnön mukaan eli <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec7.html#sec7">bodyyn</a> luotavan muistiinpanon tiedot JSON-muodossa.</p>

<p>Jotta pääsisimme pyynnön mukana lähetettyyn dataan helposti käsiksi, tarvitsemme <a href="https://github.com/expressjs/body-parser">body-parser</a>-kirjaston apua.</p>

<p>Otetaan body-parser käyttöön ja luodaan alustava määrittely HTTP POST -pyynnön käsittelyyn</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>

<span class="c1">//...</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tapahtumankäsittelijäfunktio pääsee dataan käsiksi viittaamalla <em>request.body</em>.</p>

<p>Ilman body-parser-käyttöönottoa pyynnön kentän <em>body</em> arvo olisi ollut määrittelemätön. body-parserin toimintaperiaatteena on, että se ottaa pyynnön mukana olevan JSON-muotoisen datan, muuttaa sen Javascript-olioksi ja sijoittaa <em>request</em>-olion kenttään <em>body</em> ennen kuin routen käsittelijää kutsutaan.</p>

<p>Toistaiseksi sovellus ei vielä tee vastaanotetulle datalle mitään muuta kuin tulostaa sen konsoliin ja palauttaa sen pyynnön vastauksessa.</p>

<p>Ennen toimintalogiikan viimeistelyä varmistetaan ensin postmanilla, että lähetetty tieto menee varmasti perille. Pyyntötyypin ja urlin lisäksi on määriteltävä myös pyynnön mukana menevä data eli <em>body</em>:</p>

<p><img src="http://localhost:4000/assets/3/9.png" alt="" /></p>

<p>Näyttää kuitenkin siltä, että mitään ei mene perille, palvelin vastaanottaa ainoastaan tyhjän olion. Missä on vika? Olemme unohtaneet määritellä headerille <em>Content-Type</em> oikean arvon:</p>

<p><img src="/assets/3/10.png" height="200" /></p>

<p>Nyt kaikki toimii! Ilman oikeaa headerin arvoa palvelin ei osaa parsia dataa oikeaan muotoon. Se ei edes yritä arvailla missä muodossa data on, sillä potentiaalisia datan siirtomuotoja eli <em>Content-Typejä</em> on olemassa <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">suuri määrä</a>.</p>

<p>Jos käytät VS Codea niin edellisessä luvussa esitelty REST client kannattaa asentaa viimeistään <em>nyt</em>. POST-pyyntö tehdään REST clientillä seuraavasti:</p>

<p><img src="http://localhost:4000/images/3/8c.png" alt="" /></p>

<p>Eli pyyntöä varten on luotu oma tiedosto <em>new_note.rest</em>. Pyyntö on muotoiltu <a href="https://github.com/Huachao/vscode-restclient/blob/master/README.md#usage">dokumentaation ohjetta</a> noudatellen.</p>

<p>REST clientin eräs suuri etu postmaniin verratatuna on se, että pyynnöt saa kätevästi talletettua projektin repositorioon ja tällöin ne ovat helposti koko kehitystiimin käytössä. Postmanillakin on mahdollista tallettaa pyyntöjä, mutta tilanne menee helposti kaaoottiseksi etenkin jos työn alla on useita toisistaan riippumattomia projekteja.</p>

<blockquote>
  <p><strong>Tärkeä sivuhuomio</strong></p>

  <p>Välillä debugatessa tulee vastaan tilanteita, joissa backendissä on tarve selvittää mitä headereja HTTP-pyynnöille on asetettu. Eräs menetelmä tähän on <em>request</em>-olion melko kehnosti nimetty metodi <a href="http://expressjs.com/en/4x/api.html#req.get">get</a>, jonka avulla voi selvittää yksittäisen headerin arvon. <em>request</em>-oliolla on myös kenttä <em>headers</em>, jonka arvona ovat kaikki pyyntöön liittyvät headerit.</p>

  <p>Ongelmia voi esim syntyä jos jätät vahingossa VS REST clientillä ylimmän rivin ja headerit määrittelevien rivien väliin tyhjän rivin. Tällöin REST client tulkitsee, että millekään headerille ei aseteta arvoa ja näin backend ei osaa tulkita pyynnön mukana olevaa dataa JSON:iksi.</p>

  <p>Puuttuvan <em>content-type</em>-headerin ongelma selviää kun backendissa tulostaa pyynnön headerit esim. komennolla console.log(request.headers)</p>
</blockquote>

<p>Palataan taas sovelluksen pariin. Kun tiedämme, että sovellus vastaanottaa tiedon oikein, voimme viimeistellä sovelluslogiikan:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">maxId</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">?</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">reverse</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>
  <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">maxId</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="nx">notes</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Uudelle muistiinpanolle tarvitaan uniikki id. Ensin selvitetään olemassaolevista id:istä suurin muuttujaan <em>maxId</em>. Uuden muistiinpanon id:ksi asetetaan sitten <em>maxId+1</em>. Tämä tapa ei ole itseasiassa kovin hyvä, mutta emme nyt välitä siitä sillä tulemme pian korvaamaan tavan miten muistiinpanot talletetaan.</p>

<p>Tämän hetkisessä versiossa on vielä se ongelma, että voimme HTTP POST -pyynnöllä lisätä mitä tahansa kenttiä sisältäviä olioita. Parannellaan sovellusta siten, että kenttä <em>content</em> vaaditaan. Kentille <em>important</em> ja <em>date</em> asetetaan oletusarvot. Kaikki muut kentät hylätään:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">generateId</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">maxId</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">?</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">reverse</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="nx">maxId</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span><span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">generateId</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="nx">notes</span> <span class="o">=</span> <span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>

  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tunnisteena toimivan id-kentän arvon generointilogiikka on eriytetty funktioon <em>generateId</em>.</p>

<p>Jos kenttä <em>content</em> puuttuu, vastataan statuskoodilla <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 bad request</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Huomaa, että returnin kutsuminen on tärkeää, jos sitä ei tapahdu, jatkaa koodi suoritusta metodin loppuun asti ja virheellinen muistiinpano tallettuu tietokantaan!</p>

<p>Jos content-kentällä on arvo, luodaan muistiinpano syötteen perusteella. Kuten edellisessä osassa mainitsimme, aikaleimoja ei kannata luoda selaimen koodissa, sillä käyttäjän koneen kellon aikaan ei voi luottaa. Aikaleiman eli kentän <em>date</em> arvon generointi tapahtuukin nyt palvelimen toimesta.</p>

<p>Jos kenttä <em>important</em> puuttuu, asetetaan sille oletusarvo <em>false</em>. Oletusarvo generoidaan nyt hieman erikoisella tavalla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
</code></pre></div></div>

<p>jos sovelluksen vastaanottamassa muuttujaan <em>body</em> talletetussa datassa on kenttä <em>important</em>, tulee lausekkeelle sen arvo. Jos kenttää ei ole olemassa, tulee lausekkeen arvoksi oikeanpuoleinen osa eli <em>important</em>.</p>

<blockquote>
  <p>Jos ollaan tarkkoja, niin kentän <em>body.important</em> arvon ollessa <em>false</em>, tulee lausekkeen <code>body.important || false</code> arvoksi oikean puoleinen <em>false</em>…</p>
</blockquote>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part3-1">githubissa</a></p>

<p>Huomaa, että repositorion master-haarassa on myöhemmän vaiheen koodi, tämän hetken koodi on tagissa <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part3-1">part3-1</a>:</p>

<p><img src="http://localhost:4000/master/3/1b.png" alt="" /></p>

<p>Jos kloonaat projektin itsellesi, suorita komento <em>npm install</em> ennen käynnistämistä eli komentoa <em>npm start</em>.</p>

<h2 id="tehtäviä">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#expressin-alkeet">3.1-3.6</a></p>

<h2 id="huomioita-http-pyyntötyyppien-käytöstä">Huomioita HTTP pyyntötyyppien käytöstä</h2>

<p><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html">HTTP-standardi</a> puhuu pyyntötyyppien yhteydessä kahdesta ominaisuudesta, <strong>safe</strong> ja <strong>idempotent</strong>.</p>

<p>HTTP-pyynnöistä GET:in tulisi olla <em>safe</em>:</p>

<blockquote>
  <p>In particular, the convention has been established that the GET and HEAD methods SHOULD NOT have the significance of taking an action other than retrieval. These methods ought to be considered “safe”.</p>
</blockquote>

<p>Safety siis tarkoittaa, että pyynnön suorittaminen ei saa aiheutta palvelimelle <em>sivuvaikutuksia</em> eli esim. muuttaa palvelimen tietokannan tilaa, pyynnön tulee ainoastaan palauttaa palvelimella olevaa dataa.</p>

<p>Mikään ei automaattisesti takaa, että GET-pyynnöt olisivat luonteeltaan <em>safe</em>, kyseessä onkin HTTP-standardin suositus palvelimien toteuttajille. RESTful-periaatetta noudattaessa GET-pyyntöjä käytetäänkin aina siten, että ne ovat safe.</p>

<p>HTTP-standardi määrittelee myös pyyntötyypin <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.4">HEAD</a>, jonka tulee olla safe. Käytännössä HEAD:in tulee toimia kuten GET, mutta se ei palauta vastauksenaan muuta kuin statuskoodin ja headerit, viestin bodyä HEAD ei palauta ollenkaan.</p>

<p>HTTP-pyynnöistä muiden paitsi POST:in tulisi olla <em>idempotentteja</em>:</p>

<blockquote>
  <p>Methods can also have the property of “idempotence” in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single request. The methods GET, HEAD, PUT and DELETE share this property</p>
</blockquote>

<p>Eli jos pyynnöllä on sivuvaikutuksia, lopputulos on sama suoritetaanko pyyntö yhden tai useamman kerran.</p>

<p>Esim. jos tehdään HTTP PUT pyyntö osoitteeseen <em>/notes/10</em> ja pyynnön mukana on <code>{ content: "ei sivuvaikutuksia", important: true }</code>, on lopputulos sama riippumatta siitä kuinka monta kertaa pyyntö suoritetaan.</p>

<p>Kuten metodin GET <em>safety</em> myös <em>idempotence</em> on HTTP-standardin suositus palvelimien toteuttajille. RESTful-periaatetta noudattaessa GET, HEAD, PUT ja DELETE-pyyntöjä käytetäänkin aina siten, että ne ovat idempotentteja.</p>

<p>HTTP pyyntötyypeistä POST on ainoa joka ei ole <em>safe</em> eikä <em>idempotent</em>. Jos tehdään 5 kertaa HTTP POST -pyyntö osoitteeseen <em>/notes</em> siten että pyynnön mukana on <code>{ content: "monta samaa", important: true }</code>, tulee palvelimelle 5 saman sisältöistä muistiinpanoa.</p>

<h2 id="middlewaret">Middlewaret</h2>

<p>Äsken käyttöönottamamme <a href="https://github.com/expressjs/body-parser">body-parser</a> on terminologiassa niin sanottu <a href="http://expressjs.com/en/guide/using-middleware.html">middleware</a>.</p>

<p>Middlewaret ovat funktioita, joiden avulla voidaan käsitellä <em>request</em>- ja <em>response</em>-olioita.</p>

<p>Esim. body-parser ottaa pyynnön mukana tulevan raakadatan <em>request</em>-oliosta, parsii sen Javascript-olioksi ja sijoittaa olion <em>request</em>:in kenttään <em>body</em></p>

<p>Middlewareja voi olla käytössä useita jolloin ne suoritetaan peräkkäin siinä järjestyksessä kun ne on otettu koodissa käyttöön.</p>

<p>Toteutetaan itse yksinkertainen middleware, joka tulostaa konsoliin palvelimelle tulevien pyyntöjen perustietoja.</p>

<p>Middleware on funktio, joka saa kolme parametria:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Method:'</span><span class="p">,</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Path:  '</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Body:  '</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'---'</span><span class="p">)</span>
  <span class="nx">next</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Middleware kutsuu lopussa parametrina olevaa funktiota <em>next</em>, jolla se siirtää kontrollin seuraavalle middlewarelle.</p>

<p>Middleware otetaan käyttöön seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>
</code></pre></div></div>

<p>Middlewaret suoritetaan siinä järjestyksessä, jossa ne on otettu käyttään sovellusolion metodilla <em>use</em>. Middlewaret tulee myös määritellä ennen routeja jos ne halutaan suorittaa ennen niitä. On myös eräitä tapauksia, joissa middleware tulee määritellä vasta routejen jälkeen, käytännössä tällöin on kyse middlewareista, joita suoritetaan vain, jos mikään route ei käsittele HTTP-pyyntöä.</p>

<p>Lisätään routejen jälkeen seuraava middleware, jonka ansiosta saadaan routejen käsittelemättömistä virhetilanteista JSON-muotoinen virheilmoitus:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="na">error</span><span class="p">:</span> <span class="s1">'unknown endpoint'</span><span class="p">})</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="tehtäviä-1">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#lisää-middlewareja">3.7 ja 3.8</a></p>

<h2 id="yhteys-frontendiin">Yhteys frontendiin</h2>

<p>Palataan yritykseemme käyttää nyt tehtyä backendiä <a href="/osa2">osassa 2</a> tehdyllä React-frontendillä. Aiempi yritys lopahti seuraavaan virheilmoitukseen</p>

<p><img src="http://localhost:4000/assets/3/3.png" alt="" /></p>

<p>Frontendin tekemä GET-pyyntö osoitteeseen <a href="http://localhost:3001/notes">http://localhost:3001/notes</a> ei jostain syystä toimi. Mistä on kyse? Backend toimii kuitenkin selaimesta ja postmanista käytettäessä ilman ongelmaa.</p>

<h3 id="same-origin-policy-ja-cors">Same origin policy ja CORS</h3>

<p>Kyse on asiasta nimeltään CORS eli Cross-origin resource sharing. <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Wikipedian</a> sanoin</p>

<blockquote>
  <p>Cross-origin resource sharing (CORS) is a mechanism that allows restricted resources (e.g. fonts) on a web page to be requested from another domain outside the domain from which the first resource was served. A web page may freely embed cross-origin images, stylesheets, scripts, iframes, and videos. Certain “cross-domain” requests, notably Ajax requests, are forbidden by default by the same-origin security policy.</p>
</blockquote>

<p>Lyhyesti sanottuna meidän kontekstissa kyse on seuraavasta: websovelluksen selaimessa suoritettava Javascript-koodi saa oletusarvoisesti kommunikoida vain samassa <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">originissa</a> olevan palvelimen kanssa. Koska palvelin on localhostin portissa 3001 ja frontend localhostin portissa 3000, niiden origin ei ole sama.</p>

<p>Korostetaan vielä, että <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">same origin policy</a> ja CORS eivät ole mitenkään React- tai Node-spesifisiä asioita, vaan yleismaailmallisia periaatteita Web-sovellusten toiminnasta.</p>

<p>Voimme sallia muista <em>origineista</em> tulevat pyynnöt käyttämällä Noden <a href="https://github.com/expressjs/cors">cors</a>-middlewarea.</p>

<p>Asennetaan <em>cors</em> komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install cors <span class="nt">--save</span>
</code></pre></div></div>

<p>Otetaan middleware käyttöön ja sallitaan kaikki origineista tulevat pyynnöt:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cors'</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">())</span>
</code></pre></div></div>

<p>Nyt frontend toimii! Tosin muistiinpanojen tärkeäksi muuttavaa toiminnallisuutta backendissa ei vielä ole.</p>

<p>CORS:ista voi lukea tarkemmin esim. <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Mozillan sivuilta</a>.</p>

<h2 id="sovellus-internettiin">Sovellus internettiin</h2>

<p>Kun koko “stäkki” on saatu vihdoin kuntoon, siirretään sovellus internettiin. Viime aikoina on tullut uusia mielenkiintoisa sovellusten hostausmahdollisuuksia, esim. <a href="https://zeit.co">Zeit</a>. Käytetään seuraavassa vanhaa kunnon <a href="https://www.heroku.com">Herokua</a>.</p>

<p>Lisätään projektin juureen tiedosto <em>Procfile</em>, joka kertoo herokulle, miten sovellus käynnistetään</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>web: node index.js
</code></pre></div></div>

<p>Muutetaan tiedoston <em>index.js</em> lopussa olevaa sovelluksen käyttämän portin määrittelyä seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3001</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running on port </span><span class="p">${</span><span class="nx">PORT</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Nyt käyttöön tulee <a href="https://en.wikipedia.org/wiki/Environment_variable">ympäristömuuttujassa</a> <em>PORT</em> määritelty portti tai 3001 jos ympäristömuuttuja <em>PORT</em> ei ole määritelty. Heroku konfiguroi sovelluksen portin ympäristömuuttujan avulla.</p>

<p>Tehdään projektihakemistosta git-repositorio, lisätään <em>.gitignore</em> jolla seuraava sisältö</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node_modules
</code></pre></div></div>

<p>Luodaan heroku-sovellus komennolla <em>heroku create</em> ja deployataan sovellus komennoilla <em>git add -A</em>, <em>git commit -m "Initiate app."</em> ja <em>git push heroku master</em>.</p>

<p>Jos kaikki meni hyvin, sovellus toimii:</p>

<p><img src="http://localhost:4000/images/3/11b.png" alt="" /></p>

<p>Jos ei, vikaa voi selvittää herokun lokeja lukemalla, eli komennolla <em>heroku logs</em>.</p>

<p>Esim. tätä materiaalia tehdessä törmättiin ongelmaan joka aiheutti seuraavan tulostuksen lokeihin</p>

<p><img src="http://localhost:4000/assets/3/11.png" alt="" /></p>

<p>Syynä ongelmalle oli se, että middlewarea <em>cors</em> asennettaessa oli unohtunut antaa optio <strong>–save</strong>, joka tallentaa tiedon riippuvuudesta tiedostoon <em>package.json</em>. Koska näin kävi, ei Heroku ollut asentanut corsia sovelluksen käyttöön.</p>

<blockquote>
  <p><strong>HUOM</strong> ainakin alussa on järkevää tarkkailla herokussa olevan sovelluksen lokeja koko ajan. Parhaiten tämä onnistuu antamalla komento <em>heroku logs -t</em>, jolloin logit tulevat konsoliin sitä mukaan kun palvelimella tapahtuu jotain.</p>
</blockquote>

<p>Myös frontend toimii herokussa olevan backendin avulla. Voit varmistaa asian muuttamalla frontendiin määritellyn backendin osoitteen viittaamaan <em>localhost:3001</em>:n sijaan herokussa olevaan backendiin.</p>

<p>Seuraavaksi herää kysymys miten saamme myös frontendin internettiin? Vaihtoehtoja on useita.</p>

<h3 id="frontendin-tuotantoversio">Frontendin tuotantoversio</h3>

<p>Olemme toistaiseksi suorittaneet React-koodia <em>sovelluskehitysmoodissa</em>, missä sovellus on konfiguroitu antamaan havainnollisia virheilmoituksia, päivittämään koodiin tehdyt muutokset automaattisesti selaimeen ym.</p>

<p>Kun sovellus viedään tuotantoon, täytyy siitä tehdä <a href="https://reactjs.org/docs/optimizing-performance.html#use-the-production-build">production build</a>
eli tuotantoa varten optimoitu versio.</p>

<p>create-react-app:in avulla tehdyistä sovelluksista saadaan muodostettua tuotantoversio komennolla <a href="https://github.com/facebookincubator/create-react-app#npm-run-build-or-yarn-build">npm run build</a>.</p>

<p>Suoritetaan nyt komento frontendin projektin juuressa.</p>

<p>Komennon seurauksena syntyy hakemiston <em>build</em> (joka sisältää jo sovelluksen ainoan html-tiedoston <em>index.html</em>) sisään hakemisto <em>static</em>, minkä alle generoituu sovelluksen Javascript-koodin <a href="https://en.wikipedia.org/wiki/Minification_(programming)">minifioitu</a> versio. Vaikka sovelluksen koodi on kirjoitettu useaan tiedostoon, generoituu kaikki Javascript yhteen tiedostoon, samaan tiedostoon tulee itseasiassa myös kaikkien sovelluksen koodin tarvitsemien riippuvuuksien koodi.</p>

<p>Minifioitu koodi ei ole miellyttävää luettavaa. Koodin alku näyttää seuraavalta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">function</span> <span class="nx">t</span><span class="p">(</span><span class="nx">r</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">n</span><span class="p">[</span><span class="nx">r</span><span class="p">])</span><span class="k">return</span> <span class="nx">n</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">exports</span><span class="p">;</span><span class="kd">var</span> <span class="nx">o</span><span class="o">=</span><span class="nx">n</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="na">i</span><span class="p">:</span><span class="nx">r</span><span class="p">,</span><span class="na">l</span><span class="p">:</span><span class="o">!</span><span class="mi">1</span><span class="p">,</span><span class="na">exports</span><span class="p">:{}};</span><span class="k">return</span> <span class="nx">e</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span><span class="nx">o</span><span class="p">,</span><span class="nx">o</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span><span class="nx">t</span><span class="p">),</span><span class="nx">o</span><span class="p">.</span><span class="nx">l</span><span class="o">=!</span><span class="mi">0</span><span class="p">,</span><span class="nx">o</span><span class="p">.</span><span class="nx">exports</span><span class="p">}</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="p">{};</span><span class="nx">t</span><span class="p">.</span><span class="nx">m</span><span class="o">=</span><span class="nx">e</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">c</span><span class="o">=</span><span class="nx">n</span><span class="p">,</span><span class="nx">t</span><span class="p">.</span><span class="nx">d</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">){</span><span class="nx">t</span><span class="p">.</span><span class="nx">o</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span><span class="o">||</span><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">n</span><span class="p">,{</span><span class="na">configurable</span><span class="p">:</span><span class="o">!</span><span class="mi">1</span><span class="p">,</span><span class="na">enumerable</span><span class="p">:</span><span class="o">!</span><span class="mi">0</span><span class="p">,</span><span class="na">get</span><span class="p">:</span><span class="nx">r</span><span class="p">})},</span><span class="nx">t</span><span class="p">.</span><span class="nx">n</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="nx">e</span><span class="o">&amp;&amp;</span><span class="nx">e</span><span class="p">.</span><span class="nx">__esModule</span><span class="p">?</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="k">default</span><span class="p">}:</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">e</span><span class="p">};</span><span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span><span class="s2">"a"</span><span class="p">,</span><span class="nx">n</span><span class="p">),</span><span class="nx">n</span><span class="p">},</span><span class="nx">t</span><span class="p">.</span><span class="nx">o</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">t</span><span class="p">){</span><span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">t</span><span class="p">)},</span><span class="nx">t</span><span class="p">.</span><span class="nx">p</span><span class="o">=</span><span class="s2">"/"</span><span class="p">,</span><span class="nx">t</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">s</span><span class="o">=</span><span class="mi">12</span><span class="p">)}([</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">){</span><span class="s2">"use strict"</span><span class="p">;</span><span class="kd">function</span> <span class="nx">r</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="s2">"[object Array]"</span><span class="o">===</span><span class="nx">E</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">e</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">o</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="s2">"[object ArrayBuffer]"</span><span class="o">===</span><span class="nx">E</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">e</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">a</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="s2">"undefined"</span><span class="o">!==</span><span class="k">typeof</span> <span class="nx">FormData</span><span class="o">&amp;&amp;</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">FormData</span><span class="p">}</span><span class="kd">function</span> <span class="nx">i</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="s2">"undefined"</span><span class="o">!==</span><span class="k">typeof</span> <span class="nb">ArrayBuffer</span><span class="o">&amp;&amp;</span><span class="nb">ArrayBuffer</span><span class="p">.</span><span class="nx">isView</span><span class="p">?</span><span class="nb">ArrayBuffer</span><span class="p">.</span><span class="nx">isView</span><span class="p">(</span><span class="nx">e</span><span class="p">):</span><span class="nx">e</span><span class="o">&amp;&amp;</span><span class="nx">e</span><span class="p">.</span><span class="nx">buffer</span><span class="o">&amp;&amp;</span><span class="nx">e</span><span class="p">.</span><span class="nx">buffer</span> <span class="k">instanceof</span> <span class="nb">ArrayBuffer</span><span class="p">}</span><span class="kd">function</span> <span class="nx">u</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="s2">"string"</span><span class="o">===</span><span class="k">typeof</span> <span class="nx">e</span><span class="p">}</span><span class="kd">function</span> <span class="nx">l</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="s2">"number"</span><span class="o">===</span><span class="k">typeof</span> <span class="nx">e</span><span class="p">}</span><span class="kd">function</span> <span class="nx">s</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="s2">"undefined"</span><span class="o">===</span><span class="k">typeof</span> <span class="nx">e</span><span class="p">}</span><span class="kd">function</span> <span class="nx">c</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="kc">null</span><span class="o">!==</span><span class="nx">e</span><span class="o">&amp;&amp;</span><span class="s2">"object"</span><span class="o">===</span><span class="k">typeof</span>
</code></pre></div></div>

<h3 id="staattisten-tiedostojen-tarjoaminen-backendistä">Staattisten tiedostojen tarjoaminen backendistä</h3>

<p>Eräs mahdollisuus frontendin tuotantoon viemiseen on kopioida tuotantokoodi, eli hakemisto <em>build</em> backendin repositorion juureen ja määritellä backend näyttämään pääsivunaan frontendin <em>pääsivu</em>, eli tiedosto <em>build/index.html</em>.</p>

<p>Aloitetaan kopioimalla frontendin tuotantokoodi backendin alle, projektin juureen. Omalla koneellani kopiointi tapahtuu frontendin hakemistosta käsin komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp <span class="nt">-r</span> build ../../osa3/notebackend
</code></pre></div></div>

<p>Backendin sisältävän hakemiston tulee nyt näyttää seuraavalta:</p>

<p><img src="http://localhost:4000/images/3/11x.png" alt="" /></p>

<p>Jotta saamme expressin näyttämään <em>staattista sisältöä</em> eli sivun <em>index.html</em> ja sen lataaman Javascriptin ym. tarvitsemme expressiin sisäänrakennettua middlewarea <a href="http://expressjs.com/en/starter/static-files.html">static</a>.</p>

<p>Kun lisäämme muiden middlewarejen määrittelyn yhteyteen seuraavan</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">'build'</span><span class="p">))</span>
</code></pre></div></div>

<p>tarkastaa express GET-tyyppisten HTTP-pyyntöjen yhteydessä ensin löytyykö pyynnön polkua vastaavan nimistä tiedostoa hakemistosta <em>build</em>. Jos löytyy, palauttaa express tiedoston.</p>

<p>Nyt HTTP GET -pyyntö osoitteeseen <em>www.palvelimenosoite.com/index.html</em> tai <em>www.palvelimenosoite.com</em> näyttää Reactilla tehdyn frontendin. GET-pyynnön esim. osoitteeseen <em>www.palvelimenosoite.com/notes</em> hoitaa backendin koodi.</p>

<p>Koska tässä tapauksessa sekä frontend että backend toimivat samassa osoitteessa, voidaan React-sovelluksessa tapahtuva backendin <em>baseUrl</em> määritellä <a href="https://www.w3.org/TR/WD-html40-970917/htmlweb.html#h-5.1.2">suhteellisena</a> URL:ina, eli ilman palvelinta yksilöivää osaa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>
<span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'/notes'</span>

<span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>Muutoksen jälkeen on luotava uusi production build ja kopioitava se backendin repositorion juureen.</p>

<p>Sovellusta voidaan käyttää nyt <em>backendin</em> osoitteesta <a href="http://localhost:3001">http://localhost:3001</a>:</p>

<p><img src="http://localhost:4000/images/3/11f.png" alt="" /></p>

<p>Sovelluksemme toiminta vastaa nyt täysin osan 0 luvussa <a href="/osa0#Single-page-app">Single page app</a> läpikäydyn esimerkkisovelluksen toimintaa.</p>

<p>Kun mennään selaimella osoitteeseen <a href="http://localhost:3001">http://localhost:3001</a> palauttaa palvelin hakemistossa <em>build</em> olevan tiedoston <em>index.html</em>, jonka sisältö hieman tiivistettynä on seuraava:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>React App<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"/static/css/main.d2f2b65b.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"root"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"/static/js/main.c18b620c.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Sivu sisältää ohjeen ladata sovelluksen tyylit määrittelevän CSS-tiedoston, sekä <em>script</em>-tagin, jonka ansiosta selain lataa sovelluksen Javascript-koodin, eli varsinaisen React-sovelluksen.</p>

<p>React-koodi hakee palvelimelta muistiinpanot osoitteesta <a href="http://localhost:3001/api/notes">http://localhost:3001/api/notes</a> ja renderöi ne ruudulle. Selaimen ja palvelimen kommunikaatio selviää tuttuun tapaan konsolin välilehdeltä <em>Network</em>:</p>

<p><img src="http://localhost:4000/images/3/11g.png" alt="" /></p>

<p>Kun sovelluksen “internettiin vietävä” versio todetaan toimivan paikalliseksi, commitoidaan frontendin tuotantoversio backendin repositorioon ja pushataan koodi uudelleen herokuun.</p>

<p><a href="https://fullstack-notes.herokuapp.com">Sovellus</a> toimii moitteettomasti lukuunottamatta vielä backendiin toteuttamatonta muistiinpanon tärkeyden muuttamista:</p>

<p><img src="http://localhost:4000/images/3/11c.png" alt="" /></p>

<blockquote>
  <p><strong>HUOM</strong> ennen pushaamista on tietysti muistettava lisätä hakemisto <em>build</em> repositorioon!</p>
</blockquote>

<p>Sovelluksemme tallettama tieto ei ole ikuisesti pysyvää, sillä sovellus tallettaa muistiinpanot muuttujaan. Jos sovellus kaatuu tai se uudelleenkäynnistetään, kaikki tiedot katoavat.</p>

<p>Tarvitsemme sovelluksellemme tietokannan. Ennen tietokannan käyttöönottoa katsotaan kuitenkin vielä muutamaa asiaa.</p>

<h2 id="frontendin-deployauksen-suoraviivaistus">Frontendin deployauksen suoraviivaistus</h2>

<p>Jotta uuden frontendin version generointi onnistuisi jatkossa ilman turhia manuaalisia askelia, tehdään frontendin repositorion juureen yksinkertainen shell-scripti, joka suorittaa uuden tuotantoversion buildaamisen eli komennon <em>npm run build</em> ja sen siirron backendin alle. Annetaan skriptille nimeksi <em>deploy.sh</em>. Sisältö on seuraava</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
npm run build
cp <span class="nt">-r</span> build ../../osa3/notebackend/
</code></pre></div></div>

<p>Skripille pitää antaa vielä suoritusoikeudet:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod u+x deploy.sh
</code></pre></div></div>

<p>Skripti voidaan suorittaa frontendin juuresta komennolla <em>./deploy.sh</em></p>

<h3 id="backendin-urlit">Backendin urlit</h3>

<p>Backendin tarjoama muistiinpanojen käsittelyn rajapinta on nyt suoraan sovelluksen URL:in <a href="https://fullstack-notes.herokuapp.com">https://fullstack-notes.herokuapp.com</a> alla. Eli <a href="https://fullstack-notes.herokuapp.com/notes">https://fullstack-notes.herokuapp.com/notes</a> on kaikkien mustiinpanojen lista ym. Koska backendin roolina on tarjota frontendille koneluettava rajapinta, eli API, olisi ehkä parempi erottaa API:n tarjoama osoitteisto selkeämmin, esim. aloittamalla kaikki sanalla <em>api</em>.</p>

<p>Tehdään muutos ensin muuttamalla käsin <strong>kaikki backendin routet</strong>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//...</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">)</span>
<span class="p">})</span>
<span class="c1">//...</span>
</code></pre></div></div>

<p>Frontendin koodiin riittää seuraava muutos</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>
<span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'/api/notes'</span>

<span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div>

<p>Muutosten jälkeen esim. kaikki muistiinpanot tarjoavan API-endpointin osoite on  <a href="https://fullstack-notes.herokuapp.com/api/notes">https://fullstack-notes.herokuapp.com/api/notes</a></p>

<p><img src="http://localhost:4000/images/3/11d.png" alt="" /></p>

<p>Frontend on edelleen sovelluksen juuressa eli osoitteessa <a href="https://fullstack-notes.herokuapp.com/">https://fullstack-notes.herokuapp.com/</a>.</p>

<blockquote>
  <p>Sivuhuomautus: API:en versiointi</p>

  <p>Joskus API:n urleissa ilmaistaan myös API:n versio. Eri versioita saatetaan tarvita, jos aikojen kuluessa API:in tehdään laajennuksia, jotka ilman versiointia hajoittaisivat olemassaolevia osia ohjelmista. Versioinnin avulla voidaan tuoda vanhojen rinnalle uusia, hieman eri tavalla toimivia versioita API:sta.</p>

  <p>API:n version ilmaiseminen URL:issa ei kuitenkaan ole välttämättä, ainakaan kaikkien mielestä järkevää vaikka tapaa paljon käytetäänkin. Oikeasta tavasta API:n versiointiin <a href="https://stackoverflow.com/questions/389169/best-practices-for-api-versioning">kiistellään ympäri internettiä</a>.</p>
</blockquote>

<h3 id="proxy">Proxy</h3>

<p>Frontendiin tehtyjen muutosten seurauksena on nyt se, että kun suoritamme frontendiä sovelluskehitysmoodissa, eli käynnistämällä sen komennolla <em>npm start</em>, yhteys backendiin ei toimi:</p>

<p><img src="http://localhost:4000/images/3/11e.png" alt="" /></p>

<p>Syynä tälle on se, että backendin osoite muutettiin suhteellisesti määritellyksi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'/api/notes'</span>
</code></pre></div></div>

<p>Koska frontend toimii osoitteessa <em>localhost:3000</em>, menevät backendiin tehtävät pyynnöt väärään osoitteeseen <em>localhost:3000/api/notes</em>. Backend toimii kuitenkin osoitteessa <em>localhost:3001</em></p>

<p>create-react-app:illa luoduissa projekteissa ongelma on helppo ratkaista. Riittää, että frontendin repositorion tiedostoon <em>package.json</em> lisätään seuraava määritelmä:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"dependencies"</span>: <span class="o">{</span>
    // ...
  <span class="o">}</span>,
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    // ...
  <span class="o">}</span>,
  <span class="s2">"proxy"</span>: <span class="s2">"http://localhost:3001"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Uudelleenkäynnistyksen jälkeen Reactin sovelluskehitysympäristö toimii <a href="https://github.com/facebookincubator/create-react-app/blob/master/packages/react-scripts/template/README.md#proxying-api-requests-in-development">proxynä</a> ja jos React-koodi tekee HTTP-pyynnön palvelimen <em>http://localhost:3000</em> johonkin osoitteeseen joka ei ole React-sovelluksen vastuulla (eli kyse ei ole esim. sovelluksen Javascript-koodin tai CSS:n lataamisesta), lähetetään pyyntö edelleen osoitteessa <em>http://localhost:3001</em> olevalle palvelimelle.</p>

<p>Nyt myös frontend on kunnossa, se toimii sekä sovelluskehitysmoodissa että tuotannossa yhdessä palvelimen kanssa.</p>

<p>Eräs negatiivinen puoli käyttämässämme lähestymistavassa on se, että sovelluksen uuden version tuotantoon vieminen edellyttää frontendin koodin tuotantoversion generoinnista ja sen backendin repositorioin kopioimisesta huolehtivan skriptin <em>delpoy.sh</em> suorittamisen. Tämä taas hankaloittaa automatisoidun <a href="https://martinfowler.com/bliki/DeploymentPipeline.html">deployment pipelinen</a> toteuttamista. Deployment pipelinellä tarkoitetaan automatisoitua ja hallittua tapaa viedä koodi sovelluskehittäjän koneelta erilaisten testien ja laadunhallinnallisten vaiheiden kautta tuotantoympäristöön.</p>

<p>Tähänkin on useita erilaisia ratkaisuja (esim. sekä frontendin että backendin <a href="https://github.com/mars/heroku-cra-node">sijoittaminen samaan repositorioon</a>), emme kuitenkaan nyt mene niihin.</p>

<p>Myös frontendin koodin deployaaminen omana sovelluksenaan voi joissain tilanteissa olla järkevää. create-react-app:in avulla luotujen sovellusten osalta se on <a href="https://github.com/mars/create-react-app-buildpack">suoraviivaista</a>.</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part3-2">githubissa</a>, tagissa <em>part3-2</em>.</p>

<h2 id="tehtäviä-2">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#yhteys-frontendiin-ja-vienti-tuotantoon">3.9-3.11</a></p>

<h2 id="node-sovellusten-debuggaaminen">Node-sovellusten debuggaaminen</h2>

<p>Node-sovellusten debuggaaminen on jossain määrin hankalampaa kuin selaimessa toimivan Javascriptin.</p>

<p>Vanha hyvä keino on tietysti konsoliin tulostelu. Se kannattaa aina. On mielipiteitä, joiden mukaan konsoliin tulostelun sijaan olisi syytä suosia jotain kehityneempää menetelmää, mutta en ole ollenkaan samaa mieltä. Jopa maailman aivan eliittiin kuuluvat open source -kehittäjät <a href="https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html">käyttävät</a> tätä <a href="https://swizec.com/blog/javascript-debugging-slightly-beyond-console-log/swizec/6633">mentelmää</a>.</p>

<h3 id="visual-studio-code">Visual Studio Code</h3>

<p>Visual Studio Coden debuggeri voi olla hyödyksi joissain tapauksissa. Seuraavassa screenshot, missä koodi on pysäytetty kesken uuden muistiinpanon lisäyksen</p>

<p><img src="http://localhost:4000/images/3/17a.png" alt="" /></p>

<p>Koodi on pysähtynyt nuolen osoittaman <em>breakpointin</em> kohdalle ja konsoliin on evaluoitu muuttujan <em>request.params</em> arvo. Vasemmalla olevassa ikkunassa on nähtävillä myös muuta ohjelman tilaan liittyvää.</p>

<p>Ylhäällä olevista nuolista yms. voidaan kontrolloida debuggauksen etenemistä.</p>

<p>Itse en juurikaan käytä Visual Studio Code debuggeria.</p>

<h3 id="chromen-dev-tools">Chromen dev tools</h3>

<p>Debuggaus onnisuu myös Chromen developer-konsolilla, käynnistämällä sovellus komennolla:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node <span class="nt">--inspect</span> index.js
</code></pre></div></div>

<p>Debuggeriin pääsee käsiksi kirjoittamalla chromen osoiteriville</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chrome://inspect
</code></pre></div></div>

<p>Avautuvasta näkymästä valitaan debugattava sovellus:</p>

<p><img src="http://localhost:4000/assets/3/18.png" alt="" /></p>

<p>Debuggausnäkymä toimii kuten React-koodia debugattaessa, <em>source</em>-välilehdelle voidaan esim. asettaa breakpointeja, eli kohtia joihin suoritus pysähtyy:</p>

<p><img src="http://localhost:4000/images/3/19a.png" alt="" /></p>

<p>Kaikki sovelluksen console.log-tulostukset tulevat debuggerin <em>Console</em>-välilehdelle. Voit myös tutkia siellä muuttujien arvoja ja suorittaa mielivaltaista Javascript-koodia:</p>

<p><img src="http://localhost:4000/images/3/20a.png" alt="" /></p>

<h3 id="epäile-kaikkea">Epäile kaikkea</h3>

<p>Full Stack -sovellusten debuggaaminen vaikuttaa alussa erittäin hankalalta. Kun kohta kuvaan tulee myös tietokanta ja frontend on yhdistetty backendiin, on potentiaalisia virhelähteitä todella paljon.</p>

<p>Kun sovellus “ei toimi”, onkin selvitettävä missä vika on. On erittäin yleistä, että vika on sellaisessa paikassa, mitä ei osaa ollenkaan epäillä, ja menee minuutti-, tunti- tai jopa päiväkausia ennen kuin oikea ongelmien lähde löytyy.</p>

<p>Avainasemassa onkin systemaattisuus. Koska virhe voi olla melkein missä vaan, kaikkea pitää epäillä, ja tulee pyrkiä poissulkemaan ne osat tarkastelusta, missä virhe ei ainakaan ole. Konsoliin kirjoitus, Postman, debuggeri ja kokemus auttavat.</p>

<p>Virheiden ilmaantuessa ylivoimaisesti huonoin strategia on jatkaa koodin kirjoittamista. Se on tae siitä, että koodissa on pian kymmenen ongelmaa lisää ja niiden syyn selvittäminen on entistäkin vaikeampaa. Toyota Production Systemin periaate <a href="http://gettingtolean.com/toyota-principle-5-build-culture-stopping-fix/#.Wjv9axP1WCQ">Stop and fix</a> toimii tässäkin yhteydessä paremmin kuin hyvin.</p>

<h2 id="mongo">Mongo</h2>

<p>Jotta saisimme talletettua muistiinpanot pysyvästi, tarvitsemme tietokannan. Useimmilla laitoksen kursseilla on käytetty relaatiotietokantoja. Tällä kurssilla käytämme <a href="https://www.mongodb.com/">MongoDB</a>:tä, joka on ns. <a href="https://en.wikipedia.org/wiki/Document-oriented_database">dokumenttitietokanta</a>.</p>

<p>Dokumenttitietokannat poikkeavat jossain määrin relaatiotietokannoista niin datan organisointitapansa kuin kyselykielensäkin suhteen. Dokumenttitietokantojen ajatellaan kuuluvan sateenvarjotermin <a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL</a> alle. Lisää dokumenttitietokannoista ja NoSQL:stä Tietokantojen perusteiden <a href="https://materiaalit.github.io/tikape-s17/part7/">viikon 7 materiaalista</a>.</p>

<p><strong>Lue nyt Tietokantojen perusteiden dokumenttitietokantoja kuvaava osuus.</strong> Jatkossa oletetaan, että hallitset käsitteet <em>dokumentti</em> ja <em>kokoelma</em> (collection).</p>

<p>MongoDB:n voi luonnollisesti asentaa omalle koneelle. Internetistä löytyy kuitenkin myös palveluna toimivia Mongoja (esim <a href="https://mlab.com/">mlab</a> ja <a href="https://www.mongodb.com/cloud/atlas">MongoDbCloud</a>) ja seuraava ohje olettaa, että käytössä on jo vuosien kokemuksella luotettavaksi havaittu <a href="https://mlab.com/">mlab</a>.</p>

<p>Mlab-kanta on helppo ottaa käyttöön suoraan <a href="https://elements.heroku.com/addons/mongolab">Herokun kautta</a>, vaikka tämä on maksutonta, edellyttää se luottokorttitietojen antamista Herokulle.</p>

<p>Määrittelemmekin seuraavassa kannan suoraan <a href="https://mlab.com/">mlab</a>:iin, jolloin luottokorttitietoja ei tarvita.</p>

<p>Aloita luomalla mlabiin käyttäjätili, saatuasi mlabilta verifiointimailin ja kirjauduttuasi mailin linkin kautta sisään, voit luoda tietokannan:</p>

<p><img src="http://localhost:4000/images/3/12a.png" alt="" /></p>

<p>Määrittele esim. <em>Amazon web services</em>, tyypiksi ilmainen <em>sandbox</em> ja sijoituspaikaksi Irlanti ja anna kannalle sopiva nimi.</p>

<p>Kun kanta on hetken kuluttua valmis, mene tietokannan hallintanäkymään</p>

<p><img src="http://localhost:4000/images/3/12b.png" alt="" /></p>

<p>Näkymä kertoo <em>MongoDB URI:n</em> eli osoitteen, jonka avulla sovelluksemme käyttämä MongoDB-kirjasto saa yhteyden kantaan.</p>

<p>Osoite näyttää seuraavalta:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;@ds211088.mlab.com:11088/fullstack-notes
</code></pre></div></div>

<p>Tarvitsemme kannan käyttöä varten <em>dbuserin</em> eli käyttäjätunnuksen. Käyttäjätunnuksen luominen tapahtuu tietokannan hallintanäkymästä</p>

<p><img src="http://localhost:4000/images/3/12c.png" alt="" /></p>

<p>Jos luotiin käyttäjätunnus <em>fullstack</em> jonka salasana on <em>sekred</em>, on tietokannan osoite seuraava:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongodb://fullstack:sekred@ds211088.mlab.com:11088/fullstack-notes
</code></pre></div></div>

<p>Olemme nyt valmiina kannan käyttöön.</p>

<p>Voisimme käyttää kantaa Javascript-koodista suoraan Mongon virallisen
<a href="https://mongodb.github.io/node-mongodb-native/">MongoDB Node.js driver</a> -kirjaston avulla, mutta se on ikävän työlästä. Käytämmekin hieman korkeammalla tasolla toimivaa <a href="http://mongoosejs.com/index.html">mongoose</a>-kirjastoa.</p>

<p>Mongoosesta voisi käyttää luonnehdintaa <em>object document mapper</em> (ODM), ja sen avulla Javascript-olioiden tallettaminen mongon dokumenteiksi on suoraviivaista.</p>

<p>Asennetaan mongoose:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install mongoose <span class="nt">--save</span>
</code></pre></div></div>

<p>Ei lisätä mongoa käsittelevää koodia heti backendin koodin sekaan, vaan tehdään erillinen kokeilusovellus tiedostoon <em>mongo.js</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="c1">// korvaa url oman tietokantasi urlilla. ethän laita salasanaa Gothubiin!</span>
<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'mongodb://fullstack:sekred@ds211088.mlab.com:11088/fullstack-notes'</span>

<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
  <span class="na">content</span><span class="p">:</span> <span class="s1">'HTML on helppoa'</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">})</span>

<span class="nx">note</span>
  <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'note saved!'</span><span class="p">)</span>
    <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Kun koodi suoritetaan komennolla <em>node mongo.js</em> lisää mongoose tietokantaaan uuden dokumentin.</p>

<p>Mlab:in hallintanäkymä näyttää lisäämämme datan:</p>

<p><img src="http://localhost:4000/images/3/13a.png" alt="" /></p>

<p>Kuten näkymä kertoo, on muistiinpanoa vastaava <em>dokumentti</em> lisätty kokoelmaan (collection) nimeltään <em>notes</em>.</p>

<p>Koodi sisältää muutamia mielenkiintoisia asioita. Aluksi avataan yhteys ja määritellään, että mongoose käyttää <em>promiseja</em>, eikä oldschool-takaisinkutsufunktioita:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'mongodb://fullstack:fullstack@ds211088.mlab.com:11088/fullstack-notes'</span>

<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</code></pre></div></div>

<p>Valitettavasti mongoosen dokumentaatiossa käytetään joka paikassa takaisinkutsufunktioita, joten sieltä ei kannata suoraan copypasteta koodia, sillä promisejen ja vanhanaikaisten callbackien sotkeminen samaan koodiin ei ole kovin järkevää.</p>

<div class="important">
Kannattaa muistaa, että tietokannan salasanaa ei kannata laittaa missään vaiheessa Githubiin!
</div>

<h3 id="skeema">Skeema</h3>

<p>Yhteyden avaamisen jälkeen määritellään mustiinpanoa vastaava <a href="http://mongoosejs.com/docs/models.html">model</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Modelin parametrina määritellään <em>muistiinpanon</em> <a href="http://mongoosejs.com/docs/guide.html">skeema</a>, joka kertoo mongooselle, miten muistiinpano-oliot tulee tallettaa tietokantaan.</p>

<p>Ensimmäisenä parametrina oleva <em>Note</em> määrittelee, että mongoose tallettaa muistiinpanoa vastaavat oliot kokoelmaan nimeltään <em>notes</em> sillä  <a href="http://mongoosejs.com/docs/models.html">mongoosen konventiona</a> on määritellä kokoelmien nimet monikossa (esim. <em>notes</em>), kun niihin viitataan modelin määrittelyssä yksikkömuodossa (esim. <em>Note</em>).</p>

<p>Mongoosen dokumentaatiossa skeema ja sitä vastaava model määritellään kumpikin erikseen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">noteSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="nx">noteSchema</span><span class="p">);</span>
</code></pre></div></div>

<p>Koska meillä ei ole skeema-oliolle muuta käyttöä kuin modelin parametrina, käytämme hyväksemme sitä, että skeema voidaan määritellä modeleille suoraan antamalla toisena parametrina skeeman määrittelevä olio.</p>

<p>Dokumenttikannat, kuten Mongo ovat <em>skeemattomia</em>, eli tietokanta itsessään ei välitä mitään sinne talletettavan tiedon muodosta. Samaan kokoelmaankin on mahdollista tallettaa olioita joilla on täysin eri kentät.</p>

<p>Mongoosea käytettäessä periaatteena on kuitenkin se, että tietokantaan talletettavalle tiedolle määritellään <em>sovelluksen koodin tasolla skeema</em>, joka määrittelee minkä muotoisia olioita kannan eri kokoelmiin talletetaan.</p>

<h3 id="olioiden-luominen-ja-tallettaminen">Olioiden luominen ja tallettaminen</h3>

<p>Seuraavaksi sovellus luo muistiinpanoa vastaavan <a href="http://mongoosejs.com/docs/models.html">model</a>:in avulla muistiinpano-olion:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
  <span class="na">content</span><span class="p">:</span> <span class="s1">'Selain pystyy suorittamaan vain javascriptiä'</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="na">important</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Modelit ovat ns. <em>konstruktorifunktioita</em>, jotka luovat parametrien perusteella Javascript-olioita. Koska oliot on luotu modelien konstruktorifunktiolla, niillä on kaikki modelien ominaisuudet, eli joukko metodeja, joiden avulla olioita voidaan mm. tallettaa tietokantaan.</p>

<p>Tallettaminen tapahtuu metodilla <em>save</em>. Metodi palauttaa <em>promisen</em>, jolle voidaan rekisteröidä <em>then</em>-metodin avulla tapahtumankäsittelijä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">note</span>
  <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'note saved!'</span><span class="p">)</span>
    <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Kun olio on tallennettu kantaan, kutsutaan <em>then</em>:in parametrina olevaa tapahtumankäsittelijää, joka sulkee tietokantayhteyden komennolla <code>mongoose.connection.close()</code>. Ilman yhteyden sulkemista ohjelman suoritus ei pääty.</p>

<p>Tallennusoperaation tulos on takaisinkutsun parametrissa <em>result</em>. Yhtä olioa tallentaessamme tulos ei ole kovin mielenkiintoinen, olion sisällön voi esim. tulostaa konsoliin jos haluaa tutkia sitä tarkemmin sovelluslogiikassa tai esim. debugatessa.</p>

<p>Talletetaan kantaan myös pari muuta muistiinpanoa muokkaamalla dataa koodista ja suorittamalla ohjelma uudelleen.</p>

<h3 id="olioiden-hakeminen-tietokannasta">Olioiden hakeminen tietokannasta</h3>

<p>Kommentoidaan koodista uusia muistiinpanoja generoiva osa, ja korvataan se seuraavalla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Note</span>
  <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">note</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>Kun koodi suoritetaan, kantaan talletetut muistiinpanot tulostuvat.</p>

<p>Oliot haetaan kannasta <em>Note</em>-modelin metodilla <a href="http://mongoosejs.com/docs/api.html#find_find">find</a>. Metodin parametrina on hakuehto. Koska hakuehtona on tyhjä olio <code>{}</code>, saimme kannasta kaikki <em>notes</em>-kokoelmaan talletetut oliot.</p>

<p>Hakuehdot noudattavat mongon <a href="https://docs.mongodb.com/manual/reference/operator/">syntaksia</a>.</p>

<p>Voisimme hakea esim. ainoastaan tärkeät muistiinpanot seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Note</span>
  <span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="na">important</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">})</span>
</code></pre></div></div>

<h3 id="tehtäviä-3">Tehtäviä</h3>

<p>Tee nyt tehtävä <a href="/tehtävät#mongoosen-alkeet">3.12</a></p>

<h2 id="tietokantaa-käyttävä-backend">Tietokantaa käyttävä backend</h2>

<p>Nyt meillä on periaatteessa hallussamme riittävä tietämys ottaa mongo käyttöön sovelluksessamme.</p>

<p>Aloitetaan nopean kaavan mukaan, copypastetaan tiedostoon <em>index.js</em> mongoosen määrittelyt, eli</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'mongodb://fullstack:sekred@ds211088.mlab.com:11088/fullstack-notes'</span>

<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span>
<span class="p">})</span>
</code></pre></div></div>

<p>ja muutetaan kaikkien muistiinpanojen hakemisesta vastaava käsittelijä seuraavaan muotoon</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Voimme todeta selaimella, että backend toimii kaikkien dokumenttien näyttämisen osalta:</p>

<p><img src="http://localhost:4000/assets/3/14.png" alt="" /></p>

<p>Toiminnallisuus on muuten kunnossa, mutta frontend olettaa, että olioiden yksikäsitteinen tunniste on kentässä <em>id</em>. Emme myöskään halua näyttää frontendille mongon versiointiin käyttämää kenttää <em>__v</em>. Tehdään pieni apufunktio, jonka avulla yksittäinen muistiinpano saadaan muutettua mongon sisäisestä esitysmuodosta haluamaamme muotoon:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ja palautetaan HTTP-pyynnön vastauksena funktion avulla muotoiltuja oliota:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">))</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Nyt siis muuttujassa <em>notes</em> on taulukollinen mongon palauttamia olioita. Kun suoritamme operaation <code>notes.map(formatNote)</code> seurauksena on uusi taulukko, missä on jokaista alkuperäisen taulukon alkiota vastaava funktion <em>formatNote</em> avulla muodostettu alkio.</p>

<p>Jos kannasta haettavilla olioilla olisi suuri määrä kenttiä, apufunktio <em>formatNote</em> kannattaisi muotoilla hieman geneerisemmässä muodossa, esim:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">formattedNote</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">note</span><span class="p">.</span><span class="nx">_doc</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}</span>
  <span class="k">delete</span> <span class="nx">formattedNote</span><span class="p">.</span><span class="nx">_id</span>
  <span class="k">delete</span> <span class="nx">formattedNote</span><span class="p">.</span><span class="nx">__v</span>

  <span class="k">return</span> <span class="nx">formattedNote</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ensimmäinen rivi luo uuden olion, mihin kopioituu kaikki vanhan olion kentät. Uuteen olioon lisätään myös kenttä <em>id</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formattedNote</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">note</span><span class="p">.</span><span class="nx">_doc</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}</span>
</code></pre></div></div>

<p>Ennen olion palauttamista turhat kentät poistetaan.</p>

<p>Jos ohjelma käyttäisi muunkin tyyppisiä olioita kuin <em>muistiinpanoja</em> sopisi sama funktio niidenkin muotoiluun. Jatkon kannalta on kuitenkin parempi, että pidämme alkuperäisen version funktiosta.</p>

<p>On myös mahdollista estää mongoosea palauttamasta tiettyjen kenttien arvoa, tai pyytää sitä palauttamaan vain tietyt kentät. Saamme estettyä parametrin <em>__v</em>:n lisäämällä <em>find</em>-metodiin toiseksi parametriksi <em>{__v: 0}</em> seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">__v</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">notes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">))</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Kyselyjen palauttamien kenttien määrittely tapahtuu Mongon <a href="https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/">syntaksin mukaan</a>.</p>

<h3 id="tietokantamäärittelyjen-eriyttäminen-omaksi-moduuliksi">Tietokantamäärittelyjen eriyttäminen omaksi moduuliksi</h3>

<p>Ennen kuin täydennämme backendin muutkin osat käyttämään tietokantaa, eriytetään mongoose-spesifinen koodi omaan moduuliin.</p>

<p>Tehdään moduulia varten hakemisto <em>models</em> ja sinne tiedosto <em>note.js</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'mongodb://fullstack:sekred@ds211088.mlab.com:11088/fullstack-notes'</span>

<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Note'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">content</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
  <span class="na">important</span><span class="p">:</span> <span class="nb">Boolean</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Note</span>
</code></pre></div></div>

<p>Noden <a href="https://nodejs.org/docs/latest-v8.x/api/modules.html">moduulien</a> määrittely poikkeaa hiukan osassa 2 määrittelemistämme frontendin käyttämistä <a href="/osa2/#refaktorointia---moduulit">ES6-moduuleista</a>.</p>

<p>Moduulin ulos näkyvä osa määritellään asettamalla arvo muuttujalle <em>module.exports</em>. Asetamme arvoksi määritellyn modelin <em>Note</em>. Muut moduulin sisällä määritellyt asiat, esim. muuttujat <em>mongoose</em> ja <em>url</em> eivät näy moduulin käyttäjälle.</p>

<p>Moduulin käyttöönotto tapahtuu lisäämällä tiedostoon <em>index.js</em> seuraava rivi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./models/note'</span><span class="p">)</span>
</code></pre></div></div>

<p>Näin muuttuja <em>Note</em> saa arvokseen saman olion, jonka moduuli määrittelee.</p>

<h3 id="muut-operaatiot">Muut operaatiot</h3>

<p>Muutetaan nyt kaikki operaatiot tietokantaa käyttävään muotoon.</p>

<p>Uuden muistiinpanon luominen tapahtuu seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="na">error</span><span class="p">:</span> <span class="s1">'content missing'</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Note</span><span class="p">({</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">note</span>
    <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">savedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">))</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Muistiinpano-oliot siis luodaan <em>Note</em>-konstruktorifunktiolla. Pyyntöön vastataan <em>save</em>-operaation takaisinkutsufunktion sisällä. Näin varmistutaan, että operaatio vastaus tapahtuu vain jos operaatio on onnistunut. Palaamme virheiden käsittelyyn myöhemmin.</p>

<p>Takaisinkutsufunktion parametrina oleva <em>savedNote</em> on talletettu muistiinpano. HTTP-pyyntöön palautetaan kuitenkin siitä funktiolla <em>formatNote</em> formatoitu muoto:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">))</span>
</code></pre></div></div>
<p>Yksittäisen muistiinpanon tarkastelu muuttuu muotoon</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="frontendin-ja-backendin-yhteistominnallisuuden-varmistaminen">Frontendin ja backendin yhteistominnallisuuden varmistaminen</h3>

<p>Kun backendia laajennetaan, kannattaa sitä testailla aluksi <strong>ehdottomasti selaimella,  postmanilla tai VS Coden REST clientillä:</strong>. Seuraavassa kokeillaan uuden muistiinpanon luomista tietokannan käyttöönoton jälkeen:</p>

<p><img src="http://localhost:4000/images/3/14b.png" alt="" /></p>

<p>Vasta kun kaikki on todettu toimivaksi, kannattaa siirtyä testailemaan että muutosten jälkeinen backend toimii yhdessä myös frontendin kanssa. Kaikkien kokeilujen tekeminen ainoastaan frontendin kautta on todennäköisesti varsin tehotonta.</p>

<p>Todennäköisesti voi olla kannattavaa edetä frontin ja backin integroinnissa toiminnallisuus kerrallaan, eli ensin voidaan toteuttaa esim. kaikkien muistiinpanojen näyttäminen backendiin ja testata että toiminnallisuus toimii selaimella. Tämän jälkeen varmistetaan, että frontend toimii yhteen muutetun backendin kanssa. Kun kaikki on todettu olevan kunnossa, siirrytään seuraavan ominaisuuden toteuttamiseen.</p>

<p>Kun kuvioissa on mukana tietokanta, on tietokannan tilan tarkastelu mlabin hallintanäkymästä varsin hyödyllistä, usein myös suoraan tietokantaa käyttävät Node-apuohjelmat, kuten tiedostoon <em>mongo.js</em> kirjoittamamme koodi auttavat sovellukehityksen edetessä.</p>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part3-3">githubissa</a>, tagissa <em>part3-3</em>.</p>

<h3 id="tehtäviä-4">Tehtäviä</h3>

<p>Tee nyt tehtävät <a href="/tehtävät#backend-ja-tietokanta">3.13-3.15</a></p>

<h3 id="virheiden-käsittely">Virheiden käsittely</h3>

<p>Jos yritämme mennä selaimella sellaisen yksittäisen muistiinpanon sivulle, jota ei ole olemassa, eli esim. urliin <a href="http://localhost:3001/api/notes/5a3b80015b6ec6f1bdf68d">http://localhost:3001/api/notes/5a3b80015b6ec6f1bdf68d</a> missä <em>5a3b80015b6ec6f1bdf68d</em> ei ole minkään tietokannassa olevan muistiinpanon tunniste, jää selain “jumiin” sillä palvelin ei vastaa pyyntöön koskaan.</p>

<p>Palvelimen konsolissa näkyykin virheilmoitus:</p>

<p><img src="http://localhost:4000/assets/3/15.png" alt="" /></p>

<p>Kysely on epäonnistunut ja kyselyä vastaava promise mennyt tilaan <em>rejected</em>. Koska emme käsittele promisen epäonnistumista, ei pyyntöön vastata koskaan. Osassa 2 tutustuimme jo <a href="/osa2#promise-ja-virheet">promisejen virhetilanteiden käsittelyyn</a>.</p>

<p>Lisätään tilanteeseen yksinkertainen virheidenkäsittelijä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Kaikissa virheeseen päättyvissä tilanteissa HTTP-pyyntöön vastataan statuskoodilla 404 not found. Konsoliin tulostetaan tarkempi tieto virheestä.</p>

<p>Tapauksessamme on itseasiassa olemassa kaksi erityyppistä virhetilannetta. Toinen vastaa sitä, että yritetään hakea muistiinpanoa virheellisen muotoisella <em>id</em>:llä, eli sellasiella mikä ei vastaa mongon id:iden muotoa.</p>

<p>Jos teemme näin tulostuu konsoliin:</p>

<pre>
Method: GET
Path:   /api/notes/5a3b7c3c31d61cb9f8a0343
Body:   {}
---
{ CastError: Cast to ObjectId failed for value "5a3b7c3c31d61cb9f8a0343" at path "_id"
    at CastError (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/error/cast.js:27:11)
    at ObjectId.cast (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/schema/objectid.js:158:13)
    ...
</pre>

<p>Toinen virhetilanne taas vastaa tilannetta, missä haettavan muistiinpanon id on periaatteessa oikeassa formaatissa, mutta tietokannasta ei löydy indeksillä mitään:</p>

<pre>
Method: GET
Path:   /api/notes/5a3b7c3c31d61cbd9f8a0343
Body:   {}
---
TypeError: Cannot read property '_doc' of null
    at formatNote (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/index.js:46:33)
    at Note.findById.then.note (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/index.js:65:21)
</pre>

<p>Nämä tilanteen on syytä erottaa toisistaan, ja itseasiassa jälkimmäinen poikkeus on oman koodimme <code>/Users/mluukkai/opetus/\_fullstack/osa3-muisiinpanot/index.js:46</code> aiheuttama.</p>

<p>Muutetaan koodia seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/api/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">note</span><span class="p">))</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Jos kannasta ei löydy haettua olioa, muuttujan <em>note</em> arvo on <em>undefined</em> ja koodi ajautuu <em>else</em>-haaraan. Siellä vastataan kyselyyn <em>404 not found</em>.</p>

<p>Jos id ei ole hyväksyttävässä muodossa, ajaudutaan <em>catch</em>:in avulla määriteltyyn virheidenkäsittelijään. Sopiva statuskoodi on <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 bad request</a> koska kyse on juuri siitä:</p>

<blockquote>
  <p>The request could not be understood by the server due to malformed syntax. The client SHOULD NOT repeat the request without modifications.</p>
</blockquote>

<p>Vastaukseen on lisätty myös hieman dataa kertomaan virheen syystä.</p>

<p>Promisejen yhteydessä kannattaa melkeinpä aina lisätä koodiin myös virhetilainteiden käsittely, muuten seurauksena on usein hämmentäviä vikoja.</p>

<p>Ei ole koskaan huono idea tulostaa poikkeuksen aiheuttanutta olioa konsoliin virheenkäsittelijässä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Virheenkäsittelijään joutumisen syy voi olla joku ihan muu kuin mitä on tullut alunperin ajatelleeksi. Jos virheen tulostaa konsoliin, voi säästyä pitkiltä ja turhauttavilta väärää asiaa debuggaavilta sessioita.</p>

<p>Aina kun ohjelmoit ja projektissa on mukana backend <strong>tulee ehdottomasti koko ajan pitää silmällä backendin konsolin tulostuksia</strong>. Jos työskentelet pienellä näytöllä, riittää että konsolista on näkyvissä edes pieni kaistale:</p>

<p><img src="http://localhost:4000/images/3/15b.png" alt="" /></p>

<h3 id="loput-operaatiot">loput operaatiot</h3>

<p>Toteutetaan vielä jäljellä olevat operaatiot, eli yksittäisen muistiinpanon poisto ja muokkaus.</p>

<p>Poisto onnistuu helpoiten metodilla <a href="http://mongoosejs.com/docs/api.html#findbyidandremove_findByIdAndRemove">findByIdAndRemove</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/api/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findByIdAndRemove</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">204</span><span class="p">).</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Vastauksena on statauskoodi <em>204 no content</em> molemmissa “onnistuneissa” tapauksissa, eli jos olio poistettiin tai olioa ei ollut mutta <em>id</em> oli periaatteessa oikea. Takaisinkutsun parametrin <em>result</em> perusteella olisi mahdollisuus haarautua ja palauttaa tilanteissa eri statuskoodi jos sille on tarvetta.</p>

<p>Muistiinpanon tärkeyden muuttamisen mahdollistava olemassaolevan muistiinpanon päivitys onnistuu helposti metodilla <a href="http://mongoosejs.com/docs/api.html#findoneandupdate_findOneAndUpdate">findOneAndUpdate</a>. Tässä ja myöhemmin sivulla on <em>findOneAndUpdate</em>, mutta koodissa alla <a href="http://mongoosejs.com/docs/api.html#findbyidandupdate_findByIdAndUpdate">findByIdAndUpdate</a>, joka vastaa <code class="highlighter-rouge">findOneAndUpdate({ _id: id }, ...)</code> kutsua.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/api/notes/:id'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>

  <span class="kd">const</span> <span class="nx">note</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">important</span>
  <span class="p">}</span>

  <span class="nx">Note</span>
    <span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">note</span><span class="p">,</span> <span class="p">{</span> <span class="na">new</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">updatedNote</span><span class="p">))</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="s1">'malformatted id'</span> <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Operaatio mahdollistaa myös muistiinpanon sisällön editoinnin. Päivämäärän muuttaminen ei ole mahdollista.</p>

<p>Huomaa, että metodin <em>findOneAndUpdate</em> parametrina tulee antaa normaali Javascript-olio, eikä uuden olion luomisessa käytettävä <em>Note</em>-konstruktorifunktiolla luotu olio.</p>

<p>Pieni, mutta tärkeä detalji liittyen operaatioon <em>findOneAndUpdate</em>. Oletusarvoisesti tapahtumankäsittelijä saa parametrikseen <em>updatedNote</em> päivitetyn olion <a href="http://mongoosejs.com/docs/api.html#findoneandupdate_findOneAndUpdate">ennen muutosta</a> olleen tilan. Lisäsimme operaatioon parametrin <code>{ new: true }</code> jotta saamme muuttuneen olion palautetuksi kutsujalle.</p>

<p>Backend vaikuttaa toimivan postmanista VS Code REST clientistä tehtyjen kokeilujen perusteella ja myös frontend toimii moitteettomasti tietokantaa käyttävän backendin kanssa.</p>

<h3 id="tehtäviä-5">Tehtäviä</h3>

<p>Tee nyt tehtävät <a href="/tehtävät#lisää-operaatioita">3.16-3.18</a></p>

<h2 id="refaktorointia---promisejen-ketjutus">Refaktorointia - promisejen ketjutus</h2>

<p>Useat routejen tapahtumankäsittelijöistä muuttivat palautettavan datan oikeaan formaattiin kutsumalla metodia <em>formatNote</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">note</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="nx">note</span><span class="p">.</span><span class="nx">important</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>esim uuden muistiinpanon luomisessa metodia kutsutaan <em>then</em>:in parametrina palauttama olio parametrina:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">note</span>
    <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">savedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">))</span>
    <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>Voisimme tehdä saman myös hieman tyylikkäämmin <a href="https://javascript.info/promise-chaining">promiseja ketjuttamalla</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">note</span>
    <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">savedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">formatNote</span><span class="p">(</span><span class="nx">savedNote</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">savedAndFormattedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">savedAndFormattedNote</span><span class="p">)</span>
    <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>Eli ensimmäisen <em>then</em>:in takaisinkutsussa otamme mongoosen palauttaman olion <em>savedNote</em> ja formatoimme sen. Operaation tulos palautetaan returnilla. Kuten osassa 2 <a href="/osa2/#palvelimen-kanssa-tapahtuvan-kommunikoinnin-eristäminen-omaan-moduuliin">todettiin</a>, promisen then-metodi palauttaa myös promisen. Eli kun palautamme <em>formatNote(savedNote)</em>:n takaisinkutsufunktiosta, syntyy promise, jonka arvona on formatoitu muistiinpano. Pääsemme käsiksi arvoon rekisteröimällä <em>then</em>-kutsulla uuden tapahtumankäsittelijän.</p>

<p>Itseasiassa selviämme vieläkin tiiviimmällä koodilla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">note</span>
    <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">formatNote</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">savedAndFormattedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">savedAndFormattedNote</span><span class="p">)</span>
    <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>koska <em>formatNote</em> on viite funktioon, on oleellisesti ottaen kyse samasta kuin kirjoittaisimme:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/notes'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">note</span>
    <span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">savedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="nx">savedNote</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
        <span class="na">content</span><span class="p">:</span> <span class="nx">savedNote</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
        <span class="na">date</span><span class="p">:</span> <span class="nx">savedNote</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="nx">savedNote</span><span class="p">.</span><span class="nx">important</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">savedAndFormattedNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">savedAndFormattedNote</span><span class="p">)</span>
    <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<h2 id="sovelluksen-vieminen-tuotantoon">Sovelluksen vieminen tuotantoon</h2>

<p>Sovelluksen pitäisi toimia tuotannossa, eli herokussa sellaisenaan. Frontendin muutosten takia on tehtävä siitä uusi tuotantoversio ja kopioitava se backendiin.</p>

<p>Sovellusta voi käyttää sekä frontendin kautta <a href="https://fullstack-notes.herokuapp.com">https://fullstack-notes.herokuapp.com</a>, ja myös API:n <a href="https://fullstack-notes.herokuapp.com/api/notes">https://fullstack-notes.herokuapp.com/api/notes</a> suora käyttö selaimella ja postmanilla onnistuu.</p>

<p>Sovelluksessamme on tällä hetkellä eräs ikävä piirre. Tietokannan osoite on kovakoodattu backendiin ja samaa tietokantaa käytetään sekä tuotannossa, että sovellusta kehitettäessä.</p>

<p>Tarvitsemme oman kannan sovelluskehitystä varten. Luodaan mlabiin toinen tietokanta ja sille käyttäjä.</p>

<p>Tietokannan osoitetta ei kannata kirjoittaa koodiin. Eräs hyvä tapa tietokannan osoitteen määrittelemiseen on <a href="https://en.wikipedia.org/wiki/Environment_variable">ympäristömuuttujien</a> käyttö.</p>

<p>Talletetaan kannan osoite ympäristömuuttujaan <em>MONGODB_URI</em>.</p>

<p>Ympäristömuuttujiin pääsee Node-sovelluksesta käsiksi seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_URI</span>

<span class="c1">// ...</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Note</span>
</code></pre></div></div>

<p>Tee muutos koodiin ja deployaa uusi versio herokuun. Sovelluksen pitäisi toimia kun asetat ympäristömuuttujan arvo herokuun komennolla <em>heroku config:set</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>heroku config:set <span class="nv">MONGODB_URI</span><span class="o">=</span>mongodb://fullstack:sekred@ds211088.mlab.com:11088/fullstack-notes
</code></pre></div></div>

<p>Sovelluksen pitäisi toimia muutosten jälkeen. Aina kaikki ei kuitenkaan mene suunnitelmien mukaan. Jos ongelmia ilmenee, <em>heroku logs</em> auttaa. Oma sovellukseni ei toiminut muutoksen jälkeen. Loki kertoi seuraavaa</p>

<p><img src="http://localhost:4000/images/3/21.png" alt="" /></p>

<p>eli tietokannan osoite olikin jostain syystä määrittelemätön. Komento <em>heroku config</em> paljasti että olin vahingossa määritellyt ympäristömuuttujan <em>MONGO_URL</em> kun koodi oletti sen olevan nimeltään <em>MONGODB_URI</em>.</p>

<p>Muutoksen jälkeen sovellus ei toimi paikallisesti, koska ympäristömuuttujalla <em>MONGODB_URI</em> ei ole mitään arvoa. Tapoja määritellä ympäristömuuttujalle arvo on monia, käytetään nyt <a href="https://www.npmjs.com/package/dotenv">dotenv</a>-kirjastoa.</p>

<p>Asennetaan kirjasto komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install dotenv <span class="nt">--save</span>
</code></pre></div></div>

<p>Sovelluksen juurihakemistoon tehdään sitten tiedosto nimeltään <em>.env</em>, minne tarvittavien ympäristömuuttujien arvot asetetaan. Määritellään tiedostoon sovelluskehitystä varten luodun tietokannan osoite:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">MONGODB_URI</span><span class="o">=</span>mongodb://fullstack:sekred@ds111078.mlab.com:11078/fullstact-notes-dev
</code></pre></div></div>

<p>Tiedosto .env <strong>tulee heti gitignorata</strong> sillä emme halua julkaista .env -tiedoston sisältöä verkkoon.</p>

<p>dotenvissä määritellyt ympäristömuuttujat otetaan koodissa käyttöön komennolla</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">require</span><span class="p">(</span><span class="s1">'dotenv'</span><span class="p">).</span><span class="nx">config</span><span class="p">()</span>
</code></pre></div></div>

<p>ja niihin viitataan Nodessa kuten “normaaleihin” ympäristömuuttujiin syntaksilla <em>process.env.MONGODB_URI</em></p>

<p>Otetaan dotenv käyttöön seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'dotenv'</span><span class="p">).</span><span class="nx">config</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGODB_URI</span>

<span class="c1">// ...</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Note</span>
</code></pre></div></div>

<p>Nyt dotenvissä olevat ympäristömuuttujat otetaan käyttöön ainoastaan silloin kun sovellus ei ole <em>production</em>- eli tuotantomoodssa (kuten esim. Herokussa).</p>

<p>Uudelleenkäynnistyksen jälkeen sovellus toimii taas paikallisesti.</p>

<p>Node-sovellusten konfigurointiin on olemassa ympäristömuuttujien ja dotenvin lisäksi lukuisia vaihtoehtoja, mm. <a href="https://github.com/lorenwest/node-config">node-conf</a>. Ympäristömuuttujien käyttö riittää meille nyt, joten emme rupea overengineeraamaan. Palaamme aiheeseen kenties myöhemmin.</p>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part3-4">githubissa</a>, tagissa <em>part3-4</em>.</p>

<h3 id="tehtäviä-6">Tehtäviä</h3>

<p>Tee nyt tehtävät <a href="/tehtävät#loppuhuipennus">3.19 - 3.21</a></p>

<h2 id="lint">Lint</h2>

<p>Ennen osan lopetusta katsomme vielä nopeasti paitsioon jäänyttä tärkeää työkalua <a href="https://en.wikipedia.org/wiki/Lint_(software)">lintiä</a>. Wikipedian sanoin:</p>

<blockquote>
  <p>Generically, lint or a linter is any tool that detects and flags errors in programming languages, including stylistic errors. The term lint-like behavior is sometimes applied to the process of flagging suspicious language usage. Lint-like tools generally perform static analysis of source code.</p>
</blockquote>

<p>Staattisesti tyypitetyissä, käännettävissä kielissä esim. Javassa ohjelmointiympäristöt, kuten NetBeans osaavat huomautella monista koodiin liittyvistä asioista, sellaisistakin, jotka eivät ole välttämättä käännösvirheitä. Erilaisten <a href="https://en.wikipedia.org/wiki/Static_program_analysis">staattisen analyysin</a> lisätyökalujen, kuten <a href="http://checkstyle.sourceforge.net/">checkstylen</a> avulla voidaan vielä laajentaa Javassa huomautettavien asioiden määrää koskemaan koodin tyylillisiä seikkoja, esim. sisentämistä.</p>

<p>Javascript-maailmassa tämän hetken johtava työkalu staattiseen analyysiin, eli “linttaukseen” on <a href="https://eslint.org/">ESlint</a>.</p>

<p>Asennetaan ESlint backendiin kehitysaikaiseksi riippuvuudeksi komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install eslint <span class="nt">--save-dev</span>
</code></pre></div></div>

<p>Tämän jälkeen voidaan muodostaa alustava ESlint-konfiguraatio komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node_modules/.bin/eslint <span class="nt">--init</span>
</code></pre></div></div>

<p>Vastaillaan kysymyksiin:</p>

<p><img src="http://localhost:4000/images/3/24.png" alt="" /></p>

<p>Konfiguraatiot tallentuvat tiedostoon <em>.eslintrc.js</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"env"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"node"</span><span class="p">:</span> <span class="kc">true</span>
        <span class="s2">"es6"</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="s2">"extends"</span><span class="p">:</span> <span class="s2">"eslint:recommended"</span><span class="p">,</span>
    <span class="s2">"rules"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"indent"</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">"error"</span><span class="p">,</span>
            <span class="mi">4</span>
        <span class="p">],</span>
        <span class="s2">"linebreak-style"</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">"error"</span><span class="p">,</span>
            <span class="s2">"unix"</span>
        <span class="p">],</span>
        <span class="s2">"quotes"</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">"error"</span><span class="p">,</span>
            <span class="s2">"single"</span>
        <span class="p">],</span>
        <span class="s2">"semi"</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">"error"</span><span class="p">,</span>
            <span class="s2">"never"</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Muutetaan heti konfiguraatioista sisennystä määrittelevä sääntö, siten että sisennystaso on 2 välilyöntiä</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"indent": [
    "error",
    2
],
</code></pre></div></div>

<p>Esim tiedoston <em>index.js</em> tarkastus tapahtuu komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node_modules/.bin/eslint index.js
</code></pre></div></div>

<p>Kannattaa ehkä tehdä linttaustakin varten <em>npm-skripti</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  // ...
  <span class="s2">"scripts"</span>: <span class="o">{</span>
    <span class="s2">"start"</span>: <span class="s2">"node index.js"</span>,
    <span class="s2">"watch"</span>: <span class="s2">"nodemon index.js"</span>,
    <span class="s2">"lint"</span>: <span class="s2">"eslint ."</span>
  <span class="o">}</span>,
  // ...
<span class="o">}</span>
</code></pre></div></div>

<p>Nyt komennot <em>npm run lint</em> suorittaa tarkastukset koko projektille.</p>

<p>Myös hakemistossa <em>build</em> oleva frontendin tuotantoversio tulee näin tarkastettua. Sitä emme kuitenkaan halua, eli tehdään projektin juureen tiedosto <a href="https://eslint.org/docs/user-guide/configuring#ignoring-files-and-directories">.eslintignore</a> ja sille seuraava sisältö</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build
</code></pre></div></div>

<p>Näin koko hakemiston <em>build</em> sisältö jätetään huomioimatta linttauksessa.</p>

<p>Lintillä on jonkin verran huomautettavaa koodistamme:</p>

<p><img src="http://localhost:4000/images/3/22.png" alt="" /></p>

<p>Ei kuitenkaan korjata ongelmia vielä.</p>

<p>Parempi vaihtoehto kuin linttauksen suorittaminen komentoriviltä on konfiguroida editorille <em>lint-plugin</em>, joka suorittaa linttausta koko ajan. Näin pääset korjaamaan pienet virheet välittömästi. Tietoja esim. Visual Studion ESlint-pluginsta <a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint">täällä</a>.</p>

<p>VS Coden ESlint-plugin alleviivaa tyylisääntöjä rikkovat kohdat punaisella:</p>

<p><img src="http://localhost:4000/images/3/23.png" alt="" /></p>

<p>Näin ongelmat on helppo korjata koodiin heti.</p>

<p>ESlintille on määritelty suuri määrä <a href="https://eslint.org/docs/rules/">sääntöjä</a>, joita on helppo ottaa käyttöön muokkaamalla tiedostoa <em>.eslintrc.js</em>.</p>

<p>Otetaan käyttöön sääntö <a href="https://eslint.org/docs/rules/eqeqeq">eqeqeq</a> joka varoittaa, jos koodissa yhtäsuuruutta verrataan muuten kuin käyttämällä kolmea = -merkkiä. Sääntö lisätään konfiguraatiotiedostoon kentän <em>rules</em> alle.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"rules"</span>: <span class="o">{</span>
  // ...
  <span class="s2">"eqeqeq"</span>: <span class="s2">"error"</span>
<span class="o">}</span>,
</code></pre></div></div>

<p>Tehdään samalla muutama muukin muutos tarkastettaviin sääntöihin.</p>

<p>Estetään rivien lopussa olevat <a href="https://eslint.org/docs/rules/no-trailing-spaces">turhat välilyönnit</a>, vaaditaan että <a href="https://eslint.org/docs/rules/object-curly-spacing">aaltosulkeiden edessä/jälkeen on aina välilyönti</a> ja vaaditaan myös konsistenttia välilyöntien käyttöä <a href="https://eslint.org/docs/rules/arrow-spacing">nuolifunktioiden parametrien suhteen</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"rules"</span>: <span class="o">{</span>
  // ...
  <span class="s2">"eqeqeq"</span>: <span class="s2">"error"</span>,
  <span class="s2">"no-trailing-spaces"</span>: <span class="s2">"error"</span>,
  <span class="s2">"object-curly-spacing"</span>: <span class="o">[</span>
      <span class="s2">"error"</span>, <span class="s2">"always"</span>
  <span class="o">]</span>,
  <span class="s2">"arrow-spacing"</span>: <span class="o">[</span>
      <span class="s2">"error"</span>, <span class="o">{</span> <span class="s2">"before"</span>: <span class="nb">true</span>, <span class="s2">"after"</span>: <span class="nb">true</span> <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>,
</code></pre></div></div>

<p>Oletusarvoinen konfiguraatiomme ottaa käyttöön joukon valmiiksi määriteltyjä sääntöjä <em>eslint:recommended</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"extends"</span>: <span class="s2">"eslint:recommended"</span>,
</code></pre></div></div>

<p>Mukana on myös <em>console.log</em>-komennoista varoittava sääntö-
Yksittäisen sääntö on helppo kytkeä <a href="https://eslint.org/docs/user-guide/configuring#configuring-rules">pois päältä</a> määrittelemällä sen “arvoksi” konfiguraatiossa 0. Tehdään toistaiseksi näin säännölle <em>no-console</em>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"rules"</span>: <span class="o">{</span>
  // ...
  <span class="s2">"eqeqeq"</span>: <span class="s2">"error"</span>,
  <span class="s2">"no-trailing-spaces"</span>: <span class="s2">"error"</span>,
  <span class="s2">"object-curly-spacing"</span>: <span class="o">[</span>
      <span class="s2">"error"</span>, <span class="s2">"always"</span>
  <span class="o">]</span>,
  <span class="s2">"arrow-spacing"</span>: <span class="o">[</span>
      <span class="s2">"error"</span>, <span class="o">{</span> <span class="s2">"before"</span>: <span class="nb">true</span>, <span class="s2">"after"</span>: <span class="nb">true</span> <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"no-console"</span>: 0
<span class="o">}</span>,
</code></pre></div></div>

<p><strong>HUOM</strong> kun teet muutoksia tiedostoon <em>.eslintrc.js</em>, kannattaa muutosten jälkeen suorittaa linttaus komentoriviltä ja varmistaa että konfiguraatio ei ole viallinen:</p>

<p><img src="http://localhost:4000/images/3/25.png" alt="" /></p>

<p>Jos konfiguraatiossa on jotain vikaa, voi editorin lint-plugin näyttää mitä sattuu.</p>

<p>Monissa yrityksissä on tapana määritellä yrityksen laajuiset koodausstandardit ja näiden käyttöä valvova ESlint-konfiguraatio. Pyörää ei kannata välttämättä keksiä uudelleen ja voi olla hyvä idea ottaa omaan projektiin joku käyttöön jossain muualla hyväksi havaittu konfiguraatio. Viime aikoina monissa projekteissa on omaksuttu AirBnB:n <a href="https://github.com/airbnb/javascript">Javascript</a>-tyyliohjeet ottamalla käyttöön firman määrittelemä <a href="https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb">ESLint</a>-konfiguraatio.</p>

<p>Sovelluksen tämän hetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part3-5">githubissa</a>, tagissa <em>part3-5</em>.</p>

<h3 id="tehtäviä-7">Tehtäviä</h3>

<p>Tee nyt viimeinen tehtävä <a href="/tehtävät#lint">3.22</a></p>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
             Full stack open 
          </li>
          <li>
            <a href="mailto:mluukkai@cs.helsinki.fi">mluukkai@cs.helsinki.fi</a>
          </li>
          <li>
            <a href="https://github.com/mluukkai"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mluukkai</span></a>

          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
           
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>
          <a href="https://courses.helsinki.fi/fi/TKT21009/121540749">https://courses.helsinki.fi/fi/TKT21009/121540749</a>
        </p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
